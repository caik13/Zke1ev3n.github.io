<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="chrome=1">

    

    <title>
      Android 启动过程解析 | Zke1ev3n&#39;s Blog 
    </title>

    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no">
    
      <meta name="author" content="Zke1ev3n">
    
    

    <meta name="description" content="当Android设备的电源键被按下时，主要执行了以下步骤：

Boot ROM加电后,设备从固化在CPU ASIC中的Boot ROM代码开始执行。这段代码主要用于初始化软件堆栈，通信端口和可引导存储设备(比如NAND/EMMC)。然后BootROM会从存储器中加载bootloader的一部分到处理器ISRAM中(这时候还没有初始化DRAM)，然后跳转到bootloader的入口处执行。">
<meta property="og:type" content="article">
<meta property="og:title" content="Android 启动过程解析 | Zke1ev3n's Blog">
<meta property="og:url" content="http://yoursite.com/2015/12/02/Android-启动过程解析/index.html">
<meta property="og:site_name" content="Zke1ev3n's Blog">
<meta property="og:description" content="当Android设备的电源键被按下时，主要执行了以下步骤：

Boot ROM加电后,设备从固化在CPU ASIC中的Boot ROM代码开始执行。这段代码主要用于初始化软件堆栈，通信端口和可引导存储设备(比如NAND/EMMC)。然后BootROM会从存储器中加载bootloader的一部分到处理器ISRAM中(这时候还没有初始化DRAM)，然后跳转到bootloader的入口处执行。">
<meta property="og:image" content="http://yoursite.com/1.png">
<meta property="og:updated_time" content="2015-12-02T04:28:15.512Z">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="Android 启动过程解析 | Zke1ev3n's Blog">
<meta name="twitter:description" content="当Android设备的电源键被按下时，主要执行了以下步骤：

Boot ROM加电后,设备从固化在CPU ASIC中的Boot ROM代码开始执行。这段代码主要用于初始化软件堆栈，通信端口和可引导存储设备(比如NAND/EMMC)。然后BootROM会从存储器中加载bootloader的一部分到处理器ISRAM中(这时候还没有初始化DRAM)，然后跳转到bootloader的入口处执行。">
<meta name="twitter:image" content="http://yoursite.com/1.png">
    
    
    
      <link rel="icon" type="image/x-icon" href="/favicon.png">
    
    <link rel="stylesheet" href="/css/uno.css">
    <link rel="stylesheet" href="/css/highlight.css">
    <link rel="stylesheet" href="/css/archive.css">

</head>
<body>

    <span class="mobile btn-mobile-menu">
        <i class="icon icon-list btn-mobile-menu__icon"></i>
        <i class="icon icon-x-circle btn-mobile-close__icon hidden"></i>
    </span>

    

<header class="panel-cover panel-cover--collapsed">


  <div class="panel-main">

    <div class="panel-main__inner panel-inverted">
    <div class="panel-main__content">

        

        <h1 class="panel-cover__title panel-title"><a href="/" title="link to homepage">Zke1ev3n&#39;s Blog</a></h1>
        <hr class="panel-cover__divider" />

        
        <p class="panel-cover__description">
          The quieter you became,the more you are able to hear.
        </p>
        <hr class="panel-cover__divider panel-cover__divider--secondary" />
        

        <div class="navigation-wrapper">

          <nav class="cover-navigation cover-navigation--primary">
            <ul class="navigation">

              
                
                <li class="navigation__item"><a href="/#blog" title="" class="blog-button">首页</a></li>
              
                
                <li class="navigation__item"><a href="/about" title="" class="">关于</a></li>
              
                
                <li class="navigation__item"><a href="/archive" title="" class="">归档</a></li>
              

            </ul>
          </nav>

          <!-- ----------------------------
To add a new social icon simply duplicate one of the list items from below
and change the class in the <i> tag to match the desired social network
and then add your link to the <a>. Here is a full list of social network
classes that you can use:

    icon-social-500px
    icon-social-behance
    icon-social-delicious
    icon-social-designer-news
    icon-social-deviant-art
    icon-social-digg
    icon-social-dribbble
    icon-social-facebook
    icon-social-flickr
    icon-social-forrst
    icon-social-foursquare
    icon-social-github
    icon-social-google-plus
    icon-social-hi5
    icon-social-instagram
    icon-social-lastfm
    icon-social-linkedin
    icon-social-medium
    icon-social-myspace
    icon-social-path
    icon-social-pinterest
    icon-social-rdio
    icon-social-reddit
    icon-social-skype
    icon-social-spotify
    icon-social-stack-overflow
    icon-social-steam
    icon-social-stumbleupon
    icon-social-treehouse
    icon-social-tumblr
    icon-social-twitter
    icon-social-vimeo
    icon-social-xbox
    icon-social-yelp
    icon-social-youtube
    icon-social-zerply
    icon-mail

-------------------------------->

<!-- add social info here -->



        </div>

      </div>

    </div>

    <div class="panel-cover--overlay"></div>
  </div>
</header>

    <div class="content-wrapper">
        <div class="content-wrapper__inner entry">
            

<article class="post-container post-container--single">

  <header class="post-header">
    
    <h1 class="post-title">Android 启动过程解析</h1>

    

    <div class="post-meta">
      <time datetime="2015-12-02" class="post-meta__date date">2015-12-02</time> 

      <span class="post-meta__tags tags">

          

          

      </span>
    </div>
    
    

  </header>

  <section id="post-content" class="article-content post">
    <p>当Android设备的电源键被按下时，主要执行了以下步骤：</p>
<p><img src="1.png" alt=""></p>
<h3 id="Boot-ROM"><a href="#Boot-ROM" class="headerlink" title="Boot ROM"></a>Boot ROM</h3><p>加电后,设备从固化在CPU ASIC中的Boot ROM代码开始执行。这段代码主要用于初始化软件堆栈，通信端口和可引导存储设备(比如NAND/EMMC)。然后BootROM会从存储器中加载bootloader的一部分到处理器ISRAM中(这时候还没有初始化DRAM)，然后跳转到bootloader的入口处执行。</p>
<a id="more"></a>
<h3 id="BootLoader"><a href="#BootLoader" class="headerlink" title="BootLoader"></a>BootLoader</h3><p>第一部分的bootloader会初始化DRAM，并将bootloader的第二部分(主要部分)加载到DRAM,然后跳转到第二部分的bootloader执行。第二部分的boot loader的主要功能包括：建立文件系统， 额外的内存管理、网络支持和其他功能。在移动设备或手机上，也负责加载modem CPU的代码并且设置内存保护和一些安全选项。bootloader是针对特定主板和芯片的，所以一般的设备制造厂商会开发自己的bootloader，也可以使用开源的bootloader如reboot，uboot。厂商一般会在bootloader中加入一些限制性的代码，也就是加锁，在刷系统或recovery时，bootloader会校验文件的签名，如果和官方的不一致就无法写入。</p>
<p>U-boot的启动由u-boot/arch/arm/cpu/xxx/u-boot.lds开始，其引导调用u-boot/arch/arm/cpu/xxx/start.S。</p>
<p>u-boot.lds：<br><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br></pre></td><td class="code"><pre><span class="line">OUTPUT_FORMAT(<span class="string">"elf32-littlearm"</span>, <span class="string">"elf32-littlearm"</span>, <span class="string">"elf32-littlearm"</span>)</span><br><span class="line">OUTPUT_ARCH(arm)</span><br><span class="line">ENTRY(_start)</span><br><span class="line">SECTIONS</span><br><span class="line">&#123;</span><br><span class="line">    . = <span class="number">0x00000000</span>;</span><br><span class="line"></span><br><span class="line">    . = ALIGN(<span class="number">4</span>);</span><br><span class="line">    .text :</span><br><span class="line">    &#123;</span><br><span class="line">        arch/arm/cpu/arm920t/start.o	(.text)<span class="comment">//调用对应的start.S,start.o由start.S编译生成</span></span><br><span class="line">        *(.text)</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    . = ALIGN(<span class="number">4</span>);</span><br><span class="line">    .rodata : &#123; *(SORT_BY_ALIGNMENT(SORT_BY_NAME(.rodata*))) &#125;</span><br><span class="line"></span><br><span class="line">    . = ALIGN(<span class="number">4</span>);</span><br><span class="line">    .data : &#123;</span><br><span class="line">        *(.data)</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    . = ALIGN(<span class="number">4</span>);</span><br><span class="line"></span><br><span class="line">    . = .;</span><br><span class="line">    __u_boot_cmd_start = .;</span><br><span class="line">    .u_boot_cmd : &#123; *(.u_boot_cmd) &#125;</span><br><span class="line">    __u_boot_cmd_end = .;</span><br><span class="line"></span><br><span class="line">    . = ALIGN(<span class="number">4</span>);</span><br><span class="line"></span><br><span class="line">    .rel.dyn : &#123;</span><br><span class="line">        __rel_dyn_start = .;</span><br><span class="line">        *(.rel*)</span><br><span class="line">        __rel_dyn_end = .;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    .dynsym : &#123;</span><br><span class="line">        __dynsym_start = .;</span><br><span class="line">        *(.dynsym)</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    .bss __rel_dyn_start (OVERLAY) : &#123;</span><br><span class="line">        __bss_start = .;</span><br><span class="line">        *(.bss)</span><br><span class="line">         . = ALIGN(<span class="number">4</span>);</span><br><span class="line">        _end = .;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    /DISCARD/ : &#123; *(.dynstr*) &#125;</span><br><span class="line">    /DISCARD/ : &#123; *(.dynamic*) &#125;</span><br><span class="line">    /DISCARD/ : &#123; *(.plt*) &#125;</span><br><span class="line">    /DISCARD/ : &#123; *(.interp*) &#125;</span><br><span class="line">    /DISCARD/ : &#123; *(.gnu*) &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>U-boot的第一条指令从u-boot/arch/arm/cpu/xxx/start.S文件开始:<br><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;asm-offsets.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;common.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;config.h&gt;</span></span></span><br><span class="line"></span><br><span class="line">.globl _start</span><br><span class="line">_start:	b	start_code</span><br><span class="line">    ldr	pc, _undefined_instruction</span><br><span class="line">    ldr	pc, _software_interrupt</span><br><span class="line">    ldr	pc, _prefetch_abort</span><br><span class="line">    ldr	pc, _data_abort</span><br><span class="line">    ldr	pc, _not_used</span><br><span class="line">    ldr	pc, _irq</span><br><span class="line">    ldr	pc, _fiq</span><br><span class="line"></span><br><span class="line">......</span><br><span class="line"></span><br><span class="line"><span class="comment">//开始的一些初始化操作</span></span><br><span class="line">start_code:</span><br><span class="line">    <span class="comment">/*</span><br><span class="line">     * set the cpu to SVC32 mode</span><br><span class="line">     */</span></span><br><span class="line">    mrs	r0, cpsr</span><br><span class="line">    bic	r0, r0, #<span class="number">0x1f</span></span><br><span class="line">    orr	r0, r0, #<span class="number">0xd3</span></span><br><span class="line">    msr	cpsr, r0</span><br><span class="line"></span><br><span class="line">    bl	coloured_LED_init</span><br><span class="line">    bl	red_LED_on</span><br><span class="line"></span><br><span class="line">......</span><br><span class="line"></span><br><span class="line">    <span class="comment">/*</span><br><span class="line">     * we do sys-critical inits only at reboot,</span><br><span class="line">     * not when booting from ram!</span><br><span class="line">     */</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">ifndef</span> CONFIG_SKIP_LOWLEVEL_INIT</span></span><br><span class="line">    bl	cpu_init_crit <span class="comment">//重点函数</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line"></span><br><span class="line"><span class="comment">/* Set stackpointer in internal RAM to call board_init_f */</span></span><br><span class="line"><span class="comment">/*board.c的board_init_f()函数*/</span></span><br><span class="line">call_board_init_f:</span><br><span class="line">    ldr	sp, =(CONFIG_SYS_INIT_SP_ADDR)</span><br><span class="line">    bic	sp, sp, #<span class="number">7</span> <span class="comment">/* 8-byte alignment for ABI compliance */</span></span><br><span class="line">    ldr	r0,=<span class="number">0x00000000</span></span><br><span class="line">    bl	board_init_f<span class="comment">//board初始化</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    .globl	relocate_code</span><br><span class="line">relocate_code:</span><br><span class="line">    mov	r4, r0	<span class="comment">/* save addr_sp */</span></span><br><span class="line">    mov	r5, r1	<span class="comment">/* save addr of gd */</span></span><br><span class="line">    mov	r6, r2	<span class="comment">/* save addr of destination */</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">/* Set up the stack						    */</span></span><br><span class="line">stack_setup:</span><br><span class="line">    mov	sp, r4</span><br><span class="line"></span><br><span class="line">    adr	r0, _start</span><br><span class="line">    cmp	r0, r6</span><br><span class="line">    beq	clear_bss		<span class="comment">/* skip relocation */</span></span><br><span class="line">    mov	r1, r6			<span class="comment">/* r1 &lt;- scratch for copy_loop */</span></span><br><span class="line">    ldr	r2, _TEXT_BASE</span><br><span class="line">    ldr	r3, _bss_start_ofs</span><br><span class="line">    add	r2, r0, r3		<span class="comment">/* r2 &lt;- source end address	    */</span></span><br><span class="line"></span><br><span class="line">copy_loop:</span><br><span class="line">    ldmia	r0!, &#123;r9-r10&#125;		<span class="comment">/* copy from source address [r0]    */</span></span><br><span class="line">    stmia	r1!, &#123;r9-r10&#125;		<span class="comment">/* copy to   target address [r1]    */</span></span><br><span class="line">    cmp	r0, r2			<span class="comment">/* until source end address [r2]    */</span></span><br><span class="line">    blo	copy_loop</span><br><span class="line"></span><br><span class="line">#ifndef CONFIG_PRELOADER</span><br><span class="line">    <span class="comment">/*</span><br><span class="line">     * fix .rel.dyn relocations</span><br><span class="line">     */</span></span><br><span class="line">    ldr	r0, _TEXT_BASE		<span class="comment">/* r0 &lt;- Text base */</span></span><br><span class="line">    sub	r9, r6, r0		<span class="comment">/* r9 &lt;- relocation offset */</span></span><br><span class="line">    ldr	r10, _dynsym_start_ofs	<span class="comment">/* r10 &lt;- sym table ofs */</span></span><br><span class="line">    add	r10, r10, r0		<span class="comment">/* r10 &lt;- sym table in FLASH */</span></span><br><span class="line">    ldr	r2, _rel_dyn_start_ofs	<span class="comment">/* r2 &lt;- rel dyn start ofs */</span></span><br><span class="line">    add	r2, r2, r0		<span class="comment">/* r2 &lt;- rel dyn start in FLASH */</span></span><br><span class="line">    ldr	r3, _rel_dyn_end_ofs	<span class="comment">/* r3 &lt;- rel dyn end ofs */</span></span><br><span class="line">    add	r3, r3, r0		<span class="comment">/* r3 &lt;- rel dyn end in FLASH */</span></span><br><span class="line">fixloop:</span><br><span class="line">    ldr	r0, [r2]		<span class="comment">/* r0 &lt;- location to fix up, IN FLASH! */</span></span><br><span class="line">    add	r0, r0, r9		<span class="comment">/* r0 &lt;- location to fix up in RAM */</span></span><br><span class="line">    ldr	r1, [r2, #<span class="number">4</span>]</span><br><span class="line">    and	r7, r1, #<span class="number">0xff</span></span><br><span class="line">    cmp	r7, #<span class="number">23</span>			<span class="comment">/* relative fixup? */</span></span><br><span class="line">    beq	fixrel</span><br><span class="line">    cmp	r7, #<span class="number">2</span>			<span class="comment">/* absolute fixup? */</span></span><br><span class="line">    beq	fixabs</span><br><span class="line">    <span class="comment">/* ignore unknown type of fixup */</span></span><br><span class="line">    b	fixnext</span><br><span class="line">fixabs:</span><br><span class="line">    <span class="comment">/* absolute fix: set location to (offset) symbol value */</span></span><br><span class="line">    mov	r1, r1, LSR #<span class="number">4</span>		<span class="comment">/* r1 &lt;- symbol index in .dynsym */</span></span><br><span class="line">    add	r1, r10, r1		<span class="comment">/* r1 &lt;- address of symbol in table */</span></span><br><span class="line">    ldr	r1, [r1, #<span class="number">4</span>]		<span class="comment">/* r1 &lt;- symbol value */</span></span><br><span class="line">    add	r1, r1, r9		<span class="comment">/* r1 &lt;- relocated sym addr */</span></span><br><span class="line">    b	fixnext</span><br><span class="line">fixrel:</span><br><span class="line">    <span class="comment">/* relative fix: increase location by offset */</span></span><br><span class="line">    ldr	r1, [r0]</span><br><span class="line">    add	r1, r1, r9</span><br><span class="line">fixnext:</span><br><span class="line">    str	r1, [r0]</span><br><span class="line">    add	r2, r2, #<span class="number">8</span>		<span class="comment">/* each rel.dyn entry is 8 bytes */</span></span><br><span class="line">    cmp	r2, r3</span><br><span class="line">    blo	fixloop</span><br><span class="line">#endif</span><br><span class="line"></span><br><span class="line">clear_bss:</span><br><span class="line">#ifndef CONFIG_PRELOADER</span><br><span class="line">    ldr	r0, _bss_start_ofs</span><br><span class="line">    ldr	r1, _bss_end_ofs</span><br><span class="line">    ldr	r3, _TEXT_BASE		<span class="comment">/* Text base */</span></span><br><span class="line">    mov	r4, r6			<span class="comment">/* reloc addr */</span></span><br><span class="line">    add	r0, r0, r4</span><br><span class="line">    add	r1, r1, r4</span><br><span class="line">    mov	r2, #<span class="number">0x00000000</span>		<span class="comment">/* clear			    */</span></span><br><span class="line"></span><br><span class="line">clbss_l:str	r2, [r0]		<span class="comment">/* clear loop...		    */</span></span><br><span class="line">    add	r0, r0, #<span class="number">4</span></span><br><span class="line">    cmp	r0, r1</span><br><span class="line">    bne	clbss_l</span><br><span class="line"></span><br><span class="line">    bl coloured_LED_init</span><br><span class="line">    bl red_LED_on</span><br><span class="line">#endif</span><br><span class="line"></span><br><span class="line"><span class="comment">/*</span><br><span class="line"> * We are done. Do not return, instead branch to second part of board</span><br><span class="line"> * initialization, now running from RAM.</span><br><span class="line"> */</span></span><br><span class="line">#ifdef CONFIG_NAND_SPL</span><br><span class="line">    ldr     r0, _nand_boot_ofs</span><br><span class="line">    mov	pc, r0</span><br><span class="line"></span><br><span class="line">_nand_boot_ofs:</span><br><span class="line">    .word nand_boot</span><br><span class="line">#<span class="keyword">else</span></span><br><span class="line">    ldr	r0, _board_init_r_ofs</span><br><span class="line">    adr	r1, _start</span><br><span class="line">    add	lr, r0, r1</span><br><span class="line">    add	lr, lr, r9</span><br><span class="line">    <span class="comment">/* setup parameters for board_init_r */</span></span><br><span class="line">    mov	r0, r5		<span class="comment">/* gd_t */</span></span><br><span class="line">    mov	r1, r6		<span class="comment">/* dest_addr */</span></span><br><span class="line">    <span class="comment">/* jump to it ... */</span></span><br><span class="line">    mov	pc, lr</span><br><span class="line"><span class="comment">/*board_init_r 此处走至u-boot\arch\arm\lib\board.c的board_init_r()函数 */</span></span><br><span class="line">_board_init_r_ofs:</span><br><span class="line">    .word board_init_r - _start</span><br><span class="line">#endif</span><br><span class="line"><span class="comment">/*至此走至C代码的阶段*/</span></span><br><span class="line">_rel_dyn_start_ofs:</span><br><span class="line">    .word __rel_dyn_start - _start</span><br><span class="line">_rel_dyn_end_ofs:</span><br><span class="line">    .word __rel_dyn_end - _start</span><br><span class="line">_dynsym_start_ofs:</span><br><span class="line">    .word __dynsym_start - _start</span><br><span class="line"></span><br><span class="line">......</span><br><span class="line"></span><br><span class="line">#endif</span><br></pre></td></tr></table></figure></p>
<ol>
<li><p>设置CPU进入SVC模式(系统管理模式)，cpsr[4:0]=0xd3。</p>
</li>
<li><p>关中断，INTMSK=0xFFFFFFFF, INTSUBMSK=0x3FF。</p>
</li>
<li><p>关看门狗，WTCON=0x0。</p>
</li>
<li><p>调用s3c2410_cache_flush_all函数，使TLBS，I、D Cache，WB中数据失效。</p>
</li>
<li><p>时钟设置CLKDIVN=0x3 , FCLK:HCLK:PCLK = 1:2:4。</p>
</li>
<li><p>读取mp15的c1寄存器，将最高两位改成11，表示选择了异步时钟模型。</p>
</li>
<li><p>检查系统的复位状态，以确定是不是从睡眠唤醒。</p>
</li>
<li><p>ldr r0,_TEXT_BASE</p>
<p>adr r1,_start</p>
<p>cmp r0,r1</p>
<p>blne cpu_init_crit</p>
</li>
</ol>
<p>根据这几条语句来判断系统是从nand启动的还是直接将程序下载到SDRAM中运行的，这里涉及到运行时域[l7] 和位置无关代码的概念，ldr r0,_TEXT_BASE的作用是将board/nextdvr2410/config.mk文件中定义的TEXT_BASE值（0x33f80000）装载到r0中，adr r1,_start该指令是条伪指令，在编译的时候会被转换成ADD或SUB指令根据当前pc值计算出_start标号的地址，这样的话就可以知道当前程序在什么地址运行（位置无关代码：做成程序的所有指令都是相对寻址的指令，包括跳转指令等，这样代码就可以不在链接所指定的地址上运行）。在上电之后，系统从nand启动，这里得到r0和r1值是不一样的，r0=0x33f80000，而r1=0x00000000。所以接下来会执行cpu_init_crit函数。</p>
<ol>
<li>cpu_init_crit函数，主要完成了两个工作：首先使ICache and Dcache，TLBs中早期内容失效，再设置p15 control register c1，关闭MMU，Dcache，但是打开了Icache和Fault checking，（要求mmu和Dcache是必须要关闭的，而Icache可以打开可以关闭）；其次调用/board/nextdvr2410/memsetup.S文件中的memsetup函数来建立对SDRAM的访问时序。</li>
</ol>
<ol>
<li>Relocate函数，加载nand flash中的uboot到SDRAM中，代码会加载到0x33f80000开始的地址，空间大小是512。</li>
</ol>
<p>1). ndf2ram函数</p>
<p>a.  设置NFCONF，使能2410的nand 控制器，初始化ECC，disable chip等</p>
<p>b.  enable chip，复位chip，读nand状态，判断是否busy，空闲的话再次disable chip；</p>
<p>c.  为调用c函数准备堆栈空间，这里的堆栈是放在uboot代码在SDRAM空间的最后位置armboot_end开始的128KB地址处（包含3 words for abort-stack，实际的SP位置是128*1024-12B处）。</p>
<p>d.  调用c函数copy_uboot_to_ram():nandll_reset() 设置NFCONF（新增设置了时间参数，其余设置和前面一样），复位nand flash；nandll_read_blocks(),传递了3个参数给它，0x33f80000,0x0, 9*NAND_BLOCK_SIZE.这里在读的过程中检查每个块的坏块标志，如果是坏块，则跳过不读。详情不叙，请看uboot的注释。该部分的c代码在cpu/arm920t/Nand_cp.c文件中</p>
<p>e.  ok_nand_read函数：读取SDRAM的前4k内容和SRAM的4K内容进行比较，只要出现不一样的地方就会进入死循环状态，目的就是为了确保转移代码的正确性。</p>
<p>f.  跳回到调用ndf2ram函数处继续执行</p>
<p>2). ldr pc, _start_armboot</p>
<p>_start_armboot: .word start_armboot</p>
<p> //这里参考的是展讯平台7710的源代码，所以并无start_armboot函数，取而代之的是board_init_r函数。</p>
<p>这里将会进入第二阶段的c代码部分：start_armboot()函数，/lib_arm/board.c。</p>
<p>先看/u-boot/arch/arm/lib/board.c的board_init_r()函数：</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br><span class="line">252</span><br><span class="line">253</span><br><span class="line">254</span><br><span class="line">255</span><br><span class="line">256</span><br><span class="line">257</span><br><span class="line">258</span><br><span class="line">259</span><br><span class="line">260</span><br><span class="line">261</span><br><span class="line">262</span><br><span class="line">263</span><br><span class="line">264</span><br><span class="line">265</span><br><span class="line">266</span><br><span class="line">267</span><br><span class="line">268</span><br><span class="line">269</span><br><span class="line">270</span><br><span class="line">271</span><br><span class="line">272</span><br><span class="line">273</span><br><span class="line">274</span><br><span class="line">275</span><br><span class="line">276</span><br><span class="line">277</span><br><span class="line">278</span><br><span class="line">279</span><br><span class="line">280</span><br><span class="line">281</span><br><span class="line">282</span><br><span class="line">283</span><br><span class="line">284</span><br><span class="line">285</span><br><span class="line">286</span><br><span class="line">287</span><br><span class="line">288</span><br><span class="line">289</span><br><span class="line">290</span><br><span class="line">291</span><br><span class="line">292</span><br><span class="line">293</span><br><span class="line">294</span><br><span class="line">295</span><br><span class="line">296</span><br><span class="line">297</span><br><span class="line">298</span><br><span class="line">299</span><br><span class="line">300</span><br><span class="line">301</span><br><span class="line">302</span><br><span class="line">303</span><br><span class="line">304</span><br><span class="line">305</span><br><span class="line">306</span><br><span class="line">307</span><br><span class="line">308</span><br><span class="line">309</span><br><span class="line">310</span><br><span class="line">311</span><br><span class="line">312</span><br><span class="line">313</span><br><span class="line">314</span><br><span class="line">315</span><br><span class="line">316</span><br><span class="line">317</span><br><span class="line">318</span><br><span class="line">319</span><br><span class="line">320</span><br><span class="line">321</span><br><span class="line">322</span><br><span class="line">323</span><br><span class="line">324</span><br><span class="line">325</span><br><span class="line">326</span><br><span class="line">327</span><br><span class="line">328</span><br><span class="line">329</span><br><span class="line">330</span><br><span class="line">331</span><br><span class="line">332</span><br><span class="line">333</span><br><span class="line">334</span><br><span class="line">335</span><br><span class="line">336</span><br><span class="line">337</span><br><span class="line">338</span><br><span class="line">339</span><br><span class="line">340</span><br><span class="line">341</span><br><span class="line">342</span><br><span class="line">343</span><br><span class="line">344</span><br><span class="line">345</span><br><span class="line">346</span><br><span class="line">347</span><br><span class="line">348</span><br><span class="line">349</span><br><span class="line">350</span><br><span class="line">351</span><br><span class="line">352</span><br><span class="line">353</span><br><span class="line">354</span><br><span class="line">355</span><br><span class="line">356</span><br><span class="line">357</span><br><span class="line">358</span><br><span class="line">359</span><br><span class="line">360</span><br><span class="line">361</span><br><span class="line">362</span><br><span class="line">363</span><br><span class="line">364</span><br><span class="line">365</span><br><span class="line">366</span><br><span class="line">367</span><br><span class="line">368</span><br><span class="line">369</span><br><span class="line">370</span><br><span class="line">371</span><br><span class="line">372</span><br><span class="line">373</span><br><span class="line">374</span><br><span class="line">375</span><br><span class="line">376</span><br><span class="line">377</span><br><span class="line">378</span><br><span class="line">379</span><br><span class="line">380</span><br><span class="line">381</span><br><span class="line">382</span><br><span class="line">383</span><br><span class="line">384</span><br><span class="line">385</span><br><span class="line">386</span><br><span class="line">387</span><br><span class="line">388</span><br><span class="line">389</span><br><span class="line">390</span><br><span class="line">391</span><br><span class="line">392</span><br><span class="line">393</span><br><span class="line">394</span><br><span class="line">395</span><br><span class="line">396</span><br><span class="line">397</span><br><span class="line">398</span><br><span class="line">399</span><br><span class="line">400</span><br><span class="line">401</span><br><span class="line">402</span><br><span class="line">403</span><br><span class="line">404</span><br><span class="line">405</span><br><span class="line">406</span><br><span class="line">407</span><br><span class="line">408</span><br><span class="line">409</span><br><span class="line">410</span><br><span class="line">411</span><br><span class="line">412</span><br><span class="line">413</span><br><span class="line">414</span><br><span class="line">415</span><br><span class="line">416</span><br><span class="line">417</span><br><span class="line">418</span><br><span class="line">419</span><br><span class="line">420</span><br><span class="line">421</span><br><span class="line">422</span><br><span class="line">423</span><br><span class="line">424</span><br><span class="line">425</span><br><span class="line">426</span><br><span class="line">427</span><br><span class="line">428</span><br><span class="line">429</span><br><span class="line">430</span><br><span class="line">431</span><br><span class="line">432</span><br><span class="line">433</span><br><span class="line">434</span><br><span class="line">435</span><br><span class="line">436</span><br><span class="line">437</span><br></pre></td><td class="code"><pre><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">board_init_r</span> <span class="params">(<span class="keyword">gd_t</span> *id, ulong dest_addr)</span></span><br><span class="line">    </span>&#123;</span><br><span class="line">    ......</span><br><span class="line">    <span class="comment">/**一系列初始化操作之后 重点为do_cboot(NULL, 0, 1, NULL)和main_loop ()*/</span></span><br><span class="line">        board_init();	<span class="comment">/* Setup chipselects */</span></span><br><span class="line"></span><br><span class="line">      boot_pwr_check();</span><br><span class="line"></span><br><span class="line">    <span class="meta">#<span class="meta-keyword">ifdef</span> CONFIG_SERIAL_MULTI</span></span><br><span class="line">        serial_initialize();</span><br><span class="line">    <span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line"></span><br><span class="line">        debug (<span class="string">"Now running in RAM - U-Boot at: %08lx\n"</span>, dest_addr);</span><br><span class="line"></span><br><span class="line">    <span class="meta">#<span class="meta-keyword">ifdef</span> CONFIG_LOGBUFFER</span></span><br><span class="line">        logbuff_init_ptrs ();</span><br><span class="line">    <span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line">    <span class="meta">#<span class="meta-keyword">ifdef</span> CONFIG_POST</span></span><br><span class="line">        post_output_backlog ();</span><br><span class="line">    <span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line"></span><br><span class="line">        <span class="comment">/* The Malloc area is immediately below the monitor copy in DRAM */</span></span><br><span class="line">        malloc_start = dest_addr - TOTAL_MALLOC_LEN;</span><br><span class="line">    <span class="meta">#<span class="meta-keyword">ifdef</span> SPRD_EVM_TAG_ON</span></span><br><span class="line">            SPRD_EVM_TAG(<span class="number">4</span>);</span><br><span class="line">    <span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line">        mem_malloc_init (malloc_start, TOTAL_MALLOC_LEN);</span><br><span class="line">    <span class="meta">#<span class="meta-keyword">ifdef</span> SPRD_EVM_TAG_ON</span></span><br><span class="line">            SPRD_EVM_TAG(<span class="number">5</span>);</span><br><span class="line">    <span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line">        boot_pwr_check();</span><br><span class="line"></span><br><span class="line">    <span class="meta">#<span class="meta-keyword">if</span> !defined(CONFIG_SYS_NO_FLASH)</span></span><br><span class="line">        <span class="built_in">puts</span> (<span class="string">"FLASH: "</span>);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> ((flash_size = flash_init ()) &gt; <span class="number">0</span>) &#123;</span><br><span class="line">    # <span class="function">ifdef CONFIG_SYS_FLASH_CHECKSUM</span><br><span class="line">            <span class="title">print_size</span> <span class="params">(flash_size, <span class="string">""</span>)</span></span>;</span><br><span class="line">            <span class="comment">/*</span><br><span class="line">             * Compute and print flash CRC if flashchecksum is set to 'y'</span><br><span class="line">             *</span><br><span class="line">             * <span class="doctag">NOTE:</span> Maybe we should add some WATCHDOG_RESET()? XXX</span><br><span class="line">             */</span></span><br><span class="line">            s = getenv (<span class="string">"flashchecksum"</span>);</span><br><span class="line">            <span class="keyword">if</span> (s &amp;&amp; (*s == <span class="string">'y'</span>)) &#123;</span><br><span class="line">                <span class="built_in">printf</span> (<span class="string">"  CRC: %08X"</span>,</span><br><span class="line">                    crc32 (<span class="number">0</span>, (<span class="keyword">const</span> <span class="keyword">unsigned</span> <span class="keyword">char</span> *) CONFIG_SYS_FLASH_BASE, flash_size)</span><br><span class="line">                );</span><br><span class="line">            &#125;</span><br><span class="line">            putc (<span class="string">'\n'</span>);</span><br><span class="line">    # <span class="keyword">else</span>	<span class="comment">/* !CONFIG_SYS_FLASH_CHECKSUM */</span></span><br><span class="line">            print_size (flash_size, <span class="string">"\n"</span>);</span><br><span class="line">    # endif <span class="comment">/* CONFIG_SYS_FLASH_CHECKSUM */</span></span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="built_in">puts</span> (failed);</span><br><span class="line">            hang ();</span><br><span class="line">        &#125;</span><br><span class="line">    <span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line">        boot_pwr_check();</span><br><span class="line"></span><br><span class="line">    <span class="meta">#<span class="meta-keyword">if</span> !defined(CONFIG_EMMC_BOOT)</span></span><br><span class="line">    <span class="meta">#<span class="meta-keyword">if</span> defined(CONFIG_CMD_NAND)</span></span><br><span class="line">        <span class="built_in">puts</span> (<span class="string">"NAND:  "</span>);</span><br><span class="line">        ret = nand_init();		<span class="comment">/* go init the NAND */</span></span><br><span class="line">            <span class="keyword">if</span> (ret) &#123;</span><br><span class="line">                <span class="built_in">puts</span> (<span class="string">"NAND init error  "</span>);</span><br><span class="line">                <span class="keyword">while</span>(<span class="number">1</span>);</span><br><span class="line">            &#125;</span><br><span class="line">    <span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line">    <span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line"></span><br><span class="line">        boot_pwr_check();</span><br><span class="line">    <span class="meta">#<span class="meta-keyword">ifdef</span> SPRD_EVM_TAG_ON</span></span><br><span class="line">            SPRD_EVM_TAG(<span class="number">6</span>);</span><br><span class="line">    <span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line"></span><br><span class="line">    <span class="meta">#<span class="meta-keyword">if</span> defined(CONFIG_CMD_ONENAND)</span></span><br><span class="line">    <span class="meta">#<span class="meta-keyword">if</span> !(defined CONFIG_TIGER &amp;&amp; defined CONFIG_EMMC_BOOT)</span></span><br><span class="line">        onenand_init();</span><br><span class="line">    <span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line">    <span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line"></span><br><span class="line">    <span class="meta">#<span class="meta-keyword">ifdef</span> CONFIG_GENERIC_MMC</span></span><br><span class="line">           <span class="built_in">puts</span>(<span class="string">"MMC:   "</span>);</span><br><span class="line">           mmc_initialize(bd);</span><br><span class="line">    <span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line"></span><br><span class="line">    <span class="meta">#<span class="meta-keyword">ifdef</span> CONFIG_HAS_DATAFLASH</span></span><br><span class="line">        AT91F_DataflashInit();</span><br><span class="line">        dataflash_print_info();</span><br><span class="line">    <span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line"></span><br><span class="line">    <span class="meta">#<span class="meta-keyword">ifdef</span> CONFIG_EMMC_BOOT</span></span><br><span class="line">        mmc_legacy_init(<span class="number">1</span>);</span><br><span class="line">    <span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line">        <span class="comment">/* initialize environment */</span></span><br><span class="line">        env_relocate ();</span><br><span class="line">        boot_pwr_check();</span><br><span class="line"></span><br><span class="line">    <span class="meta">#<span class="meta-keyword">ifdef</span> CONFIG_VFD</span></span><br><span class="line">        <span class="comment">/* must do this after the framebuffer is allocated */</span></span><br><span class="line">        drv_vfd_init();</span><br><span class="line">    <span class="meta">#<span class="meta-keyword">endif</span> <span class="comment">/* CONFIG_VFD */</span></span></span><br><span class="line"></span><br><span class="line">    <span class="comment">/*tempaily use for tiger to avoid died as refreshing LCD*/</span></span><br><span class="line"></span><br><span class="line">        <span class="comment">/* IP Address */</span></span><br><span class="line">        gd-&gt;bd-&gt;bi_ip_addr = getenv_IPaddr (<span class="string">"ipaddr"</span>);</span><br><span class="line"></span><br><span class="line">        stdio_init ();	<span class="comment">/* get the devices list going. */</span></span><br><span class="line">        boot_pwr_check();</span><br><span class="line"></span><br><span class="line">        jumptable_init ();</span><br><span class="line">        boot_pwr_check();</span><br><span class="line"></span><br><span class="line">    <span class="meta">#<span class="meta-keyword">if</span> defined(CONFIG_API)</span></span><br><span class="line">        <span class="comment">/* Initialize API */</span></span><br><span class="line">        api_init ();</span><br><span class="line">    <span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line">        <span class="keyword">char</span> fake[<span class="number">4</span>]=<span class="string">"fak"</span>;</span><br><span class="line">        setenv(<span class="string">"splashimage"</span>, fake);</span><br><span class="line"></span><br><span class="line">        console_init_r ();	<span class="comment">/* fully init console as a device */</span></span><br><span class="line">        boot_pwr_check();</span><br><span class="line"></span><br><span class="line">    <span class="meta">#<span class="meta-keyword">if</span> defined(CONFIG_ARCH_MISC_INIT)</span></span><br><span class="line">        <span class="comment">/* miscellaneous arch dependent initialisations */</span></span><br><span class="line">        arch_misc_init ();</span><br><span class="line">    <span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line">    <span class="meta">#<span class="meta-keyword">if</span> defined(CONFIG_MISC_INIT_R)</span></span><br><span class="line">        <span class="comment">/* miscellaneous platform dependent initialisations */</span></span><br><span class="line">        misc_init_r ();</span><br><span class="line">    <span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line"></span><br><span class="line">         <span class="comment">/* set up exceptions */</span></span><br><span class="line">        interrupt_init ();</span><br><span class="line">        <span class="comment">/* enable exceptions */</span></span><br><span class="line">        enable_interrupts ();</span><br><span class="line">        boot_pwr_check();</span><br><span class="line"></span><br><span class="line">        <span class="comment">/* Perform network card initialisation if necessary */</span></span><br><span class="line">    <span class="meta">#<span class="meta-keyword">if</span> defined(CONFIG_DRIVER_SMC91111) || defined (CONFIG_DRIVER_LAN91C96)</span></span><br><span class="line">        <span class="comment">/* <span class="doctag">XXX:</span> this needs to be moved to board init */</span></span><br><span class="line">        <span class="keyword">if</span> (getenv (<span class="string">"ethaddr"</span>)) &#123;</span><br><span class="line">            uchar enetaddr[<span class="number">6</span>];</span><br><span class="line">            eth_getenv_enetaddr(<span class="string">"ethaddr"</span>, enetaddr);</span><br><span class="line">            smc_set_mac_addr(enetaddr);</span><br><span class="line">        &#125;</span><br><span class="line">    <span class="meta">#<span class="meta-keyword">endif</span> <span class="comment">/* CONFIG_DRIVER_SMC91111 || CONFIG_DRIVER_LAN91C96 */</span></span></span><br><span class="line"></span><br><span class="line">        <span class="comment">/* Initialize from environment */</span></span><br><span class="line">        <span class="keyword">if</span> ((s = getenv (<span class="string">"loadaddr"</span>)) != <span class="literal">NULL</span>) &#123;</span><br><span class="line">            load_addr = simple_strtoul (s, <span class="literal">NULL</span>, <span class="number">16</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    <span class="meta">#<span class="meta-keyword">if</span> defined(CONFIG_CMD_NET)</span></span><br><span class="line">        <span class="keyword">if</span> ((s = getenv (<span class="string">"bootfile"</span>)) != <span class="literal">NULL</span>) &#123;</span><br><span class="line">            copy_filename (BootFile, s, <span class="keyword">sizeof</span> (BootFile));</span><br><span class="line">        &#125;</span><br><span class="line">    <span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line">        boot_pwr_check();</span><br><span class="line">        <span class="comment">//usb_eth_initialize(NULL);</span></span><br><span class="line">    <span class="meta">#<span class="meta-keyword">ifdef</span> BOARD_LATE_INIT</span></span><br><span class="line">        board_late_init ();</span><br><span class="line">    <span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line">    ......</span><br><span class="line"></span><br><span class="line">    <span class="meta">#<span class="meta-keyword">ifdef</span> SPRD_EVM_TAG_ON</span></span><br><span class="line">            SPRD_EVM_TAG(<span class="number">11</span>);</span><br><span class="line">    <span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line">        <span class="function"><span class="keyword">extern</span> <span class="keyword">int</span> <span class="title">do_cboot</span><span class="params">(<span class="keyword">cmd_tbl_t</span> *cmdtp, <span class="keyword">int</span> flag, <span class="keyword">int</span> argc, <span class="keyword">char</span> *<span class="keyword">const</span> argv[])</span></span>;</span><br><span class="line">        boot_pwr_check();</span><br><span class="line"></span><br><span class="line">        do_cboot(<span class="literal">NULL</span>, <span class="number">0</span>, <span class="number">1</span>, <span class="literal">NULL</span>);<span class="comment">//重点操作函数，此处走至u-boot\property\cmd_cboot.c</span></span><br><span class="line">        <span class="comment">/* main_loop() can return to retry autoboot, if so just run it again. */</span></span><br><span class="line">        <span class="keyword">for</span> (;;) &#123;</span><br><span class="line">            main_loop ();</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">/* NOTREACHED - no way out of command loop except booting */</span></span><br><span class="line">    &#125;</span><br><span class="line">``` </span><br><span class="line"></span><br><span class="line">该段代码完成了一些设备的初始化do_cboot(<span class="literal">NULL</span>, <span class="number">0</span>, <span class="number">1</span>, <span class="literal">NULL</span>)和main_loop ()是此处重点函数，其中do_cboot(<span class="literal">NULL</span>, <span class="number">0</span>, <span class="number">1</span>, <span class="literal">NULL</span>)的实现在u-boot/property/cmd_cboot.c而main_loop()则是在u-boot/common/main.c中。先看u-boot/property/cmd_cboot.c。</span><br><span class="line"></span><br><span class="line">```<span class="function">cpp</span><br><span class="line">    <span class="keyword">int</span> <span class="title">boot_pwr_check</span><span class="params">(<span class="keyword">void</span>)</span></span><br><span class="line">    </span>&#123;</span><br><span class="line">        <span class="keyword">static</span> <span class="keyword">int</span> total_cnt = <span class="number">0</span>;</span><br><span class="line">        <span class="keyword">if</span>(!power_button_pressed())</span><br><span class="line">          total_cnt ++;</span><br><span class="line">        <span class="keyword">return</span> total_cnt;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="meta">#<span class="meta-keyword">define</span> mdelay(_ms) udelay(_ms*1000)</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">int</span> <span class="title">do_cboot</span><span class="params">(<span class="keyword">cmd_tbl_t</span> *cmdtp, <span class="keyword">int</span> flag, <span class="keyword">int</span> argc, <span class="keyword">char</span> *<span class="keyword">const</span> argv[])</span></span><br><span class="line">    </span>&#123;</span><br><span class="line">        <span class="keyword">uint32_t</span> key_mode = <span class="number">0</span>;</span><br><span class="line">        <span class="keyword">uint32_t</span> key_code = <span class="number">0</span>;</span><br><span class="line">        <span class="keyword">volatile</span> <span class="keyword">int</span> i;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span>(argc &gt; <span class="number">2</span>)</span><br><span class="line">          <span class="keyword">goto</span> usage;</span><br><span class="line"></span><br><span class="line">    <span class="meta">#<span class="meta-keyword">ifdef</span> CONFIG_SC8830</span></span><br><span class="line">            <span class="keyword">if</span>(cali_file_check())</span><br><span class="line">                    calibration_detect(<span class="number">2</span>);</span><br><span class="line">    <span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line">    <span class="meta">#<span class="meta-keyword">ifdef</span> CONFIG_SC7710G2</span></span><br><span class="line">        &#123;</span><br><span class="line">        <span class="function"><span class="keyword">extern</span> <span class="keyword">void</span> <span class="title">set_cp_emc_pad</span><span class="params">(<span class="keyword">void</span>)</span></span>;</span><br><span class="line">        set_cp_emc_pad();</span><br><span class="line">        &#125;</span><br><span class="line">    <span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line">        CHG_Init();</span><br><span class="line"></span><br><span class="line">    <span class="meta">#<span class="meta-keyword">ifdef</span> CONFIG_SC8830</span></span><br><span class="line">        DCDC_Cal_ArmCore();</span><br><span class="line">        <span class="comment">//DCDC_Cal_All(0);</span></span><br><span class="line">    <span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line"></span><br><span class="line">    <span class="meta">#<span class="meta-keyword">ifdef</span> CONFIG_AUTOBOOT</span></span><br><span class="line">        normal_mode();<span class="comment">//如果down的是autopoweron的uboot，这里会直接去正常开机</span></span><br><span class="line">    <span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line"></span><br><span class="line">    <span class="meta">#<span class="meta-keyword">ifdef</span> CONFIG_SC7710G2</span></span><br><span class="line">        <span class="keyword">if</span>(!pbint2_connected())</span><br><span class="line">            normal_mode();</span><br><span class="line">    <span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line"></span><br><span class="line">        boot_pwr_check();</span><br><span class="line"></span><br><span class="line">    <span class="meta">#<span class="meta-keyword">ifdef</span> CONFIG_SC8800G</span></span><br><span class="line">        CHG_ShutDown();</span><br><span class="line">        <span class="keyword">if</span>(charger_connected())&#123;</span><br><span class="line">            mdelay(<span class="number">10</span>);</span><br><span class="line">            CHG_TurnOn();</span><br><span class="line">        &#125;<span class="keyword">else</span>&#123;</span><br><span class="line">            <span class="comment">//根据sp8810.h里的LOW_BAT_VOL，如果电压低于3.5V，则直接power down</span></span><br><span class="line">            <span class="keyword">if</span>(is_bat_low())&#123;</span><br><span class="line">                <span class="built_in">printf</span>(<span class="string">"shut down again for low battery\n"</span>);</span><br><span class="line">                power_down_devices();</span><br><span class="line">                <span class="keyword">while</span>(<span class="number">1</span>)</span><br><span class="line">                  ;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    <span class="meta">#<span class="meta-keyword">else</span></span></span><br><span class="line"></span><br><span class="line">    <span class="meta">#<span class="meta-keyword">ifndef</span> CONFIG_MACH_CORI</span></span><br><span class="line">        <span class="keyword">if</span>(is_bat_low())&#123;</span><br><span class="line">                    <span class="built_in">printf</span>(<span class="string">"shut down again for low battery\n"</span>);</span><br><span class="line">                    mdelay(<span class="number">10000</span>);</span><br><span class="line">                    power_down_devices();</span><br><span class="line">                    <span class="keyword">while</span>(<span class="number">1</span>)</span><br><span class="line">                      ;</span><br><span class="line">        &#125;</span><br><span class="line">    <span class="meta">#<span class="meta-keyword">endif</span>    </span></span><br><span class="line">    <span class="meta">#<span class="meta-keyword">endif</span>	</span></span><br><span class="line"></span><br><span class="line">        boot_pwr_check();</span><br><span class="line">        board_keypad_init();<span class="comment">//初始化键盘</span></span><br><span class="line">        boot_pwr_check();</span><br><span class="line"></span><br><span class="line">    <span class="meta">#<span class="meta-keyword">ifdef</span> CONFIG_SPRD_SYSDUMP</span></span><br><span class="line">        write_sysdump_before_boot();</span><br><span class="line">    <span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line"></span><br><span class="line">        <span class="function"><span class="keyword">int</span> <span class="title">recovery_init</span><span class="params">(<span class="keyword">void</span>)</span></span>;</span><br><span class="line">        <span class="keyword">int</span> ret =<span class="number">0</span>;</span><br><span class="line">        ret = recovery_init();</span><br><span class="line">        <span class="keyword">if</span>(ret == <span class="number">1</span>)&#123;</span><br><span class="line">            DBG(<span class="string">"func: %s line: %d\n"</span>, __func__, __LINE__);</span><br><span class="line">            recovery_mode_without_update();</span><br><span class="line">        &#125;<span class="keyword">else</span> <span class="keyword">if</span>(ret == <span class="number">2</span>)&#123;</span><br><span class="line">    #ifndef CONFIG_SC8830</span><br><span class="line">            try_update_modem(); <span class="comment">//update img from mmc</span></span><br><span class="line">    <span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line">            normal_mode();</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="function"><span class="keyword">unsigned</span> <span class="title">check_reboot_mode</span><span class="params">(<span class="keyword">void</span>)</span></span>;</span><br><span class="line">        <span class="comment">//获取寄存器里HW的rest标志位，得到当前的开机模式</span></span><br><span class="line">        <span class="comment">//此处主要是异常重启，恢复出厂设置，关机闹钟等（没有按power键导致的开机）</span></span><br><span class="line">        <span class="keyword">unsigned</span> rst_mode= check_reboot_mode();</span><br><span class="line">        <span class="comment">//检查是否是recovery模式</span></span><br><span class="line">        <span class="keyword">if</span>(rst_mode == RECOVERY_MODE)&#123;</span><br><span class="line">            DBG(<span class="string">"func: %s line: %d\n"</span>, __func__, __LINE__);</span><br><span class="line">            recovery_mode();</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">else</span> <span class="keyword">if</span>(rst_mode == FASTBOOT_MODE)&#123;</span><br><span class="line">            DBG(<span class="string">"func: %s line: %d\n"</span>, __func__, __LINE__);</span><br><span class="line">            fastboot_mode();</span><br><span class="line">        &#125;<span class="keyword">else</span> <span class="keyword">if</span>(rst_mode == NORMAL_MODE)&#123;</span><br><span class="line">            normal_mode();</span><br><span class="line">        &#125;<span class="keyword">else</span> <span class="keyword">if</span>(rst_mode == WATCHDOG_REBOOT)&#123;</span><br><span class="line">            watchdog_mode();</span><br><span class="line">        &#125;<span class="keyword">else</span> <span class="keyword">if</span>(rst_mode == UNKNOW_REBOOT_MODE)&#123;</span><br><span class="line">            unknow_reboot_mode();</span><br><span class="line">        &#125;<span class="keyword">else</span> <span class="keyword">if</span>(rst_mode == PANIC_REBOOT)&#123;</span><br><span class="line">            panic_reboot_mode();</span><br><span class="line">        &#125;<span class="keyword">else</span> <span class="keyword">if</span>(rst_mode == ALARM_MODE)&#123;</span><br><span class="line">                  <span class="keyword">int</span> flag =alarm_flag_check();</span><br><span class="line">                  <span class="keyword">if</span>(flag == <span class="number">1</span>)</span><br><span class="line">                alarm_mode();</span><br><span class="line">                  <span class="keyword">else</span> <span class="keyword">if</span>(flag == <span class="number">2</span>)</span><br><span class="line">                normal_mode();</span><br><span class="line">        &#125;<span class="keyword">else</span> <span class="keyword">if</span>(rst_mode == SLEEP_MODE)&#123;</span><br><span class="line">            sleep_mode();</span><br><span class="line">        &#125;<span class="keyword">else</span> <span class="keyword">if</span>(rst_mode == SPECIAL_MODE)&#123;</span><br><span class="line">            special_mode();</span><br><span class="line">        &#125;<span class="keyword">else</span> <span class="keyword">if</span>(rst_mode == CALIBRATION_MODE)&#123;</span><br><span class="line">            calibration_detect(<span class="number">0</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    <span class="meta">#<span class="meta-keyword">ifdef</span> CONFIG_SC8810</span></span><br><span class="line">    <span class="comment">//    normal_mode();</span></span><br><span class="line">    <span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line">        DBG(<span class="string">"func: %s line: %d\n"</span>, __func__, __LINE__);</span><br><span class="line"></span><br><span class="line">       <span class="keyword">if</span>(charger_connected())&#123;</span><br><span class="line">            DBG(<span class="string">"%s: charger connected\n"</span>, __FUNCTION__);</span><br><span class="line">    <span class="meta">#<span class="meta-keyword">if</span> defined (CONFIG_SP8810W) || defined(CONFIG_SC7710G2)</span></span><br><span class="line">                calibration_detect(<span class="number">1</span>);</span><br><span class="line">    <span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line">            charge_mode();</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">//find the power up trigger</span></span><br><span class="line">        <span class="comment">//如果按power键的“次数”达标了，认为这个是一次长按事件</span></span><br><span class="line">        <span class="keyword">else</span> <span class="keyword">if</span>(boot_pwr_check() &gt;= get_pwr_key_cnt())&#123;</span><br><span class="line">            DBG(<span class="string">"%s: power button press\n"</span>, __FUNCTION__);</span><br><span class="line">        DBG(<span class="string">"boot_pwr_check=%d,get_pwr_key_cnt=%d\n"</span>,boot_pwr_check(),get_pwr_key_cnt());</span><br><span class="line">            <span class="comment">//go on to check other keys</span></span><br><span class="line">            mdelay(<span class="number">50</span>);</span><br><span class="line">            <span class="keyword">for</span>(i=<span class="number">0</span>; i&lt;<span class="number">10</span>;i++)&#123;</span><br><span class="line">                key_code = board_key_scan();<span class="comment">//获取另外一个按键</span></span><br><span class="line">                <span class="keyword">if</span>(key_code != KEY_RESERVED)</span><br><span class="line">                  <span class="keyword">break</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            DBG(<span class="string">"key_code %d\n"</span>, key_code);</span><br><span class="line">            <span class="comment">//查找对应的按键码对应的开机模式</span></span><br><span class="line">            key_mode = check_key_boot(key_code);</span><br><span class="line"></span><br><span class="line">            <span class="keyword">switch</span>(key_mode)&#123;</span><br><span class="line">                <span class="keyword">case</span> BOOT_FASTBOOT:</span><br><span class="line">                    fastboot_mode();</span><br><span class="line">                    <span class="keyword">break</span>;</span><br><span class="line">                <span class="keyword">case</span> BOOT_RECOVERY:</span><br><span class="line">                    recovery_mode();</span><br><span class="line">                    <span class="keyword">break</span>;</span><br><span class="line">                <span class="keyword">case</span> BOOT_CALIBRATE:</span><br><span class="line">                    engtest_mode();</span><br><span class="line">                    <span class="keyword">return</span> <span class="number">0</span>; <span class="comment">//back to normal boot</span></span><br><span class="line">                    <span class="keyword">break</span>;</span><br><span class="line">                <span class="keyword">case</span> BOOT_DLOADER:</span><br><span class="line">                    dloader_mode();</span><br><span class="line">                    <span class="keyword">break</span>;</span><br><span class="line">                <span class="keyword">default</span>:</span><br><span class="line">                    <span class="keyword">break</span>;<span class="comment">//如果是正常开机模式，因为没有</span></span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">else</span> <span class="keyword">if</span>(alarm_triggered() &amp;&amp; alarm_flag_check())&#123;</span><br><span class="line">            DBG(<span class="string">"%s: alarm triggered\n"</span>, __FUNCTION__);</span><br><span class="line">            <span class="keyword">int</span> flag =alarm_flag_check();</span><br><span class="line"></span><br><span class="line">            <span class="keyword">if</span>(flag == <span class="number">1</span>)&#123;</span><br><span class="line">                <span class="comment">//如果是闹钟触发导致的开机，则进入关机闹钟模式</span></span><br><span class="line">                alarm_mode();</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">else</span> <span class="keyword">if</span>(flag == <span class="number">2</span>)&#123;</span><br><span class="line">                normal_mode();<span class="comment">//如果只按了power键。</span></span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">        &#125;<span class="keyword">else</span>&#123;</span><br><span class="line">    #<span class="keyword">if</span> BOOT_NATIVE_LINUX_MODEM</span><br><span class="line">            *(<span class="keyword">volatile</span> u32*)CALIBRATION_FLAG = <span class="number">0xca</span>;</span><br><span class="line">    <span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line">    <span class="meta">#<span class="meta-keyword">if</span> !defined (CONFIG_SC8830) &amp;&amp; !defined(CONFIG_SC7710G2)</span></span><br><span class="line">            calibration_detect(<span class="number">0</span>);</span><br><span class="line">    <span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line">            <span class="comment">//if calibrate success, it will here</span></span><br><span class="line">            DBG(<span class="string">"%s: power done again\n"</span>, __FUNCTION__);</span><br><span class="line">            power_down_devices();</span><br><span class="line">            <span class="keyword">while</span>(<span class="number">1</span>)</span><br><span class="line">              ;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span>(argc == <span class="number">1</span>)&#123;</span><br><span class="line">        DBG(<span class="string">"func: %s line: %d\n"</span>, __func__, __LINE__);</span><br><span class="line">            normal_mode();</span><br><span class="line">            <span class="keyword">return</span> <span class="number">1</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span>(argc == <span class="number">2</span>)&#123;</span><br><span class="line">            DBG(<span class="string">"func: %s line: %d\n"</span>, __func__, __LINE__);</span><br><span class="line"></span><br><span class="line">            <span class="keyword">if</span>(<span class="built_in">strcmp</span>(argv[<span class="number">1</span>],<span class="string">"normal"</span>) == <span class="number">0</span>)&#123;</span><br><span class="line">                normal_mode();</span><br><span class="line">                <span class="keyword">return</span> <span class="number">1</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            DBG(<span class="string">"func: %s line: %d\n"</span>, __func__, __LINE__);</span><br><span class="line"></span><br><span class="line">            <span class="keyword">if</span>(<span class="built_in">strcmp</span>(argv[<span class="number">1</span>],<span class="string">"recovery"</span>) == <span class="number">0</span>)&#123;</span><br><span class="line">                recovery_mode();</span><br><span class="line">                <span class="keyword">return</span> <span class="number">1</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            DBG(<span class="string">"func: %s line: %d\n"</span>, __func__, __LINE__);</span><br><span class="line"></span><br><span class="line">            <span class="keyword">if</span>(<span class="built_in">strcmp</span>(argv[<span class="number">1</span>],<span class="string">"fastboot"</span>) == <span class="number">0</span>)&#123;</span><br><span class="line">                fastboot_mode();</span><br><span class="line">                <span class="keyword">return</span> <span class="number">1</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            DBG(<span class="string">"func: %s line: %d\n"</span>, __func__, __LINE__);</span><br><span class="line"></span><br><span class="line">            <span class="keyword">if</span>(<span class="built_in">strcmp</span>(argv[<span class="number">1</span>],<span class="string">"dloader"</span>) == <span class="number">0</span>)&#123;</span><br><span class="line">                dloader_mode();</span><br><span class="line">                <span class="keyword">return</span> <span class="number">1</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            DBG(<span class="string">"func: %s line: %d\n"</span>, __func__, __LINE__);</span><br><span class="line"></span><br><span class="line">            <span class="keyword">if</span>(<span class="built_in">strcmp</span>(argv[<span class="number">1</span>],<span class="string">"charge"</span>) == <span class="number">0</span>)&#123;</span><br><span class="line">                <span class="comment">//如果没有按power键，且插入了充电器，则进入充电模式</span></span><br><span class="line">                charge_mode();</span><br><span class="line">                <span class="keyword">return</span> <span class="number">1</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            DBG(<span class="string">"func: %s line: %d\n"</span>, __func__, __LINE__);</span><br><span class="line"></span><br><span class="line">            <span class="keyword">if</span>(<span class="built_in">strcmp</span>(argv[<span class="number">1</span>],<span class="string">"caliberation"</span>) == <span class="number">0</span>)&#123;</span><br><span class="line">                calibration_detect(<span class="number">1</span>);</span><br><span class="line">                <span class="keyword">return</span> <span class="number">1</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            DBG(<span class="string">"func: %s line: %d\n"</span>, __func__, __LINE__);</span><br><span class="line">        &#125;</span><br><span class="line">        DBG(<span class="string">"func: %s line: %d\n"</span>, __func__, __LINE__);</span><br><span class="line"></span><br><span class="line">    usage:</span><br><span class="line">        cmd_usage(cmdtp);</span><br><span class="line">        <span class="keyword">return</span> <span class="number">1</span>;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>
<p>接下来分析正常开机的流程也就是normal_mode()，其他几种开机流程与normal_mode()类似。normal_mode()的实现在 u-boot/property/normal_mode.c：<br><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">normal_mode</span><span class="params">(<span class="keyword">void</span>)</span></span><br><span class="line"></span>&#123;</span><br><span class="line"><span class="meta">#<span class="meta-keyword">if</span> defined (CONFIG_SC8810) || defined (CONFIG_SC8825) || defined (CONFIG_SC8830)</span></span><br><span class="line">    <span class="comment">//MMU_Init(CONFIG_MMU_TABLE_ADDR);</span></span><br><span class="line">    vibrator_hw_init();<span class="comment">//初始化马达</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line">    set_vibrator(<span class="number">1</span>);<span class="comment">//起震，这个就是开机震的那一下</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">ifndef</span> UART_CONSOLE_SUPPORT</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">ifdef</span> CONFIG_SC7710G2</span></span><br><span class="line">    <span class="function"><span class="keyword">extern</span> <span class="keyword">int</span>  <span class="title">serial1_SwitchToModem</span><span class="params">(<span class="keyword">void</span>)</span></span>;</span><br><span class="line">    serial1_SwitchToModem();</span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">if</span> BOOT_NATIVE_LINUX</span></span><br><span class="line">    vlx_nand_boot(BOOT_PART, CONFIG_BOOTARGS, BACKLIGHT_ON);</span><br><span class="line"><span class="meta">#<span class="meta-keyword">else</span></span></span><br><span class="line">    vlx_nand_boot(BOOT_PART, <span class="literal">NULL</span>, BACKLIGHT_ON);</span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>最终将操作交给vlx_nand_boot()，其实现在u-boot/property/normal_nand_mode.c<br><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">vlx_nand_boot</span><span class="params">(<span class="keyword">char</span> * kernel_pname, <span class="keyword">char</span> * cmdline, <span class="keyword">int</span> backlight_set)</span></span><br><span class="line"></span>&#123;</span><br><span class="line">......</span><br><span class="line">    <span class="keyword">char</span> *fixnvpoint = <span class="string">"/fixnv"</span>;</span><br><span class="line">    <span class="keyword">char</span> *fixnvfilename = <span class="string">"/fixnv/fixnv.bin"</span>;</span><br><span class="line">    <span class="keyword">char</span> *fixnvfilename2 = <span class="string">"/fixnv/fixnvchange.bin"</span>;</span><br><span class="line">    <span class="keyword">char</span> *backupfixnvpoint = <span class="string">"/backupfixnv"</span>;</span><br><span class="line">    <span class="keyword">char</span> *backupfixnvfilename = <span class="string">"/backupfixnv/fixnv.bin"</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">char</span> *runtimenvpoint = <span class="string">"/runtimenv"</span>;</span><br><span class="line">    <span class="keyword">char</span> *runtimenvpoint2 = <span class="string">"/runtimenv"</span>;</span><br><span class="line">    <span class="keyword">char</span> *runtimenvfilename = <span class="string">"/runtimenv/runtimenv.bin"</span>;</span><br><span class="line">    <span class="keyword">char</span> *runtimenvfilename2 = <span class="string">"/runtimenv/runtimenvbkup.bin"</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">char</span> *productinfopoint = <span class="string">"/productinfo"</span>;</span><br><span class="line">    <span class="keyword">char</span> *productinfofilename = <span class="string">"/productinfo/productinfo.bin"</span>;</span><br><span class="line">    <span class="keyword">char</span> *productinfofilename2 = <span class="string">"/productinfo/productinfobkup.bin"</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">int</span> orginal_right, backupfile_right;</span><br><span class="line">    <span class="keyword">unsigned</span> <span class="keyword">long</span> orginal_index, backupfile_index;</span><br><span class="line">    <span class="keyword">nand_erase_options_t</span> opts;</span><br><span class="line">    <span class="keyword">char</span> * mtdpart_def = <span class="literal">NULL</span>;</span><br><span class="line"><span class="meta">#<span class="meta-keyword">if</span> (defined CONFIG_SC8810) || (defined CONFIG_SC8825)</span></span><br><span class="line">    MMU_Init(CONFIG_MMU_TABLE_ADDR);</span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line">    ret = mtdparts_init();</span><br><span class="line">    <span class="keyword">if</span> (ret != <span class="number">0</span>)&#123;</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">"mtdparts init error %d\n"</span>, ret);</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">ifdef</span> CONFIG_SPLASH_SCREEN</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> SPLASH_PART <span class="string">"boot_logo"</span></span></span><br><span class="line">    ret = find_dev_and_part(SPLASH_PART, &amp;dev, &amp;pnum, &amp;part);</span><br><span class="line">    <span class="keyword">if</span>(ret)&#123;</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">"No partition named %s\n"</span>, SPLASH_PART);</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">    &#125;<span class="keyword">else</span> <span class="keyword">if</span>(dev-&gt;id-&gt;type != MTD_DEV_TYPE_NAND)&#123;</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">"Partition %s not a NAND device\n"</span>, SPLASH_PART);</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">//读取下载到nand中的boot_logo，就是开机亮的那一屏</span></span><br><span class="line">    off=part-&gt;offset;</span><br><span class="line">    nand = &amp;nand_info[dev-&gt;id-&gt;num];</span><br><span class="line">    <span class="comment">//read boot image header</span></span><br><span class="line">    size = <span class="number">1</span>&lt;&lt;<span class="number">19</span>;<span class="comment">//where the size come from????//和dowload工具中的地址一致</span></span><br><span class="line">    <span class="keyword">char</span> * bmp_img = <span class="built_in">malloc</span>(size);</span><br><span class="line">    <span class="keyword">if</span>(!bmp_img)&#123;</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">"not enough memory for splash image\n"</span>);</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    ret = nand_read_offset_ret(nand, off, &amp;size, (<span class="keyword">void</span> *)bmp_img, &amp;off);</span><br><span class="line">    <span class="keyword">if</span>(ret != <span class="number">0</span>)&#123;</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">"function: %s nand read error %d\n"</span>, __FUNCTION__, ret);</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">//第一次LCD logo</span></span><br><span class="line">    lcd_display_logo(backlight_set,(ulong)bmp_img,size);</span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line">    set_vibrator(<span class="number">0</span>);<span class="comment">//停止震动，如果发现开机狂震不止，那就是没走到这里。</span></span><br><span class="line">    &#123;</span><br><span class="line">        nand_block_info(nand, &amp;good_blknum, &amp;bad_blknum);</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">"good is %d  bad is %d\n"</span>, good_blknum, bad_blknum);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    ret = load_sector_to_memory(fixnvpoint,</span><br><span class="line">            fixnvfilename2,</span><br><span class="line">            fixnvfilename,</span><br><span class="line">            (<span class="keyword">unsigned</span> <span class="keyword">char</span> *)FIXNV_ADR,</span><br><span class="line">            (<span class="keyword">unsigned</span> <span class="keyword">char</span> *)MODEM_ADR,</span><br><span class="line">            FIXNV_SIZE + <span class="number">4</span>);</span><br><span class="line">......</span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">elif</span> defined(CONFIG_CALIBRATION_MODE_NEW)</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">if</span> defined(CONFIG_SP7702) || defined(CONFIG_SP8810W)</span></span><br><span class="line">    <span class="comment">/*</span><br><span class="line">       force dsp sleep in native 8810 verson to reduce power consumption</span><br><span class="line">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">extern</span> <span class="keyword">void</span> <span class="title">DSP_ForceSleep</span><span class="params">(<span class="keyword">void</span>)</span></span>;</span><br><span class="line">    DSP_ForceSleep();</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">"dsp nand read ok1 %d\n"</span>, ret);</span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">ifdef</span> CONFIG_SC7710G2</span></span><br><span class="line">    ret = try_update_spl();</span><br><span class="line">    <span class="keyword">if</span>(ret == <span class="number">-1</span>)&#123;</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">"try update spl faild!\n"</span>);</span><br><span class="line">        <span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    ret =  try_load_fixnv();</span><br><span class="line">    <span class="keyword">if</span>(ret == <span class="number">-1</span>)&#123;</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">"try load fixnv faild!\n"</span>);</span><br><span class="line">        <span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    ret =  try_load_runtimenv();</span><br><span class="line">    <span class="keyword">if</span>(ret == <span class="number">-1</span>)&#123;</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">"try load runtimenv faild!\n"</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    ret =  try_load_productinfo();</span><br><span class="line">    <span class="keyword">if</span>(ret == <span class="number">-1</span>)&#123;</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">"try load productinfo faild!\n"</span>);</span><br><span class="line">    &#125;</span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line">    <span class="keyword">if</span>(poweron_by_calibration())</span><br><span class="line">    &#123;</span><br><span class="line"><span class="meta">#<span class="meta-keyword">ifndef</span> CONFIG_SC7710G2</span></span><br><span class="line">        <span class="comment">// ---------------------fix nv--------------------------------</span></span><br><span class="line"></span><br><span class="line">......</span><br><span class="line"></span><br><span class="line">        <span class="comment">// ---------------------runtime nv----------------------------</span></span><br><span class="line">......</span><br><span class="line">        <span class="comment">// ---------------------DSP ----------------------------</span></span><br><span class="line">......</span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line">    <span class="comment">////////////////////////////////////////////////////////////////</span></span><br><span class="line">    <span class="comment">/* KERNEL_PART */</span></span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">"Reading kernel to 0x%08x\n"</span>, KERNEL_ADR);</span><br><span class="line"></span><br><span class="line">    ret = find_dev_and_part(kernel_pname, &amp;dev, &amp;pnum, &amp;part);</span><br><span class="line">    <span class="keyword">if</span>(ret)&#123;</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">"No partition named %s\n"</span>, kernel_pname);</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">    &#125;<span class="keyword">else</span> <span class="keyword">if</span>(dev-&gt;id-&gt;type != MTD_DEV_TYPE_NAND)&#123;</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">"Partition %s not a NAND device\n"</span>, kernel_pname);</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    off=part-&gt;offset;</span><br><span class="line">    nand = &amp;nand_info[dev-&gt;id-&gt;num];</span><br><span class="line">    <span class="comment">//read boot image header</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">if</span> 0</span></span><br><span class="line">    size = nand-&gt;writesize;</span><br><span class="line">    flash_page_size = nand-&gt;writesize;</span><br><span class="line">    ret = nand_read_offset_ret(nand, off, &amp;size, (<span class="keyword">void</span> *)hdr, &amp;off);</span><br><span class="line">    <span class="keyword">if</span>(ret != <span class="number">0</span>)&#123;</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">"function: %s nand read error %d\n"</span>, __FUNCTION__, ret);</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span>(<span class="built_in">memcmp</span>(hdr-&gt;magic, BOOT_MAGIC, BOOT_MAGIC_SIZE))&#123;</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">"bad boot image header, give up read!!!!\n"</span>);</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">else</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="comment">//read kernel image</span></span><br><span class="line">        size = (hdr-&gt;kernel_size+(flash_page_size - <span class="number">1</span>)) &amp; (~(flash_page_size - <span class="number">1</span>));</span><br><span class="line">        <span class="keyword">if</span>(size &lt;=<span class="number">0</span>)&#123;</span><br><span class="line">            <span class="built_in">printf</span>(<span class="string">"kernel image should not be zero\n"</span>);</span><br><span class="line">            <span class="keyword">return</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        ret = nand_read_offset_ret(nand, off, &amp;size, (<span class="keyword">void</span> *)KERNEL_ADR, &amp;off);</span><br><span class="line">        <span class="keyword">if</span>(ret != <span class="number">0</span>)&#123;</span><br><span class="line">            <span class="built_in">printf</span>(<span class="string">"kernel nand read error %d\n"</span>, ret);</span><br><span class="line">            <span class="keyword">return</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">//read ramdisk image</span></span><br><span class="line">        size = (hdr-&gt;ramdisk_size+(flash_page_size - <span class="number">1</span>)) &amp; (~(flash_page_size - <span class="number">1</span>));</span><br><span class="line">        <span class="keyword">if</span>(size&lt;<span class="number">0</span>)&#123;</span><br><span class="line">            <span class="built_in">printf</span>(<span class="string">"ramdisk size error\n"</span>);</span><br><span class="line">            <span class="keyword">return</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        ret = nand_read_offset_ret(nand, off, &amp;size, (<span class="keyword">void</span> *)RAMDISK_ADR, &amp;off);</span><br><span class="line">        <span class="keyword">if</span>(ret != <span class="number">0</span>)&#123;</span><br><span class="line">            <span class="built_in">printf</span>(<span class="string">"ramdisk nand read error %d\n"</span>, ret);</span><br><span class="line">            <span class="keyword">return</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"><span class="meta">#<span class="meta-keyword">else</span></span></span><br><span class="line"></span><br><span class="line">    ret = load_kernel_and_layout(nand,</span><br><span class="line">            (<span class="keyword">unsigned</span> <span class="keyword">int</span>)off,</span><br><span class="line">            (<span class="keyword">char</span> *)raw_header,</span><br><span class="line">            (<span class="keyword">char</span> *) KERNEL_ADR,</span><br><span class="line">            (<span class="keyword">char</span> *) RAMDISK_ADR,</span><br><span class="line">            <span class="number">2048</span>,</span><br><span class="line">            nand-&gt;writesize);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (ret != <span class="number">0</span>) &#123;</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">"ramdisk nand read error %d\n"</span>, ret);</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line"></span><br><span class="line">......</span><br><span class="line"></span><br><span class="line">&#123;</span><br><span class="line"></span><br><span class="line">    good_blknum = <span class="number">0</span>;</span><br><span class="line">    bad_blknum  = <span class="number">0</span>;</span><br><span class="line">    nand_block_info(nand, &amp;good_blknum, &amp;bad_blknum);</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">"good is %d  bad is %d\n"</span>, good_blknum, bad_blknum);</span><br><span class="line">&#125;</span><br><span class="line">creat_cmdline(cmdline,hdr);</span><br><span class="line">vlx_entry();<span class="comment">//末尾进入entry()，其实现在normal_mode.c</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>该函数的重点在开头和结尾的相关操作，开头部分见注释，重点分析vlx_entry()函数，其实现在normal_mode.c：<br><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">vlx_entry</span><span class="params">()</span></span><br><span class="line"></span>&#123;</span><br><span class="line"><span class="meta">#<span class="meta-keyword">if</span> !(defined CONFIG_SC8810 || defined CONFIG_TIGER || defined CONFIG_SC8830)</span></span><br><span class="line">    MMU_InvalideICACHEALL();</span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">if</span> (defined CONFIG_SC8810) || (defined CONFIG_SC8825) || (defined CONFIG_SC8830)</span></span><br><span class="line">    MMU_DisableIDCM();</span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">ifdef</span> REBOOT_FUNCTION_INUBOOT</span></span><br><span class="line">    reboot_func();</span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">if</span> BOOT_NATIVE_LINUX</span></span><br><span class="line">    start_linux();</span><br><span class="line"><span class="meta">#<span class="meta-keyword">else</span></span></span><br><span class="line">    <span class="keyword">void</span> (*entry)(<span class="keyword">void</span>) = (<span class="keyword">void</span>*) VMJALUNA_ADR;</span><br><span class="line">    entry();</span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>这里的entry()跳转到VM虚拟机的首地址，start_linux()则是进入kernel的方法，仍在normal_mode.c中实现：<br><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">int</span> <span class="title">start_linux</span><span class="params">()</span></span><br><span class="line"></span>&#123;</span><br><span class="line">    <span class="keyword">void</span> (*theKernel)(<span class="keyword">int</span> zero, <span class="keyword">int</span> arch, u32 params);</span><br><span class="line">    u32 exec_at = (u32)<span class="number">-1</span>;</span><br><span class="line">    u32 parm_at = (u32)<span class="number">-1</span>;</span><br><span class="line">    u32 machine_type;</span><br><span class="line"></span><br><span class="line">    machine_type = machine_arch_type;         <span class="comment">/* get machine type */</span></span><br><span class="line">    <span class="comment">//重点根据KERNEL的地址</span></span><br><span class="line">    theKernel = (<span class="keyword">void</span> (*)(<span class="keyword">int</span>, <span class="keyword">int</span>, u32))KERNEL_ADR; <span class="comment">/* set the kernel address */</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">ifndef</span> CONFIG_SC8830</span></span><br><span class="line">    *(<span class="keyword">volatile</span> u32*)<span class="number">0x84001000</span> = <span class="string">'j'</span>;</span><br><span class="line">    *(<span class="keyword">volatile</span> u32*)<span class="number">0x84001000</span> = <span class="string">'m'</span>;</span><br><span class="line">    *(<span class="keyword">volatile</span> u32*)<span class="number">0x84001000</span> = <span class="string">'p'</span>;</span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line">    <span class="comment">//根据Kernel的地址</span></span><br><span class="line">    theKernel(<span class="number">0</span>, machine_type, VLX_TAG_ADDR);    <span class="comment">/* jump to kernel with register set */</span></span><br><span class="line">    <span class="keyword">while</span>(<span class="number">1</span>);</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>这里就最终来到linux kernel的位置，linux内核编译完成后会产生zImage文件，在android中，zImage和ramdisk.img一起合成了boot.img，boot.img还加入的特殊的head用来标识。ramdisk是linux内核启动过程中需要使用的一种临时文件系统，它要么单独编译成ramdisk.img(也有叫initrd或者initramfs)，要么编译进内核。zImage是经过了高压缩之后在和解压缩程序合并在一起生成的，所以在进入linux kernel后首先执行的是zImage解压缩阶段，然后是汇编启动阶段，最后才是c启动阶段。前两个阶段过程比较复杂，感兴趣的读者可以自行阅读相关文章，我们这里从c的启动阶段开始。<br>从Kernel\init\main.c的start_kernel()，即来到了linux的世界。</p>
<h3 id="LinuxKernel"><a href="#LinuxKernel" class="headerlink" title="LinuxKernel"></a>LinuxKernel</h3><p>Kernel\init\main.c的start_kernel()的kernel的起点，先看这个函数：</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br></pre></td><td class="code"><pre><span class="line"> asmlinkage <span class="keyword">void</span> __<span class="function">init <span class="title">start_kernel</span><span class="params">(<span class="keyword">void</span>)</span></span><br><span class="line"></span>&#123;</span><br><span class="line">    <span class="keyword">char</span> * command_line;</span><br><span class="line">    <span class="keyword">extern</span> <span class="keyword">const</span> <span class="keyword">struct</span> kernel_param __start___param[], __stop___param[];</span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">ifdef</span> CONFIG_NKERNEL</span></span><br><span class="line">    jiffies_64 = INITIAL_JIFFIES;</span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line">    smp_setup_processor_id();</span><br><span class="line"></span><br><span class="line">    <span class="comment">/*</span><br><span class="line">     * Need to run as early as possible, to initialize the</span><br><span class="line">     * lockdep hash:</span><br><span class="line">     */</span></span><br><span class="line">    lockdep_init();</span><br><span class="line">    debug_objects_early_init();</span><br><span class="line"></span><br><span class="line">    <span class="comment">/*</span><br><span class="line">     * Set up the the initial canary ASAP:</span><br><span class="line">     */</span></span><br><span class="line">    boot_init_stack_canary();</span><br><span class="line"></span><br><span class="line">    cgroup_init_early();</span><br><span class="line"></span><br><span class="line">    local_irq_disable();</span><br><span class="line">    early_boot_irqs_disabled = <span class="literal">true</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">/*</span><br><span class="line"> * Interrupts are still disabled. Do necessary setups, then</span><br><span class="line"> * enable them</span><br><span class="line"> */</span></span><br><span class="line">    tick_init();</span><br><span class="line">    boot_cpu_init();</span><br><span class="line">    page_address_init();</span><br><span class="line">    printk(KERN_NOTICE <span class="string">"%s"</span>, linux_banner); <span class="comment">//打印内核的一些信息，版本，作者，编译器版本，日期等信息。</span></span><br><span class="line">    setup_arch(&amp;command_line);         <span class="comment">//重要的函数</span></span><br><span class="line">    mm_init_owner(&amp;init_mm, &amp;init_task);</span><br><span class="line">    mm_init_cpumask(&amp;init_mm);</span><br><span class="line">    setup_command_line(command_line);</span><br><span class="line">    setup_nr_cpu_ids();</span><br><span class="line">    setup_per_cpu_areas();</span><br><span class="line">    smp_prepare_boot_cpu();	<span class="comment">/* arch-specific boot-cpu hooks */</span></span><br><span class="line"></span><br><span class="line">    build_all_zonelists(<span class="literal">NULL</span>);  <span class="comment">//建立系统内存页区(zone)链表</span></span><br><span class="line">    page_alloc_init();</span><br><span class="line"></span><br><span class="line">    printk(KERN_NOTICE <span class="string">"Kernel command line: %s\n"</span>, boot_command_line); <span class="comment">//打印出从uboot传递过来的command_line字符串，在setup_arch函数中获得的。</span></span><br><span class="line">    parse_early_param();</span><br><span class="line">    parse_args(<span class="string">"Booting kernel"</span>, static_command_line, __start___param,</span><br><span class="line">           __stop___param - __start___param,</span><br><span class="line">           &amp;unknown_bootoption);    <span class="comment">//解析参数</span></span><br><span class="line">    <span class="comment">/*</span><br><span class="line">     * These use large bootmem allocations and must precede</span><br><span class="line">     * kmem_cache_init()</span><br><span class="line">     */</span></span><br><span class="line">    setup_log_buf(<span class="number">0</span>);</span><br><span class="line">    pidhash_init();</span><br><span class="line">    vfs_caches_init_early();</span><br><span class="line">    sort_main_extable();</span><br><span class="line">    trap_init();</span><br><span class="line">    mm_init();</span><br><span class="line"></span><br><span class="line">    <span class="comment">/*</span><br><span class="line">     * Set up the scheduler prior starting any interrupts (such as the</span><br><span class="line">     * timer interrupt). Full topology setup happens at smp_init()</span><br><span class="line">     * time - but meanwhile we still have a functioning scheduler.</span><br><span class="line">     */</span></span><br><span class="line">    sched_init();   <span class="comment">//初始化每个处理器的可运行队列，设置系统初始化进程即0号进程。</span></span><br><span class="line">    <span class="comment">/*</span><br><span class="line">     * Disable preemption - early bootup scheduling is extremely</span><br><span class="line">     * fragile until we cpu_idle() for the first time.</span><br><span class="line">     */</span></span><br><span class="line">    preempt_disable();</span><br><span class="line">    <span class="keyword">if</span> (!irqs_disabled()) &#123;</span><br><span class="line">        printk(KERN_WARNING <span class="string">"start_kernel(): bug: interrupts were "</span></span><br><span class="line">                <span class="string">"enabled *very* early, fixing it\n"</span>);</span><br><span class="line">        local_irq_disable();</span><br><span class="line">    &#125;</span><br><span class="line">    idr_init_cache();</span><br><span class="line">    perf_event_init();</span><br><span class="line">    rcu_init();</span><br><span class="line">    radix_tree_init();</span><br><span class="line">    <span class="comment">/* init some links before init_ISA_irqs() */</span></span><br><span class="line">    early_irq_init();   </span><br><span class="line">    init_IRQ(); <span class="comment">//初始化系统中所有的中断描述结构数组：irq_desc[NR_IRQS]。</span></span><br><span class="line">    prio_tree_init();</span><br><span class="line">    init_timers();</span><br><span class="line">    hrtimers_init();    </span><br><span class="line">    softirq_init();     <span class="comment">//内核的软中断机制初始化函数。</span></span><br><span class="line">    timekeeping_init();</span><br><span class="line">    time_init();</span><br><span class="line">    profile_init();</span><br><span class="line">    call_function_init();</span><br><span class="line">    <span class="keyword">if</span> (!irqs_disabled())</span><br><span class="line">        printk(KERN_CRIT <span class="string">"start_kernel(): bug: interrupts were "</span></span><br><span class="line">                 <span class="string">"enabled early\n"</span>);</span><br><span class="line">    early_boot_irqs_disabled = <span class="literal">false</span>;</span><br><span class="line">    local_irq_enable();</span><br><span class="line"></span><br><span class="line">    <span class="comment">/* Interrupts are enabled now so all GFP allocations are safe. */</span></span><br><span class="line">    gfp_allowed_mask = __GFP_BITS_MASK;</span><br><span class="line"></span><br><span class="line">    kmem_cache_init_late();</span><br><span class="line"></span><br><span class="line">    <span class="comment">/*</span><br><span class="line">     * HACK ALERT! This is early. We're enabling the console before</span><br><span class="line">     * we've done PCI setups etc, and console_init() must be aware of</span><br><span class="line">     * this. But we do want output early, in case something goes wrong.</span><br><span class="line">     */</span></span><br><span class="line">    console_init(); <span class="comment">//初始化系统的控制台结构，该函数执行后调用printk函数将log_buf中所有符合打印级别的系统信息打印到控制台上。</span></span><br><span class="line">    <span class="keyword">if</span> (panic_later)</span><br><span class="line">        panic(panic_later, panic_param);</span><br><span class="line"></span><br><span class="line">    lockdep_info();</span><br><span class="line"></span><br><span class="line">    <span class="comment">/*</span><br><span class="line">     * Need to run this when irqs are enabled, because it wants</span><br><span class="line">     * to self-test [hard/soft]-irqs on/off lock inversion bugs</span><br><span class="line">     * too:</span><br><span class="line">     */</span></span><br><span class="line">    locking_selftest();</span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">ifdef</span> CONFIG_BLK_DEV_INITRD</span></span><br><span class="line">    <span class="keyword">if</span> (initrd_start &amp;&amp; !initrd_below_start_ok &amp;&amp;</span><br><span class="line">        page_to_pfn(virt_to_page((<span class="keyword">void</span> *)initrd_start)) &lt; min_low_pfn) &#123;</span><br><span class="line">        printk(KERN_CRIT <span class="string">"initrd overwritten (0x%08lx &lt; 0x%08lx) - "</span></span><br><span class="line">            <span class="string">"disabling it.\n"</span>,</span><br><span class="line">            page_to_pfn(virt_to_page((<span class="keyword">void</span> *)initrd_start)),</span><br><span class="line">            min_low_pfn);</span><br><span class="line">        initrd_start = <span class="number">0</span>;</span><br><span class="line">    &#125;</span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line">    page_cgroup_init();</span><br><span class="line">    enable_debug_pagealloc();</span><br><span class="line">    debug_objects_mem_init();</span><br><span class="line">    kmemleak_init();</span><br><span class="line">    setup_per_cpu_pageset();</span><br><span class="line">    numa_policy_init();</span><br><span class="line">    <span class="keyword">if</span> (late_time_init)</span><br><span class="line">        late_time_init();</span><br><span class="line">    sched_clock_init();</span><br><span class="line">    calibrate_delay();</span><br><span class="line">    pidmap_init();</span><br><span class="line">    anon_vma_init();</span><br><span class="line"><span class="meta">#<span class="meta-keyword">ifdef</span> CONFIG_X86</span></span><br><span class="line">    <span class="keyword">if</span> (efi_enabled)</span><br><span class="line">        efi_enter_virtual_mode();</span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line">    thread_info_cache_init();</span><br><span class="line">    cred_init();</span><br><span class="line">    fork_init(totalram_pages);</span><br><span class="line">    proc_caches_init();</span><br><span class="line">    buffer_init();</span><br><span class="line">    key_init();</span><br><span class="line">    security_init();</span><br><span class="line">    dbg_late_init();</span><br><span class="line">    vfs_caches_init(totalram_pages);</span><br><span class="line">    signals_init();</span><br><span class="line">    <span class="comment">/* rootfs populating might need page-writeback */</span></span><br><span class="line">    page_writeback_init();</span><br><span class="line"><span class="meta">#<span class="meta-keyword">ifdef</span> CONFIG_PROC_FS</span></span><br><span class="line">    proc_root_init();</span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line">    cgroup_init();</span><br><span class="line">    cpuset_init();</span><br><span class="line">    taskstats_init_early();</span><br><span class="line">    delayacct_init();</span><br><span class="line"></span><br><span class="line">    check_bugs();</span><br><span class="line"></span><br><span class="line">    acpi_early_init(); <span class="comment">/* before LAPIC and SMP init */</span></span><br><span class="line">    sfi_init_late();</span><br><span class="line"></span><br><span class="line">    ftrace_init();</span><br><span class="line"></span><br><span class="line">    <span class="comment">/* Do the rest non-__init'ed, we're now alive */</span></span><br><span class="line">    <span class="comment">//第一个跟init 进程相关的函数</span></span><br><span class="line">    rest_init();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<ul>
<li>调用setup_arch()函数进行与体系结构相关的第一个初始化工作。进行处理器内核的初始化，内存结构的初始化，开启 MMU，创建内核页表，映射所有的物理内存和IO空间，并挂载ramdisk。</li>
<li>创建异常向量表和初始化中断处理函数；</li>
<li>初始化系统核心进程调度器和时钟中断处理机制；</li>
<li>初始化串口控制台（serial-console），这样内核在启动过程中就可以通过串口输出信息以便开发者或用户了解系统的启动进程； </li>
<li>创建和初始化系统cache，为各种内存调用机制提供缓存，包括：动态内存分配，虚拟文件系统（Virtual File System）及页缓存。</li>
<li>初始化内存管理，检测内存大小及被内核占用的内存情况；</li>
<li>初始化系统的进程间通信机制（IPC）；</li>
</ul>
<p>setup_arch函数在Kernel\arch\alpha\kernel\setup.c：<br><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">setup_arch(<span class="keyword">char</span> **cmdline_p)</span><br><span class="line">&#123;</span><br><span class="line"> <span class="comment">//….</span></span><br><span class="line">         <span class="keyword">if</span>(<span class="built_in">strcmp</span>(COMMAND_LINE, <span class="string">"INSTALL"</span>) == <span class="number">0</span>) &#123;</span><br><span class="line">                   strlcpy(command_line,<span class="string">"root=/dev/fd0 load_ramdisk=1"</span>, <span class="keyword">sizeof</span> command_line);</span><br><span class="line">         &#125;<span class="keyword">else</span> &#123;</span><br><span class="line">                   strlcpy(command_line,COMMAND_LINE, <span class="keyword">sizeof</span> command_line);</span><br><span class="line">         &#125;</span><br><span class="line">         <span class="built_in">strcpy</span>(boot_command_line,command_line);</span><br><span class="line">         *cmdline_p= command_line;</span><br><span class="line"></span><br><span class="line"><span class="comment">//…..</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>摘录出的代码中的load_ramdisk=1，会调用到函数load_ramdisk。<br>Kernel\init\do_mounts.c：<br><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line">    __setup(<span class="string">"load_ramdisk="</span>,load_ramdisk);</span><br><span class="line">``` </span><br><span class="line">被__setup宏声明的函数会被放在init.setup节点，在系统起命令行到相关的字符串的时候会被调用，所以，当setup_arch走到这里的时候就回去挂载ramdisk。</span><br><span class="line">    </span><br><span class="line">跟启动相关的函数是rest_init() ，该函数是第一个跟init进程相关的函数，看其实现：</span><br><span class="line">```cpp</span><br><span class="line">    <span class="keyword">static</span> noinline <span class="keyword">void</span> __<span class="function">init_refok <span class="title">rest_init</span><span class="params">(<span class="keyword">void</span>)</span></span><br><span class="line">    </span>&#123;</span><br><span class="line">        <span class="keyword">int</span> pid;</span><br><span class="line"></span><br><span class="line">        rcu_scheduler_starting();</span><br><span class="line">        <span class="comment">/*</span><br><span class="line">         * We need to spawn init first so that it obtains pid 1, however</span><br><span class="line">         * the init task will end up wanting to create kthreads, which, if</span><br><span class="line">         * we schedule it before we create kthreadd, will OOPS.</span><br><span class="line">         */</span></span><br><span class="line">         <span class="comment">//启动kernel_init来进行接下来的初始化</span></span><br><span class="line">        kernel_thread(kernel_init, <span class="literal">NULL</span>, CLONE_FS | CLONE_SIGHAND);</span><br><span class="line">        numa_default_policy();</span><br><span class="line">        pid = kernel_thread(kthreadd, <span class="literal">NULL</span>, CLONE_FS | CLONE_FILES);</span><br><span class="line">        rcu_read_lock();</span><br><span class="line">        kthreadd_task = find_task_by_pid_ns(pid, &amp;init_pid_ns);</span><br><span class="line">        rcu_read_unlock();</span><br><span class="line">        complete(&amp;kthreadd_done);</span><br><span class="line"></span><br><span class="line">        <span class="comment">/*</span><br><span class="line">         * The boot idle thread must execute schedule()</span><br><span class="line">         * at least once to get things moving:</span><br><span class="line">         */</span></span><br><span class="line">        init_idle_bootup_task(current);</span><br><span class="line">        preempt_enable_no_resched();</span><br><span class="line">        schedule();</span><br><span class="line">        preempt_disable();</span><br><span class="line"></span><br><span class="line">        <span class="comment">/* Call into cpu_idle with preempt disabled */</span></span><br><span class="line">        cpu_idle();<span class="comment">//将系统交给调度器处理。</span></span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure></p>
<p>该函数启动了kernel_init来进行后续的初始化，进而看kernel_init()，这些函数任然在main.c中实现。<br><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">static</span> <span class="keyword">int</span> __<span class="function">init <span class="title">kernel_init</span><span class="params">(<span class="keyword">void</span> * unused)</span></span><br><span class="line"></span>&#123;</span><br><span class="line">    <span class="comment">/*</span><br><span class="line">     * Wait until kthreadd is all set-up.</span><br><span class="line">     */</span></span><br><span class="line">    wait_for_completion(&amp;kthreadd_done);</span><br><span class="line">    <span class="comment">/*</span><br><span class="line">     * init can allocate pages on any node</span><br><span class="line">     */</span></span><br><span class="line">    set_mems_allowed(node_states[N_HIGH_MEMORY]);</span><br><span class="line">    <span class="comment">/*</span><br><span class="line">     * init can run on any cpu.</span><br><span class="line">     */</span></span><br><span class="line">    set_cpus_allowed_ptr(current, cpu_all_mask);</span><br><span class="line"></span><br><span class="line">    cad_pid = task_pid(current);</span><br><span class="line"></span><br><span class="line">    smp_prepare_cpus(setup_max_cpus);</span><br><span class="line"></span><br><span class="line">    do_pre_smp_initcalls();</span><br><span class="line">    lockup_detector_init();</span><br><span class="line"></span><br><span class="line">    smp_init();</span><br><span class="line">    sched_init_smp();</span><br><span class="line">    <span class="comment">//此函数中会调用各个驱动模块的加载函数（静态编译的，非ko）来初始化设备</span></span><br><span class="line">    do_basic_setup();</span><br><span class="line"></span><br><span class="line">    <span class="comment">/* Open the /dev/console on the rootfs, this should never fail */</span></span><br><span class="line">    <span class="keyword">if</span> (sys_open((<span class="keyword">const</span> <span class="keyword">char</span> __user *) <span class="string">"/dev/console"</span>, O_RDWR, <span class="number">0</span>) &lt; <span class="number">0</span>)</span><br><span class="line">        printk(KERN_WARNING <span class="string">"Warning: unable to open an initial console.\n"</span>);</span><br><span class="line"></span><br><span class="line">    (<span class="keyword">void</span>) sys_dup(<span class="number">0</span>);</span><br><span class="line">    (<span class="keyword">void</span>) sys_dup(<span class="number">0</span>);</span><br><span class="line">    <span class="comment">/*</span><br><span class="line">     * check if there is an early userspace init.  If yes, let it do all</span><br><span class="line">     * the work</span><br><span class="line">     */</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">//这里的ramdisk就是android编译出来的ramdisk，这个目录下有一个init可执行程序，下面就准备启动它。</span></span><br><span class="line">    </span><br><span class="line">    <span class="keyword">if</span> (!ramdisk_execute_command)</span><br><span class="line">        ramdisk_execute_command = <span class="string">"/init"</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (sys_access((<span class="keyword">const</span> <span class="keyword">char</span> __user *) ramdisk_execute_command, <span class="number">0</span>) != <span class="number">0</span>) &#123;</span><br><span class="line">        ramdisk_execute_command = <span class="literal">NULL</span>;</span><br><span class="line">        prepare_namespace();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/*</span><br><span class="line">     * Ok, we have completed the initial bootup, and</span><br><span class="line">     * we're essentially up and running. Get rid of the</span><br><span class="line">     * initmem segments and start the user-mode stuff..</span><br><span class="line">     */</span></span><br><span class="line">    <span class="comment">//走至init 进程的相关操作</span></span><br><span class="line">    init_post();</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>接着调用init_post()函数，来打开console设备，这个时候控制台就可以操作了，最后会执行以下代码来寻找和启动init程序：<br><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">static</span> noinline <span class="keyword">int</span> <span class="title">init_post</span><span class="params">(<span class="keyword">void</span>)</span></span><br><span class="line"></span>&#123;</span><br><span class="line">    <span class="comment">/* need to finish all async __init code before freeing the memory */</span></span><br><span class="line">    async_synchronize_full();</span><br><span class="line">    free_initmem();</span><br><span class="line">    mark_rodata_ro();</span><br><span class="line">    system_state = SYSTEM_RUNNING;</span><br><span class="line">    numa_default_policy();</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    current-&gt;signal-&gt;flags |= SIGNAL_UNKILLABLE;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (ramdisk_execute_command) &#123;</span><br><span class="line">        run_init_process(ramdisk_execute_command);</span><br><span class="line">        printk(KERN_WARNING <span class="string">"Failed to execute %s\n"</span>,</span><br><span class="line">                ramdisk_execute_command);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/*</span><br><span class="line">     * We try each of these until one succeeds.</span><br><span class="line">     *</span><br><span class="line">     * The Bourne shell can be used instead of init if we are</span><br><span class="line">     * trying to recover a really broken machine.</span><br><span class="line">     */</span></span><br><span class="line">    <span class="keyword">if</span> (execute_command) &#123;</span><br><span class="line">        <span class="comment">//至此init启动完成，接下来的启动就是System\core\init\init.c的main()</span></span><br><span class="line">        run_init_process(execute_command);</span><br><span class="line">        printk(KERN_WARNING <span class="string">"Failed to execute %s.  Attempting "</span></span><br><span class="line">                    <span class="string">"defaults...\n"</span>, execute_command);</span><br><span class="line">    &#125;</span><br><span class="line">    run_init_process(<span class="string">"/sbin/init"</span>);</span><br><span class="line">    run_init_process(<span class="string">"/etc/init"</span>);</span><br><span class="line">    run_init_process(<span class="string">"/bin/init"</span>);</span><br><span class="line">    run_init_process(<span class="string">"/bin/sh"</span>);</span><br><span class="line"></span><br><span class="line">    panic(<span class="string">"No init found.  Try passing init= option to kernel. "</span></span><br><span class="line">          <span class="string">"See Linux Documentation/init.txt for guidance."</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<h3 id="Android-Init"><a href="#Android-Init" class="headerlink" title="Android Init"></a>Android Init</h3><p>init进程是linux起来之后启动的第一个用户进程，android系统也就是在这个进程的基础上启动的。进程号是1。其最重要的职责是创建了Zygote以及提供了systemserver。system\core\init\init.c的入口函数是main()。</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">(<span class="keyword">int</span> argc, <span class="keyword">char</span> **argv)</span></span><br><span class="line"></span>&#123;</span><br><span class="line">    <span class="keyword">int</span> fd_count = <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">struct</span> pollfd ufds[<span class="number">4</span>];</span><br><span class="line">    <span class="keyword">char</span> *tmpdev;</span><br><span class="line">    <span class="keyword">char</span>* debuggable;</span><br><span class="line">    <span class="keyword">char</span> tmp[<span class="number">32</span>];</span><br><span class="line">    <span class="keyword">int</span> property_set_fd_init = <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">int</span> signal_fd_init = <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">int</span> keychord_fd_init = <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">bool</span> is_charger = <span class="literal">false</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (!<span class="built_in">strcmp</span>(basename(argv[<span class="number">0</span>]), <span class="string">"ueventd"</span>))</span><br><span class="line">        <span class="keyword">return</span> ueventd_main(argc, argv);</span><br><span class="line"></span><br><span class="line">    <span class="comment">/* clear the umask */</span></span><br><span class="line">    umask(<span class="number">0</span>);</span><br><span class="line"></span><br><span class="line">        <span class="comment">/* Get the basic filesystem setup we need put</span><br><span class="line">         * together in the initramdisk on / and then we'll</span><br><span class="line">         * let the rc file figure out the rest.</span><br><span class="line">         */</span></span><br><span class="line">    <span class="comment">//创建一些文件夹，并挂载设备，这些是与linux相关的</span></span><br><span class="line">    mkdir(<span class="string">"/dev"</span>, <span class="number">0755</span>);</span><br><span class="line">    mkdir(<span class="string">"/proc"</span>, <span class="number">0755</span>);</span><br><span class="line">    mkdir(<span class="string">"/sys"</span>, <span class="number">0755</span>);</span><br><span class="line"></span><br><span class="line">    mount(<span class="string">"tmpfs"</span>, <span class="string">"/dev"</span>, <span class="string">"tmpfs"</span>, MS_NOSUID, <span class="string">"mode=0755"</span>);</span><br><span class="line">    mkdir(<span class="string">"/dev/pts"</span>, <span class="number">0755</span>);</span><br><span class="line">    mkdir(<span class="string">"/dev/socket"</span>, <span class="number">0755</span>);</span><br><span class="line">    mount(<span class="string">"devpts"</span>, <span class="string">"/dev/pts"</span>, <span class="string">"devpts"</span>, <span class="number">0</span>, <span class="literal">NULL</span>);</span><br><span class="line">    mount(<span class="string">"proc"</span>, <span class="string">"/proc"</span>, <span class="string">"proc"</span>, <span class="number">0</span>, <span class="literal">NULL</span>);</span><br><span class="line">    mount(<span class="string">"sysfs"</span>, <span class="string">"/sys"</span>, <span class="string">"sysfs"</span>, <span class="number">0</span>, <span class="literal">NULL</span>);</span><br><span class="line"></span><br><span class="line">        <span class="comment">/* indicate that booting is in progress to background fw loaders, etc */</span></span><br><span class="line">    close(open(<span class="string">"/dev/.booting"</span>, O_WRONLY | O_CREAT, <span class="number">0000</span>));</span><br><span class="line"></span><br><span class="line">        <span class="comment">/* We must have some place other than / to create the</span><br><span class="line">         * device nodes for kmsg and null, otherwise we won't</span><br><span class="line">         * be able to remount / read-only later on.</span><br><span class="line">         * Now that tmpfs is mounted on /dev, we can actually</span><br><span class="line">         * talk to the outside world.</span><br><span class="line">         */</span></span><br><span class="line">    <span class="comment">//重定向标准输入输出 错误输出到/dev/_null_</span></span><br><span class="line">    open_devnull_stdio();</span><br><span class="line">    <span class="comment">//设置init的日志输出设备为/dev/_kmsg_,不过该文件打开后</span></span><br><span class="line">    <span class="comment">//会立刻被unlink,这样其他进程就无法打开这个文件读取日志信息</span></span><br><span class="line">    klog_init();</span><br><span class="line">    <span class="comment">//prop配置文件的解析与初始化操作，如//设置"/default.prop"属性文件</span></span><br><span class="line">    property_init();</span><br><span class="line">    <span class="comment">//通过读取proc/cpuinfo得到机器的hardware名</span></span><br><span class="line">    get_hardware_name(hardware, &amp;revision);</span><br><span class="line"></span><br><span class="line">    process_kernel_cmdline();</span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">ifdef</span> HAVE_SELINUX</span></span><br><span class="line">    INFO(<span class="string">"loading selinux policy\n"</span>);</span><br><span class="line">    selinux_load_policy();</span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line"></span><br><span class="line">    is_charger = !<span class="built_in">strcmp</span>(bootmode, <span class="string">"charger"</span>);</span><br><span class="line"></span><br><span class="line">    INFO(<span class="string">"property init\n"</span>);</span><br><span class="line">    <span class="keyword">if</span> (!is_charger)</span><br><span class="line">        property_load_boot_defaults();</span><br><span class="line"></span><br><span class="line">    INFO(<span class="string">"reading config file\n"</span>);</span><br><span class="line">    <span class="comment">//解析init.rc配置文件 非常重要，文件系统的挂载，权限设置</span></span><br><span class="line">    <span class="comment">//以及系统server的启动,包括Zygote的创建</span></span><br><span class="line">    init_parse_config_file(<span class="string">"/init.rc"</span>);</span><br><span class="line">     <span class="comment">/**</span><br><span class="line">        **解析完init.rc 会得到一系列的action动作</span><br><span class="line">        **keychord_init_action和console_init_action</span><br><span class="line">        **/</span></span><br><span class="line">    action_for_each_trigger(<span class="string">"early-init"</span>, action_add_queue_tail);</span><br><span class="line"></span><br><span class="line">    queue_builtin_action(wait_for_coldboot_done_action, <span class="string">"wait_for_coldboot_done"</span>);</span><br><span class="line">    queue_builtin_action(keychord_init_action, <span class="string">"keychord_init"</span>);</span><br><span class="line">    <span class="comment">//console_init_action为控制台初始化，此处会加载一帧boot logo文件为initlogo.rle</span></span><br><span class="line">    queue_builtin_action(console_init_action, <span class="string">"console_init"</span>);</span><br><span class="line"></span><br><span class="line">    <span class="comment">/* execute all the boot actions to get us started */</span></span><br><span class="line">    action_for_each_trigger(<span class="string">"init"</span>, action_add_queue_tail);</span><br><span class="line"></span><br><span class="line">    <span class="comment">/* skip mounting filesystems in charger mode */</span></span><br><span class="line"></span><br><span class="line">    action_for_each_trigger(<span class="string">"early-fs"</span>, action_add_queue_tail);</span><br><span class="line">    <span class="comment">//action_for_each_trigger("fs", action_add_queue_tail);</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">bool</span> has_3partions = <span class="literal">false</span>;</span><br><span class="line"></span><br><span class="line">        has_3partions = (!access(<span class="string">"/sys/block/mmcblk0/mmcblk0p3"</span>,R_OK))</span><br><span class="line">            &amp;&amp; (!access(<span class="string">"/sys/block/mmcblk0/mmcblk0p2"</span>,R_OK))</span><br><span class="line">            &amp;&amp; (!access(<span class="string">"/sys/block/mmcblk0/mmcblk0p1"</span>,R_OK));</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (has_3partions) &#123;</span><br><span class="line">            action_for_each_trigger(<span class="string">"fs-two"</span>, action_add_queue_tail);</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            action_for_each_trigger(<span class="string">"fs"</span>, action_add_queue_tail);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    action_for_each_trigger(<span class="string">"post-fs"</span>, action_add_queue_tail);</span><br><span class="line">    <span class="keyword">if</span> (!is_charger) &#123;</span><br><span class="line">        <span class="comment">//action_for_each_trigger("post-fs", action_add_queue_tail);</span></span><br><span class="line">        action_for_each_trigger(<span class="string">"post-fs-data"</span>, action_add_queue_tail);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    queue_builtin_action(property_service_init_action, <span class="string">"property_service_init"</span>);</span><br><span class="line">    queue_builtin_action(signal_init_action, <span class="string">"signal_init"</span>);</span><br><span class="line">    queue_builtin_action(check_startup_action, <span class="string">"check_startup"</span>);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (!<span class="built_in">strcmp</span>(bootmode, <span class="string">"alarm"</span>)) &#123;</span><br><span class="line">        action_for_each_trigger(<span class="string">"alarm"</span>, action_add_queue_tail);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (is_charger) &#123;</span><br><span class="line">        action_for_each_trigger(<span class="string">"charger"</span>, action_add_queue_tail);</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        action_for_each_trigger(<span class="string">"early-boot"</span>, action_add_queue_tail);</span><br><span class="line">        action_for_each_trigger(<span class="string">"boot"</span>, action_add_queue_tail);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">/* run all property triggers based on current state of the properties */</span></span><br><span class="line">    queue_builtin_action(queue_property_triggers_action, <span class="string">"queue_property_triggers"</span>);</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">if</span> BOOTCHART</span></span><br><span class="line">    queue_builtin_action(bootchart_init_action, <span class="string">"bootchart_init"</span>);</span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span>(;;) &#123;<span class="comment">//无限循环启动进程</span></span><br><span class="line">        <span class="keyword">int</span> nr, i, timeout = <span class="number">-1</span>;</span><br><span class="line"></span><br><span class="line">        execute_one_command();<span class="comment">//再循环中执行动作</span></span><br><span class="line">        restart_processes();<span class="comment">//重启已经死去的进程</span></span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (!property_set_fd_init &amp;&amp; get_property_set_fd() &gt; <span class="number">0</span>) &#123;</span><br><span class="line">            ufds[fd_count].fd = get_property_set_fd();</span><br><span class="line">            ufds[fd_count].events = POLLIN;</span><br><span class="line">            ufds[fd_count].revents = <span class="number">0</span>;</span><br><span class="line">            fd_count++;</span><br><span class="line">            property_set_fd_init = <span class="number">1</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> (!signal_fd_init &amp;&amp; get_signal_fd() &gt; <span class="number">0</span>) &#123;</span><br><span class="line">            ufds[fd_count].fd = get_signal_fd();</span><br><span class="line">            ufds[fd_count].events = POLLIN;</span><br><span class="line">            ufds[fd_count].revents = <span class="number">0</span>;</span><br><span class="line">            fd_count++;</span><br><span class="line">            signal_fd_init = <span class="number">1</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> (!keychord_fd_init &amp;&amp; get_keychord_fd() &gt; <span class="number">0</span>) &#123;</span><br><span class="line">            ufds[fd_count].fd = get_keychord_fd();</span><br><span class="line">            ufds[fd_count].events = POLLIN;</span><br><span class="line">            ufds[fd_count].revents = <span class="number">0</span>;</span><br><span class="line">            fd_count++;</span><br><span class="line">            keychord_fd_init = <span class="number">1</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (process_needs_restart) &#123;</span><br><span class="line">            timeout = (process_needs_restart - gettime()) * <span class="number">1000</span>;</span><br><span class="line">            <span class="keyword">if</span> (timeout &lt; <span class="number">0</span>)</span><br><span class="line">                timeout = <span class="number">0</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (!action_queue_empty() || cur_action)</span><br><span class="line">            timeout = <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">if</span> BOOTCHART</span></span><br><span class="line">        <span class="keyword">if</span> (bootchart_count &gt; <span class="number">0</span>) &#123;</span><br><span class="line">            <span class="keyword">if</span> (timeout &lt; <span class="number">0</span> || timeout &gt; BOOTCHART_POLLING_MS)</span><br><span class="line">                timeout = BOOTCHART_POLLING_MS;</span><br><span class="line">            <span class="keyword">if</span> (bootchart_step() &lt; <span class="number">0</span> || --bootchart_count == <span class="number">0</span>) &#123;</span><br><span class="line">                bootchart_finish();</span><br><span class="line">                bootchart_count = <span class="number">0</span>;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line"></span><br><span class="line">        nr = poll(ufds, fd_count, timeout);</span><br><span class="line">        <span class="keyword">if</span> (nr &lt;= <span class="number">0</span>)</span><br><span class="line">            <span class="keyword">continue</span>;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">for</span> (i = <span class="number">0</span>; i &lt; fd_count; i++) &#123;</span><br><span class="line">            <span class="keyword">if</span> (ufds[i].revents == POLLIN) &#123;</span><br><span class="line">                <span class="keyword">if</span> (ufds[i].fd == get_property_set_fd())</span><br><span class="line">                    handle_property_set_fd();</span><br><span class="line">                <span class="keyword">else</span> <span class="keyword">if</span> (ufds[i].fd == get_keychord_fd())</span><br><span class="line">                    handle_keychord();</span><br><span class="line">                <span class="keyword">else</span> <span class="keyword">if</span> (ufds[i].fd == get_signal_fd())</span><br><span class="line">                    handle_signal();</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>从以上代码可知，init的工作任务还是很重的，上面的代码已经省略的不少，但任然很多，不过分析两个知识点来看，可将init的工作流程精简为四点：</p>
<ul>
<li>解析配置文件重点是init.rc。</li>
<li>执行各个阶段的动作，创建zygote的工作就在其中的某一个阶段完成。</li>
<li>调用property_init()初始化属性相关的资源，并且通过property_load_boot_defaults()启动属性服务。</li>
<li>init进入一个无限循环，并且等待一些事情的发生</li>
</ul>
<p>接下来重点看下解析配置文件的init.rc。解析函数：<br><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">init_parse_config_file</span><span class="params">(<span class="keyword">const</span> <span class="keyword">char</span> *fn)</span></span><br><span class="line"></span>&#123;</span><br><span class="line">    <span class="keyword">char</span> *data;</span><br><span class="line">    data = read_file(fn, <span class="number">0</span>);</span><br><span class="line">    <span class="keyword">if</span> (!data) <span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line"></span><br><span class="line">    parse_config(fn, data);</span><br><span class="line">    DUMP();</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>  再看init.rc文件，init.rc位于\system\core\rootdir，具体的说明文档在\system\core\init\readme.txt.：<br>    ……</p>
<pre><code>// service管理器 ---- &gt; servicemanager.cpp/ servicemanager.java
service servicemanager /system/bin/servicemanager  
    class core
    user system
    group system
    critical
    onrestart restart zygote ------ &gt; 启动zygote进程
    onrestart restart media ------ &gt; 启动media
    onrestart restart surfaceflinger------ &gt; 启动surfaceflinger
    onrestart restart drm------ &gt; 启动drm

service vold /system/bin/vold
    class core
    socket vold stream 0660 root mount
    ioprio be 2

service netd /system/bin/netd
    class main
    socket netd stream 0660 root system
    socket dnsproxyd stream 0660 root inet

service debuggerd /system/bin/debuggerd
    class main

service ril-daemon /system/bin/rild
    class main
    socket rild stream 660 root radio
    socket rild-debug stream 660 radio system
    user root
    group radio cache inet misc audio sdcard_rw log
// surfaceflinger服务
//对应surfaceflinger.cpp----- &gt;在system_server中具体实现
service surfaceflinger /system/bin/surfaceflinger
    class main
    user system
    group graphics
onrestart restart zygote

// zygote进程
//后面重点分析
service zygote /system/bin/app_process -Xzygote /system/bin --zygote --start-system-server
    class main
    socket zygote stream 666
    onrestart write /sys/android_power/request_state wake
    onrestart write /sys/power/state on
    onrestart restart media
onrestart restart netd

// drm服务
service drm /system/bin/drmserver
    class main
    user drm
group system inet drmrpc

// mediaserver服务
//在Main_mediaserver.cpp中实现，启动audio camera 等服务
service media /system/bin/mediaserver
    class main
    user media
    group audio camera inet net_bt net_bt_admin net_bw_acct drmrpc
    ioprio rt 4
//此处引导播放开机动画，并在surfaceflinger中具体实现
service bootanim /system/bin/bootanimation
    class main
    user graphics
    group graphics
    disabled
oneshot
......
</code></pre><p>在init中启动起来的服务按照init.rc中的先后顺序，大致有：</p>
<p>console: start a shell，code path: system/bin/sh,其源码中包含常用的shell命令，如ls，cd等。</p>
<p>adbd: start adb daemon,通常带有disabled的选项，表明需要按名字启动，code path：system/bin/adb。</p>
<p>servicemanager：这个服务管理着系统内所有binder services。code path: frameworks/base/cmds/servicemanager。</p>
<p>Vold: android 的udev，code path: system/vold。</p>
<p>Netd: start ntd daemon, code path: system/netd。</p>
<p>Debuggerd: start debug system, code path: system/core/debuggerd。</p>
<p>zygote: [‘zaigəut]这是一个非常重要的服务——zygnote也是一个服务，稍后详解。</p>
<p>start Android  Java Runtime  and start systemserver。code path：frameworks/base/cmds/app_process。</p>
<p>media: add AudioFlinger，AudioPolicyService，MediaPlayerService and CameraService to servicemanager，同时启动管理binder通讯的机制，依靠这两个类来完成binder机制在android中间层所体现的功能：ProcessState 和IPCThreadState。</p>
<p>bootanim: 开机动画和铃声，code path：frameworks/base/cmds/bootanimation。</p>
<p>接下来就是关于modem的服务，如：ccci_fsd、ccci_mdinit、pppd_gprs、pppd、gsm0710muxd、muxtestapp、sockcli、socksrv、muxreport、ril-daemon等，除了前面2个，后面的都带有disabled的参数，需要按名启动。</p>
<p>Installd: start install package daemon, 后面还有很多关于其他硬件的服务，比如BT、WIFI等。</p>
<h3 id="zygote"><a href="#zygote" class="headerlink" title="zygote"></a>zygote</h3><p>zygote的启动预示着真正的来到了java的世界。zygote这个词的中文意思的受精卵，他和android系统中的java世界有着重要关系。zygote本身是一个native的应用程序，与驱动，内核均无关系。根据对init的了解我们知道，zygote是有init进程根据init.rc文件中的配置项创建的。先分析其来历，zygote最初的名字叫app_process，这个名字是在android.mk文件中指定的。但在运行过程中，app_process通过linux下的pctrl系统调用将自己的名字换成了zygote，所以通过进程看到的名称是zygote。</p>
<p>Zygote进程中完成了java虚拟机的创建及初始化，以及准备了java运行时环境，还有jni的准备工作，所以zygote占据了整个android世界的半壁江山，另半壁江山则是system_server，后续会详细介绍。</p>
<p>app_process的源码位于：frameworks/base/cmds/app_process/app_main.cpp。源码如下：<br><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">(<span class="keyword">int</span> argc, <span class="keyword">const</span> <span class="keyword">char</span>* <span class="keyword">const</span> argv[])</span></span><br><span class="line"></span>&#123;</span><br><span class="line">    <span class="comment">// These are global variables in ProcessState.cpp</span></span><br><span class="line">    mArgC = argc;</span><br><span class="line">    mArgV = argv;</span><br><span class="line"></span><br><span class="line">    mArgLen = <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">int</span> i=<span class="number">0</span>; i&lt;argc; i++) &#123;</span><br><span class="line">        mArgLen += <span class="built_in">strlen</span>(argv[i]) + <span class="number">1</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    mArgLen--;</span><br><span class="line"></span><br><span class="line">    AppRuntime runtime; <span class="comment">//这里启动runtime运行时环境(实例)，AppRuntime是AndroidRuntime的子类，在创建这个对象的时候会依次调用基类和子类的构造函数。</span></span><br><span class="line">    <span class="keyword">const</span> <span class="keyword">char</span>* argv0 = argv[<span class="number">0</span>];</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Process command line arguments</span></span><br><span class="line">    <span class="comment">// ignore argv[0]</span></span><br><span class="line">    argc--;</span><br><span class="line">    argv++;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Everything up to '--' or first non '-' arg goes to the vm</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">int</span> i = runtime.addVmArguments(argc, argv); <span class="comment">//找到参数中第一个不是以单个-开始的参数，这里很明显是第二个参数:/system/bin</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// Parse runtime arguments.  Stop at first unrecognized option.</span></span><br><span class="line">    <span class="keyword">bool</span> zygote = <span class="literal">false</span>;</span><br><span class="line">    <span class="keyword">bool</span> startSystemServer = <span class="literal">false</span>;</span><br><span class="line">    <span class="keyword">bool</span> application = <span class="literal">false</span>;</span><br><span class="line">    <span class="keyword">const</span> <span class="keyword">char</span>* parentDir = <span class="literal">NULL</span>;</span><br><span class="line">    <span class="keyword">const</span> <span class="keyword">char</span>* niceName = <span class="literal">NULL</span>;</span><br><span class="line">    <span class="keyword">const</span> <span class="keyword">char</span>* className = <span class="literal">NULL</span>;</span><br><span class="line">    <span class="keyword">while</span> (i &lt; argc) &#123;</span><br><span class="line">        <span class="keyword">const</span> <span class="keyword">char</span>* arg = argv[i++];</span><br><span class="line">        <span class="keyword">if</span> (!parentDir) &#123;</span><br><span class="line">            parentDir = arg;</span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (<span class="built_in">strcmp</span>(arg, <span class="string">"--zygote"</span>) == <span class="number">0</span>) &#123;</span><br><span class="line">            zygote = <span class="literal">true</span>;</span><br><span class="line">            niceName = <span class="string">"zygote"</span>;</span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (<span class="built_in">strcmp</span>(arg, <span class="string">"--start-system-server"</span>) == <span class="number">0</span>) &#123;</span><br><span class="line">            startSystemServer = <span class="literal">true</span>;   <span class="comment">//这个bool变量决定着后面执行runtime.start时是否启动systemserver。</span></span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (<span class="built_in">strcmp</span>(arg, <span class="string">"--application"</span>) == <span class="number">0</span>) &#123;</span><br><span class="line">            application = <span class="literal">true</span>;</span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (<span class="built_in">strncmp</span>(arg, <span class="string">"--nice-name="</span>, <span class="number">12</span>) == <span class="number">0</span>) &#123;</span><br><span class="line">            niceName = arg + <span class="number">12</span>;</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            className = arg;</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (niceName &amp;&amp; *niceName) &#123;</span><br><span class="line">        setArgv0(argv0, niceName);</span><br><span class="line">        set_process_name(niceName);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    runtime.mParentDir = parentDir;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (zygote) &#123;</span><br><span class="line">        <span class="comment">// do last shutdown check</span></span><br><span class="line">        ALOGV(<span class="string">"doLastShutDownCheck"</span>);</span><br><span class="line">        doLastShutDownCheck(); </span><br><span class="line">        runtime.start(<span class="string">"com.android.internal.os.ZygoteInit"</span>,</span><br><span class="line">                startSystemServer ? <span class="string">"start-system-server"</span> : <span class="string">""</span>);</span><br><span class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (className) &#123;</span><br><span class="line">        <span class="comment">// 只启动AndroidRuntime</span></span><br><span class="line">        <span class="comment">// Remainder of args get passed to startup class main()</span></span><br><span class="line">        runtime.mClassName = className;</span><br><span class="line">        runtime.mArgC = argc - i;</span><br><span class="line">        runtime.mArgV = argv + i;</span><br><span class="line">        runtime.start(<span class="string">"com.android.internal.os.RuntimeInit"</span>,</span><br><span class="line">                application ? <span class="string">"application"</span> : <span class="string">"tool"</span>);</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="built_in">fprintf</span>(<span class="built_in">stderr</span>, <span class="string">"Error: no class name or --zygote supplied.\n"</span>);</span><br><span class="line">        app_usage();</span><br><span class="line">        LOG_ALWAYS_FATAL(<span class="string">"app_process: no class name or --zygote supplied."</span>);</span><br><span class="line">        <span class="keyword">return</span> <span class="number">10</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p> 该代码主要完成工作如下：</p>
<ul>
<li>niceName = “zygote”;—- &gt;重命名，原进程名称为app_process</li>
<li>setArgv0(argv0, niceName);</li>
<li>set_process_name(niceName); —- &gt;完成重命名操作</li>
<li>AppRuntime runtime;—– &gt;App_main.cpp的一个内部类，其继承AndroidRuntime.cpp</li>
<li>runtime.start(“com.android.internal.os.ZygoteInit”,startSystemServer(“startsystemserver”));<blockquote>
<p>AppRuntime 作为一个内部类，在main()里调用。其完成：</p>
<ul>
<li>getClassName() —- &gt;运行时文件类名</li>
<li>onVmCreated()—- &gt;java虚拟机创建</li>
<li>onStarted()—- &gt;调用时加载</li>
<li>onZygoteInit()—- &gt;初始化虚拟机</li>
<li>onExit()—- &gt;退出时的操作 ——— &gt; 上述函数基本自动调用</li>
</ul>
</blockquote>
</li>
</ul>
<p>接着，走进runtime.start(com.android.internal.os.ZygoteInit)。runtime来自AndroidRuntime.cpp。</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br></pre></td><td class="code"><pre><span class="line">AndroidRuntime::start(<span class="keyword">const</span> <span class="keyword">char</span>* className, <span class="keyword">const</span> <span class="keyword">char</span>* options)。frameworks\base\core\jni\AndroidRuntime.cpp。分析其start()函数：</span><br><span class="line"></span><br><span class="line">    <span class="keyword">void</span> AndroidRuntime::start(<span class="keyword">const</span> <span class="keyword">char</span>* className, <span class="keyword">const</span> <span class="keyword">char</span>* options)</span><br><span class="line">    &#123;</span><br><span class="line">        ALOGD(<span class="string">"\n&gt;&gt;&gt;&gt;&gt;&gt; AndroidRuntime START %s &lt;&lt;&lt;&lt;&lt;&lt;\n"</span>,</span><br><span class="line">                className != <span class="literal">NULL</span> ? className : <span class="string">"(unknown)"</span>);</span><br><span class="line"></span><br><span class="line">        blockSigpipe();</span><br><span class="line"></span><br><span class="line">        <span class="comment">/*</span><br><span class="line">         * 'startSystemServer == true' means runtime is obsolete and not run from</span><br><span class="line">         * init.rc anymore, so we print out the boot start event here.</span><br><span class="line">         */</span></span><br><span class="line">        <span class="keyword">if</span> (<span class="built_in">strcmp</span>(options, <span class="string">"start-system-server"</span>) == <span class="number">0</span>) &#123;</span><br><span class="line">            <span class="comment">/* track our progress through the boot sequence */</span></span><br><span class="line">            <span class="keyword">const</span> <span class="keyword">int</span> LOG_BOOT_PROGRESS_START = <span class="number">3000</span>;</span><br><span class="line">            LOG_EVENT_LONG(LOG_BOOT_PROGRESS_START,</span><br><span class="line">                           ns2ms(systemTime(SYSTEM_TIME_MONOTONIC)));</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">const</span> <span class="keyword">char</span>* rootDir = getenv(<span class="string">"ANDROID_ROOT"</span>);</span><br><span class="line">        <span class="keyword">if</span> (rootDir == <span class="literal">NULL</span>) &#123;</span><br><span class="line">            rootDir = <span class="string">"/system"</span>;</span><br><span class="line">            <span class="keyword">if</span> (!hasDir(<span class="string">"/system"</span>)) &#123;</span><br><span class="line">                LOG_FATAL(<span class="string">"No root directory specified, and /android does not exist."</span>);</span><br><span class="line">                <span class="keyword">return</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            setenv(<span class="string">"ANDROID_ROOT"</span>, rootDir, <span class="number">1</span>);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">//const char* kernelHack = getenv("LD_ASSUME_KERNEL");</span></span><br><span class="line">        <span class="comment">//ALOGD("Found LD_ASSUME_KERNEL='%s'\n", kernelHack);</span></span><br><span class="line"></span><br><span class="line">        <span class="comment">/* start the virtual machine */</span></span><br><span class="line">        JNIEnv* env;</span><br><span class="line">        <span class="keyword">if</span> (startVm(&amp;mJavaVM, &amp;env) != <span class="number">0</span>) &#123;</span><br><span class="line">            <span class="keyword">return</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        onVmCreated(env);</span><br><span class="line"></span><br><span class="line">        <span class="comment">/*</span><br><span class="line">         * Register android functions.</span><br><span class="line">         */</span></span><br><span class="line">        <span class="comment">//向VM注册Android本地函数</span></span><br><span class="line">        <span class="keyword">if</span> (startReg(env) &lt; <span class="number">0</span>) &#123;</span><br><span class="line">            ALOGE(<span class="string">"Unable to register all android natives\n"</span>);</span><br><span class="line">            <span class="keyword">return</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">/*</span><br><span class="line">         * We want to call main() with a String array with arguments in it.</span><br><span class="line">         * At present we have two arguments, the class name and an option string.</span><br><span class="line">         * Create an array to hold them.</span><br><span class="line">         */</span></span><br><span class="line">        jclass stringClass;</span><br><span class="line">        jobjectArray strArray;</span><br><span class="line">        jstring classNameStr;</span><br><span class="line">        jstring optionsStr;</span><br><span class="line"></span><br><span class="line">        stringClass = env-&gt;FindClass(<span class="string">"java/lang/String"</span>);</span><br><span class="line">        assert(stringClass != <span class="literal">NULL</span>);</span><br><span class="line">        strArray = env-&gt;NewObjectArray(<span class="number">2</span>, stringClass, <span class="literal">NULL</span>);</span><br><span class="line">        assert(strArray != <span class="literal">NULL</span>);</span><br><span class="line">        classNameStr = env-&gt;NewStringUTF(className);</span><br><span class="line">        assert(classNameStr != <span class="literal">NULL</span>);</span><br><span class="line">        env-&gt;SetObjectArrayElement(strArray, <span class="number">0</span>, classNameStr);</span><br><span class="line">        optionsStr = env-&gt;NewStringUTF(options);</span><br><span class="line">        env-&gt;SetObjectArrayElement(strArray, <span class="number">1</span>, optionsStr);</span><br><span class="line"></span><br><span class="line">        <span class="comment">/*</span><br><span class="line">         * Start VM.  This thread becomes the main thread of the VM, and will</span><br><span class="line">         * not return until the VM exits.</span><br><span class="line">         */</span></span><br><span class="line">        <span class="keyword">char</span>* slashClassName = toSlashClassName(className);</span><br><span class="line">        jclass startClass = env-&gt;FindClass(slashClassName);</span><br><span class="line">        <span class="keyword">if</span> (startClass == <span class="literal">NULL</span>) &#123;</span><br><span class="line">            ALOGE(<span class="string">"JavaVM unable to locate class '%s'\n"</span>, slashClassName);</span><br><span class="line">            <span class="comment">/* keep going */</span></span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            jmethodID startMeth = env-&gt;GetStaticMethodID(startClass, <span class="string">"main"</span>,</span><br><span class="line">                <span class="string">"([Ljava/lang/String;)V"</span>);</span><br><span class="line">            <span class="keyword">if</span> (startMeth == <span class="literal">NULL</span>) &#123;</span><br><span class="line">                ALOGE(<span class="string">"JavaVM unable to find main() in '%s'\n"</span>, className);</span><br><span class="line">                <span class="comment">/* keep going */</span></span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                env-&gt;CallStaticVoidMethod(startClass, startMeth, strArray);</span><br><span class="line"></span><br><span class="line">    <span class="meta">#<span class="meta-keyword">if</span> 0</span></span><br><span class="line">                <span class="keyword">if</span> (env-&gt;ExceptionCheck())</span><br><span class="line">                    threadExitUncaughtException(env);</span><br><span class="line">    <span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="built_in">free</span>(slashClassName);</span><br><span class="line"></span><br><span class="line">        ALOGD(<span class="string">"Shutting down VM\n"</span>);</span><br><span class="line">        <span class="keyword">if</span> (mJavaVM-&gt;DetachCurrentThread() != JNI_OK)</span><br><span class="line">            ALOGW(<span class="string">"Warning: unable to detach main thread\n"</span>);</span><br><span class="line">        <span class="keyword">if</span> (mJavaVM-&gt;DestroyJavaVM() != <span class="number">0</span>)</span><br><span class="line">            ALOGW(<span class="string">"Warning: VM did not shut down cleanly\n"</span>);</span><br><span class="line">    &#125;</span><br><span class="line">``` </span><br><span class="line">该函数完成操作：</span><br><span class="line">*  onVmCreated(env);----- &gt;创建虚拟机</span><br><span class="line">*  JNIEnv* env; ---- &gt; JNI环境的初始化</span><br><span class="line">*  env-&gt;CallStaticVoidMethod(startClass, startMeth, strArray); ----- &gt;最终函数与上述步骤中的runtime.start(com.android.internal.os.ZygoteInit)对应。</span><br><span class="line">*  至此走到---- ZygoteInit.java----main()</span><br><span class="line"></span><br><span class="line">ZygoteInit.java：</span><br><span class="line">```<span class="function">java</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String argv[])</span> </span>&#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="comment">// Start profiling the zygote initialization.</span></span><br><span class="line">            SamplingProfilerIntegration.start();</span><br><span class="line"></span><br><span class="line">            registerZygoteSocket();</span><br><span class="line">            EventLog.writeEvent(LOG_BOOT_PROGRESS_PRELOAD_START,</span><br><span class="line">                SystemClock.uptimeMillis());</span><br><span class="line">            preload();</span><br><span class="line">            EventLog.writeEvent(LOG_BOOT_PROGRESS_PRELOAD_END,</span><br><span class="line">                SystemClock.uptimeMillis());</span><br><span class="line"></span><br><span class="line">            <span class="comment">// Finish profiling the zygote initialization.</span></span><br><span class="line">            SamplingProfilerIntegration.writeZygoteSnapshot();</span><br><span class="line"></span><br><span class="line">            <span class="comment">// Do an initial gc to clean up after startup</span></span><br><span class="line">            gc();</span><br><span class="line"></span><br><span class="line">            <span class="comment">// If requested, start system server directly from Zygote</span></span><br><span class="line">            <span class="keyword">if</span> (argv.length != <span class="number">2</span>) &#123;</span><br><span class="line">                <span class="keyword">throw</span> <span class="keyword">new</span> RuntimeException(argv[<span class="number">0</span>] + USAGE_STRING);</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">if</span> (argv[<span class="number">1</span>].equals(<span class="string">"start-system-server"</span>)) &#123;</span><br><span class="line">                startSystemServer();</span><br><span class="line">            &#125; <span class="keyword">else</span> <span class="keyword">if</span> (!argv[<span class="number">1</span>].equals(<span class="string">""</span>)) &#123;</span><br><span class="line">                <span class="keyword">throw</span> <span class="keyword">new</span> RuntimeException(argv[<span class="number">0</span>] + USAGE_STRING);</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            Log.i(TAG, <span class="string">"Accepting command socket connections"</span>);</span><br><span class="line"></span><br><span class="line">            <span class="keyword">if</span> (ZYGOTE_FORK_MODE) &#123;</span><br><span class="line">                runForkMode();</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                runSelectLoopMode();</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            closeServerSocket();</span><br><span class="line">        &#125; <span class="keyword">catch</span> (MethodAndArgsCaller caller) &#123;</span><br><span class="line">            caller.run();</span><br><span class="line">        &#125; <span class="keyword">catch</span> (RuntimeException ex) &#123;</span><br><span class="line">            Log.e(TAG, <span class="string">"Zygote died with exception"</span>, ex);</span><br><span class="line">            closeServerSocket();</span><br><span class="line">            <span class="keyword">throw</span> ex;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>
<p> 该函数重点完成如下3项工作：</p>
<ul>
<li>registerZygoteSocket();</li>
<li>startSystemServer();—– &gt; 核心方法，Zygote进程一分为二，此处分裂出一个system_server进程。</li>
<li>至此system_server进程进入SystemServer.java—- &gt;main()</li>
</ul>
<p>zygote socket服务器建立后，zygote要接收来处客户端的请求，fork所有的Java进程。那么，SystemServer其实是zygote自己fork的第一个进程。</p>
<p>先看下startSystemServer()方法：<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">boolean</span> <span class="title">startSystemServer</span><span class="params">()</span></span><br><span class="line">        <span class="keyword">throws</span> MethodAndArgsCaller, RuntimeException </span>&#123;</span><br><span class="line">    <span class="comment">/* Hardcoded command line to start the system server */</span></span><br><span class="line">    String args[] = &#123;</span><br><span class="line">        <span class="string">"--setuid=1000"</span>,</span><br><span class="line">        <span class="string">"--setgid=1000"</span>,</span><br><span class="line">        <span class="string">"--setgroups=1001,1002,1003,1004,1005,1006,1007,1008,1009,1010,1018,3001,3002,3003,3006,3007"</span>,</span><br><span class="line">        <span class="string">"--capabilities=130104352,130104352"</span>,</span><br><span class="line">        <span class="string">"--runtime-init"</span>,</span><br><span class="line">        <span class="string">"--nice-name=system_server"</span>,</span><br><span class="line">        <span class="string">"com.android.server.SystemServer"</span>,</span><br><span class="line">    &#125;;</span><br><span class="line">    ZygoteConnection.Arguments parsedArgs = <span class="keyword">null</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">int</span> pid;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        parsedArgs = <span class="keyword">new</span> ZygoteConnection.Arguments(args);</span><br><span class="line">        ZygoteConnection.applyDebuggerSystemProperty(parsedArgs);</span><br><span class="line">        ZygoteConnection.applyInvokeWithSystemProperty(parsedArgs);</span><br><span class="line"></span><br><span class="line">        <span class="comment">/* Request to fork the system server process */</span></span><br><span class="line">        pid = Zygote.forkSystemServer(</span><br><span class="line">                parsedArgs.uid, parsedArgs.gid,</span><br><span class="line">                parsedArgs.gids,</span><br><span class="line">                parsedArgs.debugFlags,</span><br><span class="line">                <span class="keyword">null</span>,</span><br><span class="line">                parsedArgs.permittedCapabilities,</span><br><span class="line">                parsedArgs.effectiveCapabilities);</span><br><span class="line">    &#125; <span class="keyword">catch</span> (IllegalArgumentException ex) &#123;</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> RuntimeException(ex);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/* For child process */</span></span><br><span class="line">    <span class="keyword">if</span> (pid == <span class="number">0</span>) &#123;</span><br><span class="line">        handleSystemServerProcess(parsedArgs);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">true</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p> com.android.server.SystemServer的创建，预示着SystemServer的的正式启动，自此Zygote一分为二。Zygote将系统服务交给SystemServer统一管理。而zygote则负责java运行时环境和Dalvik虚拟机的管理工作。</p>
<h3 id="SystemServer"><a href="#SystemServer" class="headerlink" title="SystemServer"></a>SystemServer</h3><p>system_server进程是android的第二大进程，其余zygote紧密联系，若其中任何一个进程死掉，就会导致系统死掉，其启动过程包含两个阶段Main()—– &gt;init1()和init2()。</p>
<p>Init1()，为system_server的第一阶段SystemServer.java— &gt;Init1()的本地实现在com_android_server_SystemServer.cpp中。</p>
<p>先看frameworks\base\services\java\com\android\server\SystemServer.java的main()函数。<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">native</span> <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">init1</span><span class="params">(String[] args)</span></span>;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (System.currentTimeMillis() &lt; EARLIEST_SUPPORTED_TIME) &#123;</span><br><span class="line">        <span class="comment">// If a device's clock is before 1970 (before 0), a lot of</span></span><br><span class="line">        <span class="comment">// APIs crash dealing with negative numbers, notably</span></span><br><span class="line">        <span class="comment">// java.io.File#setLastModified, so instead we fake it and</span></span><br><span class="line">        <span class="comment">// hope that time from cell towers or NTP fixes it</span></span><br><span class="line">        <span class="comment">// shortly.</span></span><br><span class="line">        Slog.w(TAG, <span class="string">"System clock is before 1970; setting to 1970."</span>);</span><br><span class="line">        SystemClock.setCurrentTimeMillis(EARLIEST_SUPPORTED_TIME);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (SamplingProfilerIntegration.isEnabled()) &#123;</span><br><span class="line">        SamplingProfilerIntegration.start();</span><br><span class="line">        timer = <span class="keyword">new</span> Timer();</span><br><span class="line">        timer.schedule(<span class="keyword">new</span> TimerTask() &#123;</span><br><span class="line">            <span class="meta">@Override</span></span><br><span class="line">            <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">()</span> </span>&#123;</span><br><span class="line">                SamplingProfilerIntegration.writeSnapshot(<span class="string">"system_server"</span>, <span class="keyword">null</span>);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;, SNAPSHOT_INTERVAL, SNAPSHOT_INTERVAL);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Mmmmmm... more memory!</span></span><br><span class="line">    dalvik.system.VMRuntime.getRuntime().clearGrowthLimit();</span><br><span class="line"></span><br><span class="line">    <span class="comment">// The system server has to run all of the time, so it needs to be</span></span><br><span class="line">    <span class="comment">// as efficient as possible with its memory usage.</span></span><br><span class="line">    VMRuntime.getRuntime().setTargetHeapUtilization(<span class="number">0.8f</span>);</span><br><span class="line"></span><br><span class="line">    System.loadLibrary(<span class="string">"android_servers"</span>);</span><br><span class="line">    init1(args);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">void</span> <span class="title">init2</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    Slog.i(TAG, <span class="string">"Entered the Android system server!"</span>);</span><br><span class="line">    Thread thr = <span class="keyword">new</span> ServerThread();</span><br><span class="line">    thr.setName(<span class="string">"android.server.ServerThread"</span>);</span><br><span class="line">    thr.start();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>其中init1()的本地实现在com_android_server_SystemServer.cpp中：<br><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">void</span> <span class="title">android_server_SystemServer_init1</span><span class="params">(JNIEnv* env, jobject clazz)</span></span><br><span class="line"></span>&#123;</span><br><span class="line">    system_init();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>system_init()在frameworks\base\cmds\system_server\library\system_init.cpp中：<br><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">extern</span> <span class="string">"C"</span> <span class="keyword">status_t</span> system_init()</span><br><span class="line">&#123;</span><br><span class="line">    ALOGI(<span class="string">"Entered system_init()"</span>);</span><br><span class="line"></span><br><span class="line">    sp&lt;ProcessState&gt; proc(ProcessState::self());</span><br><span class="line"></span><br><span class="line">    sp&lt;IServiceManager&gt; sm = defaultServiceManager();</span><br><span class="line">    ALOGI(<span class="string">"ServiceManager: %p\n"</span>, sm.get());</span><br><span class="line"></span><br><span class="line">    sp&lt;GrimReaper&gt; grim = <span class="keyword">new</span> GrimReaper();</span><br><span class="line">    sm-&gt;asBinder()-&gt;linkToDeath(grim, grim.get(), <span class="number">0</span>);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">char</span> propBuf[PROPERTY_VALUE_MAX];</span><br><span class="line">    property_get(<span class="string">"system_init.startsurfaceflinger"</span>, propBuf, <span class="string">"1"</span>);</span><br><span class="line">    <span class="keyword">if</span> (<span class="built_in">strcmp</span>(propBuf, <span class="string">"1"</span>) == <span class="number">0</span>) &#123;</span><br><span class="line">        <span class="comment">// Start the SurfaceFlinger</span></span><br><span class="line">        SurfaceFlinger::instantiate();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    property_get(<span class="string">"system_init.startsensorservice"</span>, propBuf, <span class="string">"1"</span>);</span><br><span class="line">    <span class="keyword">if</span> (<span class="built_in">strcmp</span>(propBuf, <span class="string">"1"</span>) == <span class="number">0</span>) &#123;</span><br><span class="line">        <span class="comment">// Start the sensor service</span></span><br><span class="line">        SensorService::instantiate();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// And now start the Android runtime.  We have to do this bit</span></span><br><span class="line">    <span class="comment">// of nastiness because the Android runtime initialization requires</span></span><br><span class="line">    <span class="comment">// some of the core system services to already be started.</span></span><br><span class="line">    <span class="comment">// All other servers should just start the Android runtime at</span></span><br><span class="line">    <span class="comment">// the beginning of their processes's main(), before calling</span></span><br><span class="line">    <span class="comment">// the init function.</span></span><br><span class="line">    ALOGI(<span class="string">"System server: starting Android runtime.\n"</span>);</span><br><span class="line">    AndroidRuntime* runtime = AndroidRuntime::getRuntime();</span><br><span class="line"></span><br><span class="line">    ALOGI(<span class="string">"System server: starting Android services.\n"</span>);</span><br><span class="line">    JNIEnv* env = runtime-&gt;getJNIEnv();</span><br><span class="line">    <span class="keyword">if</span> (env == <span class="literal">NULL</span>) &#123;</span><br><span class="line">        <span class="keyword">return</span> UNKNOWN_ERROR;</span><br><span class="line">    &#125;</span><br><span class="line">    jclass clazz = env-&gt;FindClass(<span class="string">"com/android/server/SystemServer"</span>);</span><br><span class="line">    <span class="keyword">if</span> (clazz == <span class="literal">NULL</span>) &#123;</span><br><span class="line">        <span class="keyword">return</span> UNKNOWN_ERROR;</span><br><span class="line">    &#125;</span><br><span class="line">    jmethodID methodId = env-&gt;GetStaticMethodID(clazz, <span class="string">"init2"</span>, <span class="string">"()V"</span>);</span><br><span class="line">    <span class="keyword">if</span> (methodId == <span class="literal">NULL</span>) &#123;</span><br><span class="line">        <span class="keyword">return</span> UNKNOWN_ERROR;</span><br><span class="line">    &#125;</span><br><span class="line">    env-&gt;CallStaticVoidMethod(clazz, methodId);</span><br><span class="line"></span><br><span class="line">    ALOGI(<span class="string">"System server: entering thread pool.\n"</span>);</span><br><span class="line">    ProcessState::self()-&gt;startThreadPool();</span><br><span class="line">    IPCThreadState::self()-&gt;joinThreadPool();</span><br><span class="line">    ALOGI(<span class="string">"System server: exiting thread pool.\n"</span>);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> NO_ERROR;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>再回到SystemServer.java的main()中的init2():init2()将操作交给了内部类ServerThread处理，看起run()函数：<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br></pre></td><td class="code"><pre><span class="line"><span class="function">ublic <span class="keyword">void</span> <span class="title">run</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        EventLog.writeEvent(EventLogTags.BOOT_PROGRESS_SYSTEM_RUN,</span><br><span class="line">            SystemClock.uptimeMillis());</span><br><span class="line"></span><br><span class="line">        Looper.prepare();</span><br><span class="line"></span><br><span class="line">        android.os.Process.setThreadPriority(</span><br><span class="line">                android.os.Process.THREAD_PRIORITY_FOREGROUND);</span><br><span class="line"></span><br><span class="line">    .......</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">        AccountManagerService accountManager = <span class="keyword">null</span>;</span><br><span class="line">        ContentService contentService = <span class="keyword">null</span>;</span><br><span class="line">        LightsService lights = <span class="keyword">null</span>;</span><br><span class="line">        PowerManagerService power = <span class="keyword">null</span>;</span><br><span class="line">        BatteryService battery = <span class="keyword">null</span>;</span><br><span class="line">        VibratorService vibrator = <span class="keyword">null</span>;</span><br><span class="line">        AlarmManagerService alarm = <span class="keyword">null</span>;</span><br><span class="line">        NetworkManagementService networkManagement = <span class="keyword">null</span>;</span><br><span class="line">        NetworkStatsService networkStats = <span class="keyword">null</span>;</span><br><span class="line">        NetworkPolicyManagerService networkPolicy = <span class="keyword">null</span>;</span><br><span class="line">        ConnectivityService connectivity = <span class="keyword">null</span>;</span><br><span class="line">        WifiP2pService wifiP2p = <span class="keyword">null</span>;</span><br><span class="line">        WifiService wifi = <span class="keyword">null</span>;</span><br><span class="line">        NsdService serviceDiscovery= <span class="keyword">null</span>;</span><br><span class="line">        IPackageManager pm = <span class="keyword">null</span>;</span><br><span class="line">        Context context = <span class="keyword">null</span>;</span><br><span class="line">        WindowManagerService wm = <span class="keyword">null</span>;</span><br><span class="line">        BluetoothService bluetooth = <span class="keyword">null</span>;</span><br><span class="line">        BluetoothA2dpService bluetoothA2dp = <span class="keyword">null</span>;</span><br><span class="line">        DockObserver dock = <span class="keyword">null</span>;</span><br><span class="line">        UsbService usb = <span class="keyword">null</span>;</span><br><span class="line">        SerialService serial = <span class="keyword">null</span>;</span><br><span class="line">        UiModeManagerService uiMode = <span class="keyword">null</span>;</span><br><span class="line">        RecognitionManagerService recognition = <span class="keyword">null</span>;</span><br><span class="line">        ThrottleService throttle = <span class="keyword">null</span>;</span><br><span class="line">        NetworkTimeUpdateService networkTimeUpdater = <span class="keyword">null</span>;</span><br><span class="line">        CommonTimeManagementService commonTimeMgmtService = <span class="keyword">null</span>;</span><br><span class="line">        InputManagerService inputManager = <span class="keyword">null</span>;</span><br><span class="line"></span><br><span class="line">        <span class="comment">//Bug#185069 fix low storage ,check the space&amp;delete the temp file weather need.</span></span><br><span class="line">        DeviceStorageMonitorService.freeSpace();</span><br><span class="line"></span><br><span class="line">        .......</span><br><span class="line">        ServiceManager.addService(<span class="string">"xxx"</span>,XXX);</span><br><span class="line">        .......</span><br><span class="line"></span><br><span class="line">        DevicePolicyManagerService devicePolicy = <span class="keyword">null</span>;</span><br><span class="line">        StatusBarManagerService statusBar = <span class="keyword">null</span>;</span><br><span class="line">        InputMethodManagerService imm = <span class="keyword">null</span>;</span><br><span class="line">        AppWidgetService appWidget = <span class="keyword">null</span>;</span><br><span class="line">        NotificationManagerService notification = <span class="keyword">null</span>;</span><br><span class="line">        WallpaperManagerService wallpaper = <span class="keyword">null</span>;</span><br><span class="line">        LocationManagerService location = <span class="keyword">null</span>;</span><br><span class="line">        CountryDetectorService countryDetector = <span class="keyword">null</span>;</span><br><span class="line">        TextServicesManagerService tsms = <span class="keyword">null</span>;</span><br><span class="line">        LockSettingsService lockSettings = <span class="keyword">null</span>;</span><br><span class="line">        DreamManagerService dreamy = <span class="keyword">null</span>;</span><br><span class="line"></span><br><span class="line">    ......</span><br><span class="line"></span><br><span class="line">        <span class="comment">// These are needed to propagate to the runnable below.</span></span><br><span class="line">        <span class="keyword">final</span> Context contextF = context;</span><br><span class="line">        <span class="keyword">final</span> BatteryService batteryF = battery;</span><br><span class="line">        <span class="keyword">final</span> NetworkManagementService networkManagementF = networkManagement;</span><br><span class="line">        <span class="keyword">final</span> NetworkStatsService networkStatsF = networkStats;</span><br><span class="line">        <span class="keyword">final</span> NetworkPolicyManagerService networkPolicyF = networkPolicy;</span><br><span class="line">        <span class="keyword">final</span> ConnectivityService connectivityF = connectivity;</span><br><span class="line">        <span class="keyword">final</span> DockObserver dockF = dock;</span><br><span class="line">        <span class="keyword">final</span> UsbService usbF = usb;</span><br><span class="line">        <span class="keyword">final</span> ThrottleService throttleF = throttle;</span><br><span class="line">        <span class="keyword">final</span> UiModeManagerService uiModeF = uiMode;</span><br><span class="line">        <span class="keyword">final</span> AppWidgetService appWidgetF = appWidget;</span><br><span class="line">        <span class="keyword">final</span> WallpaperManagerService wallpaperF = wallpaper;</span><br><span class="line">        <span class="keyword">final</span> InputMethodManagerService immF = imm;</span><br><span class="line">        <span class="keyword">final</span> RecognitionManagerService recognitionF = recognition;</span><br><span class="line">        <span class="keyword">final</span> LocationManagerService locationF = location;</span><br><span class="line">        <span class="keyword">final</span> CountryDetectorService countryDetectorF = countryDetector;</span><br><span class="line">        <span class="keyword">final</span> NetworkTimeUpdateService networkTimeUpdaterF = networkTimeUpdater;</span><br><span class="line">        <span class="keyword">final</span> CommonTimeManagementService commonTimeMgmtServiceF = commonTimeMgmtService;</span><br><span class="line">        <span class="keyword">final</span> TextServicesManagerService textServiceManagerServiceF = tsms;</span><br><span class="line">        <span class="keyword">final</span> StatusBarManagerService statusBarF = statusBar;</span><br><span class="line">        <span class="keyword">final</span> DreamManagerService dreamyF = dreamy;</span><br><span class="line">        <span class="keyword">final</span> InputManagerService inputManagerF = inputManager;</span><br><span class="line">        <span class="keyword">final</span> BluetoothService bluetoothF = bluetooth;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">        ActivityManagerService.self().systemReady(<span class="keyword">new</span> Runnable() &#123;</span><br><span class="line">            <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">()</span> </span>&#123;</span><br><span class="line">                Slog.i(TAG, <span class="string">"Making services ready"</span>);</span><br><span class="line"></span><br><span class="line">                <span class="keyword">if</span> (!headless) startSystemUi(contextF);</span><br><span class="line">                <span class="keyword">try</span> &#123;</span><br><span class="line">                    <span class="keyword">if</span> (batteryF != <span class="keyword">null</span>) batteryF.systemReady();</span><br><span class="line">                &#125; <span class="keyword">catch</span> (Throwable e) &#123;</span><br><span class="line">                    reportWtf(<span class="string">"making Battery Service ready"</span>, e);</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="keyword">try</span> &#123;</span><br><span class="line">                    <span class="keyword">if</span> (networkManagementF != <span class="keyword">null</span>) networkManagementF.systemReady();</span><br><span class="line">                &#125; <span class="keyword">catch</span> (Throwable e) &#123;</span><br><span class="line">                    reportWtf(<span class="string">"making Network Managment Service ready"</span>, e);</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="keyword">try</span> &#123;</span><br><span class="line">                    <span class="keyword">if</span> (networkStatsF != <span class="keyword">null</span>) networkStatsF.systemReady();</span><br><span class="line">                &#125; <span class="keyword">catch</span> (Throwable e) &#123;</span><br><span class="line">                    reportWtf(<span class="string">"making Network Stats Service ready"</span>, e);</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="keyword">try</span> &#123;</span><br><span class="line">                    <span class="keyword">if</span> (networkPolicyF != <span class="keyword">null</span>) networkPolicyF.systemReady();</span><br><span class="line">                &#125; <span class="keyword">catch</span> (Throwable e) &#123;</span><br><span class="line">                    reportWtf(<span class="string">"making Network Policy Service ready"</span>, e);</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="keyword">try</span> &#123;</span><br><span class="line">                    <span class="keyword">if</span> (connectivityF != <span class="keyword">null</span>) connectivityF.systemReady();</span><br><span class="line">                &#125; <span class="keyword">catch</span> (Throwable e) &#123;</span><br><span class="line">                    reportWtf(<span class="string">"making Connectivity Service ready"</span>, e);</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="keyword">try</span> &#123;</span><br><span class="line">                    <span class="keyword">if</span> (dockF != <span class="keyword">null</span>) dockF.systemReady();</span><br><span class="line">                &#125; <span class="keyword">catch</span> (Throwable e) &#123;</span><br><span class="line">                    reportWtf(<span class="string">"making Dock Service ready"</span>, e);</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="keyword">try</span> &#123;</span><br><span class="line">                    <span class="keyword">if</span> (usbF != <span class="keyword">null</span>) usbF.systemReady();</span><br><span class="line">                &#125; <span class="keyword">catch</span> (Throwable e) &#123;</span><br><span class="line">                    reportWtf(<span class="string">"making USB Service ready"</span>, e);</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="keyword">try</span> &#123;</span><br><span class="line">                    <span class="keyword">if</span> (uiModeF != <span class="keyword">null</span>) uiModeF.systemReady();</span><br><span class="line">                &#125; <span class="keyword">catch</span> (Throwable e) &#123;</span><br><span class="line">                    reportWtf(<span class="string">"making UI Mode Service ready"</span>, e);</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="keyword">try</span> &#123;</span><br><span class="line">                    <span class="keyword">if</span> (recognitionF != <span class="keyword">null</span>) recognitionF.systemReady();</span><br><span class="line">                &#125; <span class="keyword">catch</span> (Throwable e) &#123;</span><br><span class="line">                    reportWtf(<span class="string">"making Recognition Service ready"</span>, e);</span><br><span class="line">                &#125;</span><br><span class="line">                Watchdog.getInstance().start();</span><br><span class="line"></span><br><span class="line">                <span class="comment">// It is now okay to let the various system services start their</span></span><br><span class="line">                <span class="comment">// third party code...</span></span><br><span class="line"></span><br><span class="line">                <span class="keyword">try</span> &#123;</span><br><span class="line">                    <span class="keyword">if</span> (appWidgetF != <span class="keyword">null</span>) appWidgetF.systemReady(safeMode);</span><br><span class="line">                &#125; <span class="keyword">catch</span> (Throwable e) &#123;</span><br><span class="line">                    reportWtf(<span class="string">"making App Widget Service ready"</span>, e);</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="keyword">try</span> &#123;</span><br><span class="line">                    <span class="keyword">if</span> (wallpaperF != <span class="keyword">null</span>) wallpaperF.systemReady();</span><br><span class="line">                &#125; <span class="keyword">catch</span> (Throwable e) &#123;</span><br><span class="line">                    reportWtf(<span class="string">"making Wallpaper Service ready"</span>, e);</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="keyword">try</span> &#123;</span><br><span class="line">                    <span class="keyword">if</span> (immF != <span class="keyword">null</span>) immF.systemReady(statusBarF);</span><br><span class="line">                &#125; <span class="keyword">catch</span> (Throwable e) &#123;</span><br><span class="line">                    reportWtf(<span class="string">"making Input Method Service ready"</span>, e);</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="keyword">try</span> &#123;</span><br><span class="line">                    <span class="keyword">if</span> (locationF != <span class="keyword">null</span>) locationF.systemReady();</span><br><span class="line">                &#125; <span class="keyword">catch</span> (Throwable e) &#123;</span><br><span class="line">                    reportWtf(<span class="string">"making Location Service ready"</span>, e);</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="keyword">try</span> &#123;</span><br><span class="line">                    <span class="keyword">if</span> (countryDetectorF != <span class="keyword">null</span>) countryDetectorF.systemReady();</span><br><span class="line">                &#125; <span class="keyword">catch</span> (Throwable e) &#123;</span><br><span class="line">                    reportWtf(<span class="string">"making Country Detector Service ready"</span>, e);</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="keyword">try</span> &#123;</span><br><span class="line">                    <span class="keyword">if</span> (throttleF != <span class="keyword">null</span>) throttleF.systemReady();</span><br><span class="line">                &#125; <span class="keyword">catch</span> (Throwable e) &#123;</span><br><span class="line">                    reportWtf(<span class="string">"making Throttle Service ready"</span>, e);</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="keyword">try</span> &#123;</span><br><span class="line">                    <span class="keyword">if</span> (networkTimeUpdaterF != <span class="keyword">null</span>) networkTimeUpdaterF.systemReady();</span><br><span class="line">                &#125; <span class="keyword">catch</span> (Throwable e) &#123;</span><br><span class="line">                    reportWtf(<span class="string">"making Network Time Service ready"</span>, e);</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="keyword">try</span> &#123;</span><br><span class="line">                    <span class="keyword">if</span> (commonTimeMgmtServiceF != <span class="keyword">null</span>) commonTimeMgmtServiceF.systemReady();</span><br><span class="line">                &#125; <span class="keyword">catch</span> (Throwable e) &#123;</span><br><span class="line">                    reportWtf(<span class="string">"making Common time management service ready"</span>, e);</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="keyword">try</span> &#123;</span><br><span class="line">                    <span class="keyword">if</span> (textServiceManagerServiceF != <span class="keyword">null</span>) textServiceManagerServiceF.systemReady();</span><br><span class="line">                &#125; <span class="keyword">catch</span> (Throwable e) &#123;</span><br><span class="line">                    reportWtf(<span class="string">"making Text Services Manager Service ready"</span>, e);</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="keyword">try</span> &#123;</span><br><span class="line">                    <span class="keyword">if</span> (dreamyF != <span class="keyword">null</span>) dreamyF.systemReady();</span><br><span class="line">                &#125; <span class="keyword">catch</span> (Throwable e) &#123;</span><br><span class="line">                    reportWtf(<span class="string">"making DreamManagerService ready"</span>, e);</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="keyword">try</span> &#123;</span><br><span class="line">                    <span class="keyword">if</span> (inputManagerF != <span class="keyword">null</span>) inputManagerF.systemReady(bluetoothF);</span><br><span class="line">                &#125; <span class="keyword">catch</span> (Throwable e) &#123;</span><br><span class="line">                    reportWtf(<span class="string">"making InputManagerService ready"</span>, e);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;);</span><br><span class="line"></span><br><span class="line">        <span class="comment">//PowerManagerServer WakeLock dump thread</span></span><br><span class="line">        (<span class="keyword">new</span> Thread(<span class="keyword">new</span> WakelockMonitor(power))).start();</span><br><span class="line"></span><br><span class="line">    ......</span><br><span class="line"></span><br><span class="line">        Looper.loop();</span><br><span class="line">        Slog.d(TAG, <span class="string">"System ServerThread is exiting!"</span>);</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure></p>
<p>该函数有3个重要功能：</p>
<ul>
<li><p>ServiceManager.addService(“xxx”,XXX)，将系统服务注册进去。</p>
</li>
<li><p>systemReady()，告诉已经实现该接口servers，系统已经启动OK。</p>
</li>
<li><p>WakelockMonitor的启动。</p>
</li>
</ul>
<p>至此，systemserver的启动工作已经完成。</p>
<p>系统启动成功后SystemServer使用xxx.systemReady()通知各个服务，系统已经就绪，桌面程序Home就是在ActivityManagerService.systemReady()通知的过程中建立的，最终调用startHomeActivityLocked()启动launcher。Home在((ActivityManagerService)ActivityManagerNative.getDefault()).systemReady(.)。函数调用的过程中启动，其中systemReady()的参数是一段callback代码，如上面灰色显示的部分。这个函数的实现部分在文件：ActivityManagerService.java中。</p>
<p>先看ActivityManagerService.java的systemReady()：<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br></pre></td><td class="code"><pre><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">systemReady</span><span class="params">(<span class="keyword">final</span> Runnable goingCallback)</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">......</span><br><span class="line"></span><br><span class="line">        retrieveSettings();</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (goingCallback != <span class="keyword">null</span>) goingCallback.run();</span><br><span class="line"></span><br><span class="line">        <span class="keyword">synchronized</span> (<span class="keyword">this</span>) &#123;</span><br><span class="line">            <span class="keyword">if</span> (mFactoryTest != SystemServer.FACTORY_TEST_LOW_LEVEL) &#123;</span><br><span class="line">                <span class="keyword">try</span> &#123;</span><br><span class="line">                    List apps = AppGlobals.getPackageManager().</span><br><span class="line">                        getPersistentApplications(STOCK_PM_FLAGS);</span><br><span class="line">                    <span class="keyword">if</span> (apps != <span class="keyword">null</span>) &#123;</span><br><span class="line">                        <span class="keyword">int</span> N = apps.size();</span><br><span class="line">                        <span class="keyword">int</span> i;</span><br><span class="line">                        <span class="keyword">for</span> (i=<span class="number">0</span>; i&lt;N; i++) &#123;</span><br><span class="line">                            ApplicationInfo info</span><br><span class="line">                                = (ApplicationInfo)apps.get(i);</span><br><span class="line">                            <span class="keyword">if</span> (info != <span class="keyword">null</span> &amp;&amp;</span><br><span class="line">                                    !info.packageName.equals(<span class="string">"android"</span>)) &#123;</span><br><span class="line">                                addAppLocked(info, <span class="keyword">false</span>);</span><br><span class="line">                            &#125;</span><br><span class="line">                        &#125;</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125; <span class="keyword">catch</span> (RemoteException ex) &#123;</span><br><span class="line">                    <span class="comment">// pm is in same process, this will never happen.</span></span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="comment">// Start up initial activity.</span></span><br><span class="line">            mBooting = <span class="keyword">true</span>;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                <span class="keyword">if</span> (AppGlobals.getPackageManager().hasSystemUidErrors()) &#123;</span><br><span class="line">                    Message msg = Message.obtain();</span><br><span class="line">                    msg.what = SHOW_UID_ERROR_MSG;</span><br><span class="line">                    mHandler.sendMessage(msg);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125; <span class="keyword">catch</span> (RemoteException e) &#123;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            mMainStack.resumeTopActivityLocked(<span class="keyword">null</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure></p>
<p> 跳转至launcher的操作由resumeTopActivityLocked()完成，其实现在ActivityStack.java里的resumeTopActivityLocked()。<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">final</span> ActivityManagerService mService;</span><br><span class="line"><span class="function"><span class="keyword">final</span> <span class="keyword">boolean</span> <span class="title">resumeTopActivityLocked</span><span class="params">(ActivityRecord prev, Bundle options)</span> </span>&#123;</span><br><span class="line">    <span class="comment">// Find the first activity that is not finishing.</span></span><br><span class="line">    ActivityRecord next = topRunningActivityLocked(<span class="keyword">null</span>);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Remember how we'll process this pause/resume situation, and ensure</span></span><br><span class="line">    <span class="comment">// that the state is reset however we wind up proceeding.</span></span><br><span class="line">    <span class="keyword">final</span> <span class="keyword">boolean</span> userLeaving = mUserLeaving;</span><br><span class="line">    mUserLeaving = <span class="keyword">false</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (next == <span class="keyword">null</span>) &#123;</span><br><span class="line">        <span class="comment">// There are no more activities!  Let's just start up the</span></span><br><span class="line">        <span class="comment">// Launcher...</span></span><br><span class="line">        <span class="keyword">if</span> (mMainStack) &#123;</span><br><span class="line">            ActivityOptions.abort(options);</span><br><span class="line">            <span class="keyword">return</span> mService.startHomeActivityLocked(<span class="number">0</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure></p>
<p>从上述代码可以看出其实是走到了mService.startHomeActivityLocked(0)，而这里的mService也就是ActivityManagerService.java，再次回到ActivityManagerService.java的startHomeActivityLocked(0)，至此launcher启动完成。<br>系统启动成功后SystemServer调用wm.systemReady()通知WindowManagerService，进而调用PhoneWindowManager，最终通过LockPatternKeyguardView显示解锁界面，跟踪代码可以看到解锁界面并不是一个Activity，这是只是向特定层上绘图，其代码了存放在特殊的位置。此处不再详细分析。<br>frameworks\base\policy\src\com\android\internal\policy\impl\PhoneWindowManager.java的systemReady()方法：<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line">        <span class="comment">/** &#123;<span class="doctag">@inheritDoc</span>&#125; */</span></span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">systemReady</span><span class="params">()</span> </span>&#123;</span><br><span class="line">            <span class="keyword">if</span> (mKeyguardMediator != <span class="keyword">null</span>) &#123;</span><br><span class="line">                <span class="comment">// tell the keyguard</span></span><br><span class="line">                mKeyguardMediator.onSystemReady();</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">synchronized</span> (mLock) &#123;</span><br><span class="line">                updateOrientationListenerLp();</span><br><span class="line">                mSystemReady = <span class="keyword">true</span>;</span><br><span class="line">                mHandler.post(<span class="keyword">new</span> Runnable() &#123;</span><br><span class="line">                    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">()</span> </span>&#123;</span><br><span class="line">                        updateSettings();</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">```  </span><br><span class="line">第一步，告诉锁屏控制器，系统已经启动完成，接下来有锁屏处理。 frameworks\base\policy\src\com\android\internal\policy\impl\KeyguardViewMediator.java：</span><br><span class="line">```<span class="function">java</span><br><span class="line">         <span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onSystemReady</span><span class="params">()</span> </span>&#123;</span><br><span class="line">                <span class="keyword">synchronized</span> (<span class="keyword">this</span>) &#123;</span><br><span class="line">                    <span class="keyword">if</span> (DEBUG) Log.d(TAG, <span class="string">"onSystemReady"</span>);</span><br><span class="line">                    mSystemReady = <span class="keyword">true</span>;</span><br><span class="line">                    doKeyguardLocked();</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br></pre></td></tr></table></figure></p>
<p>再看其doKeyguardLocked()方法：</p>
<pre><code class="java"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">doKeyguardLocked</span><span class="params">()</span> </span>{


        <span class="keyword">if</span>(engModeFlag){
            Log.d(TAG, <span class="string">"show engmode!"</span>);
            engModeFlag = <span class="keyword">false</span>;
            <span class="keyword">return</span> ;
        }

        <span class="comment">// if another app is disabling us, don't show</span>
        <span class="keyword">if</span> (!mExternallyEnabled) {
            <span class="keyword">if</span> (DEBUG) Log.d(TAG, <span class="string">"doKeyguard: not showing because externally disabled"</span>);

            <span class="comment">// note: we *should* set mNeedToReshowWhenReenabled=true here, but that makes</span>
            <span class="comment">// for an occasional ugly flicker in this situation:</span>
            <span class="comment">// 1) receive a call with the screen on (no keyguard) or make a call</span>
            <span class="comment">// 2) screen times out</span>
            <span class="comment">// 3) user hits key to turn screen back on</span>
            <span class="comment">// instead, we reenable the keyguard when we know the screen is off and the call</span>
            <span class="comment">// ends (see the broadcast receiver below)</span>
            <span class="comment">// <span class="doctag">TODO:</span> clean this up when we have better support at the window manager level</span>
            <span class="comment">// for apps that wish to be on top of the keyguard</span>
            <span class="keyword">return</span>;
        }

        <span class="comment">// if the keyguard is already showing, don't bother</span>
        <span class="keyword">if</span> (mKeyguardViewManager.isShowing()) {
            <span class="keyword">if</span> (DEBUG) Log.d(TAG, <span class="string">"doKeyguard: not showing because it is already showing"</span>);
            <span class="keyword">return</span>;
        }

        <span class="keyword">final</span> <span class="keyword">boolean</span> provisioned = mUpdateMonitor.isDeviceProvisioned();
        <span class="keyword">final</span> <span class="keyword">boolean</span> lockedOrMissing = isSimLockedOrMissing();

        <span class="keyword">if</span> (!lockedOrMissing &amp;&amp; !provisioned) {
            <span class="keyword">if</span> (DEBUG) Log.d(TAG, <span class="string">"doKeyguard: not showing because device isn't provisioned"</span>
                    + <span class="string">" and the sim is not locked or missing"</span>);
            <span class="keyword">return</span>;
        }

        <span class="keyword">if</span> (mLockPatternUtils.isLockScreenDisabled() &amp;&amp; !lockedOrMissing) {
            <span class="keyword">if</span> (DEBUG) Log.d(TAG, <span class="string">"doKeyguard: not showing because lockscreen is off"</span>);
            <span class="keyword">return</span>;
        }

        <span class="keyword">if</span> (DEBUG) Log.d(TAG, <span class="string">"doKeyguard: showing the lock screen"</span>);
        showLocked();
    }
</code></pre>
<p>至此，锁屏启动完成。</p>

  </section>

  

<section class="post-comments">
  <div id="disqus_thread"></div>
  <script type="text/javascript">
      var disqus_shortname = 'zke1ev3nme'; 
      /* * * DON'T EDIT BELOW THIS LINE * * */
      (function() {
          var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
          dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
          (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
      })();
  </script>
  <noscript>Please enable JavaScript to view the <a href="http://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
</section>


  
</article>


            <footer class="footer">

    <span class="footer__copyright">Copyright &copy; 2014-2015 Zke1ev3n. All Rights Reserved</span>
    
</footer>

        </div>
    </div>

    <!-- js files -->
    <script src="/js/jquery.min.js"></script>
    <script src="/js/main.js"></script>
    <script src="/js/scale.fix.js"></script>
    

    

    <script type="text/javascript" src="//cdn.mathjax.org/mathjax/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script>
    <script type="text/javascript"> 
        $(document).ready(function(){
            MathJax.Hub.Config({ 
                tex2jax: {inlineMath: [['[latex]','[/latex]'], ['\\(','\\)']]} 
            });
        });
    </script>


    

    <script src="/js/awesome-toc.min.js"></script>
    <script>
        $(document).ready(function(){
            $.awesome_toc({
                overlay: true,
                contentId: "post-content",
            });
        });
    </script>


    <script>
  (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
  (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
  m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
  })(window,document,'script','//www.google-analytics.com/analytics.js','ga');

  ga('create', 'UA-71084152-1', 'auto');
  ga('send', 'pageview');

</script>

    
    <!--kill ie6 -->
<!--[if IE 6]>
  <script src="//letskillie6.googlecode.com/svn/trunk/2/zh_CN.js"></script>
<![endif]-->

</body>
</html>
