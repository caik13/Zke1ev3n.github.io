<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="chrome=1">

    

    <title>
      Android 应用启动过程解析 | Zke1ev3n&#39;s Blog 
    </title>

    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no">
    
      <meta name="author" content="Zke1ev3n">
    
    

    <meta name="description" content="Android系统由Linux内核，函数库，Android运行时，应用程序框架以及应用程序组成。Dalvik虚拟机属行Android运行时环境，它与一些核心库共同承担Android应用程序的运行工作。
Android系统启动加载完内核后，第一个执行的是init进程，init进程首先要做的是设备的初始化工作，然后读取inic.rc文件并启动系统中的重要外部程序 Zygote。Zygote进程是And">
<meta property="og:type" content="article">
<meta property="og:title" content="Android 应用启动过程解析 | Zke1ev3n's Blog">
<meta property="og:url" content="http://yoursite.com/2015/12/02/Android-应用启动过程解析/index.html">
<meta property="og:site_name" content="Zke1ev3n's Blog">
<meta property="og:description" content="Android系统由Linux内核，函数库，Android运行时，应用程序框架以及应用程序组成。Dalvik虚拟机属行Android运行时环境，它与一些核心库共同承担Android应用程序的运行工作。
Android系统启动加载完内核后，第一个执行的是init进程，init进程首先要做的是设备的初始化工作，然后读取inic.rc文件并启动系统中的重要外部程序 Zygote。Zygote进程是And">
<meta property="og:updated_time" content="2015-12-02T04:32:29.206Z">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="Android 应用启动过程解析 | Zke1ev3n's Blog">
<meta name="twitter:description" content="Android系统由Linux内核，函数库，Android运行时，应用程序框架以及应用程序组成。Dalvik虚拟机属行Android运行时环境，它与一些核心库共同承担Android应用程序的运行工作。
Android系统启动加载完内核后，第一个执行的是init进程，init进程首先要做的是设备的初始化工作，然后读取inic.rc文件并启动系统中的重要外部程序 Zygote。Zygote进程是And">
    
    
    
      <link rel="icon" type="image/x-icon" href="/favicon.png">
    
    <link rel="stylesheet" href="/css/uno.css">
    <link rel="stylesheet" href="/css/highlight.css">
    <link rel="stylesheet" href="/css/archive.css">

</head>
<body>

    <span class="mobile btn-mobile-menu">
        <i class="icon icon-list btn-mobile-menu__icon"></i>
        <i class="icon icon-x-circle btn-mobile-close__icon hidden"></i>
    </span>

    

<header class="panel-cover panel-cover--collapsed">


  <div class="panel-main">

    <div class="panel-main__inner panel-inverted">
    <div class="panel-main__content">

        

        <h1 class="panel-cover__title panel-title"><a href="/" title="link to homepage">Zke1ev3n&#39;s Blog</a></h1>
        <hr class="panel-cover__divider" />

        

        <div class="navigation-wrapper">

          <nav class="cover-navigation cover-navigation--primary">
            <ul class="navigation">

              
                
                <li class="navigation__item"><a href="/#blog" title="" class="blog-button">首页</a></li>
              
                
                <li class="navigation__item"><a href="/about" title="" class="">关于</a></li>
              
                
                <li class="navigation__item"><a href="/archive" title="" class="">归档</a></li>
              

            </ul>
          </nav>

          <!-- ----------------------------
To add a new social icon simply duplicate one of the list items from below
and change the class in the <i> tag to match the desired social network
and then add your link to the <a>. Here is a full list of social network
classes that you can use:

    icon-social-500px
    icon-social-behance
    icon-social-delicious
    icon-social-designer-news
    icon-social-deviant-art
    icon-social-digg
    icon-social-dribbble
    icon-social-facebook
    icon-social-flickr
    icon-social-forrst
    icon-social-foursquare
    icon-social-github
    icon-social-google-plus
    icon-social-hi5
    icon-social-instagram
    icon-social-lastfm
    icon-social-linkedin
    icon-social-medium
    icon-social-myspace
    icon-social-path
    icon-social-pinterest
    icon-social-rdio
    icon-social-reddit
    icon-social-skype
    icon-social-spotify
    icon-social-stack-overflow
    icon-social-steam
    icon-social-stumbleupon
    icon-social-treehouse
    icon-social-tumblr
    icon-social-twitter
    icon-social-vimeo
    icon-social-xbox
    icon-social-yelp
    icon-social-youtube
    icon-social-zerply
    icon-mail

-------------------------------->

<!-- add social info here -->



        </div>

      </div>

    </div>

    <div class="panel-cover--overlay"></div>
  </div>
</header>

    <div class="content-wrapper">
        <div class="content-wrapper__inner entry">
            

<article class="post-container post-container--single">

  <header class="post-header">
    
    <h1 class="post-title">Android 应用启动过程解析</h1>

    

    <div class="post-meta">
      <time datetime="2015-12-02" class="post-meta__date date">2015-12-02</time> 

      <span class="post-meta__tags tags">

          

          

      </span>
    </div>
    
    

  </header>

  <section id="post-content" class="article-content post">
    <p>Android系统由Linux内核，函数库，Android运行时，应用程序框架以及应用程序组成。Dalvik虚拟机属行Android运行时环境，它与一些核心库共同承担Android应用程序的运行工作。</p>
<p>Android系统启动加载完内核后，第一个执行的是init进程，init进程首先要做的是设备的初始化工作，然后读取inic.rc文件并启动系统中的重要外部程序 Zygote。Zygote进程是Android所有进程的孵化器进程，它启动后会首先初始化Dalvik虚拟机，然后启动system_server并进入Zygote模式，通过socket等候命令。当执行一个Android应用程序时，system_server进程通过Binder IPC方式发送命令给Zygote，Zygote收到命令后通过fork自身创建一个Dalvik虚拟机的实例来执行应用程序的入口函数，这样一个程序就启动完成了。</p>
<a id="more"></a>
<p>Zygote提供了三种创建进程的方法：</p>
<ul>
<li><p>fork()，创建一个Zygote进程（这种方式实际不会被调用）</p>
</li>
<li><p>forkAndSpecialize()，创建一个非Zygote进程</p>
</li>
<li><p>forkSystemServer()，创建一个系统服务进程。</p>
</li>
</ul>
<p>其中，Zygote进程可以再fork()出其他进程，非Zygote进程则不能fork其他进程，而系统服务进程在终止后它的子进程也必终止。当进程fork成功后，执行的工作就交给了Dalvik虚拟机。Dalvik虚拟机首先通过loadClassFromDex()函数完成类的装载工作，每个类被成功解析后都会拥有一个ClassObject类型的数据结构存储在运行时环境中，虚拟机使用gDvm.loadedClasses全局哈希表来存储与查询所有装载进来的类，随后，字节码验证器使用dvmVerifyCodeFlow()函数对装入的代码进行校验，接着虚拟机调用FindCass()函数查找并装载main方法类，随后调用dvmInterpret()函数初始化解释器并执行字节码流。</p>
<p>在android中，应用程序的入口是ActivityThead中的main函数。activity 的startActivity最终是在ActivityManagerService中调用。</p>
<p>Android应用程序框架层中，ActivityManagerService组件负责为Android应用程序创建新的进程的，它本来也是运行在一个独立的进程之中，不过这个进程是在系统启动的过程中创建的。当系统决定要在一个新的进程中启动一个Activity或者Service时，它就会创建一个新的进程了，然后在这个新的进程中启动这个Activity或者Service。</p>
<p>那么当我们点击了一个应用的图标后，Android内部的流程是怎样的呢？下面我们来分析一下。(下面的源代码都是基于Android4.4.4版本)</p>
<p>一般我们用如下代码启动一个应用:<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">Intent intent = <span class="keyword">new</span> Intent();</span><br><span class="line">intent.setClassName(getApplicationContext(), <span class="string">"com.xx.xx.MainActivity"</span>); <span class="comment">// 入口activity 不一定是MainActivity</span></span><br><span class="line">startActivity(intent);</span><br></pre></td></tr></table></figure></p>
<blockquote>
<p>这里intent中可以附加一个flag：Intent.FLAG_ACTIVITY_NEW_TASK。这个标志的意思是在一个新的TASK中启动这个Activity，一个TASK是一个以堆栈的方式进行管理的Activity集合。</p>
</blockquote>
<p>执行startActivity(intent)后，来到Android FrameWork的代码。首先看Activity类，源码位置在frameworks/base/core/java/android/app/Activity.java：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Activity</span> <span class="keyword">extends</span> <span class="title">ContextThemeWrapper</span></span><br><span class="line">		<span class="keyword">implements</span> <span class="title">LayoutInflater</span>.<span class="title">Factory</span>,</span><br><span class="line">		<span class="title">Window</span>.<span class="title">Callback</span>, <span class="title">KeyEvent</span>.<span class="title">Callback</span>,</span><br><span class="line">		<span class="title">OnCreateContextMenuListener</span>, <span class="title">ComponentCallbacks</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">	......</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">startActivity</span><span class="params">(Intent intent)</span> </span>&#123;</span><br><span class="line">        startActivity(intent, <span class="keyword">null</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">startActivity</span><span class="params">(Intent intent, Bundle options)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (options != <span class="keyword">null</span>) &#123;</span><br><span class="line">            startActivityForResult(intent, -<span class="number">1</span>, options);</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="comment">// Note we want to go through this call for compatibility with</span></span><br><span class="line">            <span class="comment">// applications that may have overridden the method.</span></span><br><span class="line">            startActivityForResult(intent, -<span class="number">1</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>这里可以发现，startActivity(Intent intent)实际上是对startActivityForResult(intent, -1)的一个封装，这里参数为-1表示这个Activity不需要返回结果。再看startActivityForResult函数，这个函数也在Activity类中。<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Activity</span> <span class="keyword">extends</span> <span class="title">ContextThemeWrapper</span></span><br><span class="line">		<span class="keyword">implements</span> <span class="title">LayoutInflater</span>.<span class="title">Factory</span>,</span><br><span class="line">		<span class="title">Window</span>.<span class="title">Callback</span>, <span class="title">KeyEvent</span>.<span class="title">Callback</span>,</span><br><span class="line">		<span class="title">OnCreateContextMenuListener</span>, <span class="title">ComponentCallbacks</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">	......</span><br><span class="line"></span><br><span class="line">	    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">startActivityForResult</span><span class="params">(Intent intent, <span class="keyword">int</span> requestCode)</span> </span>&#123;</span><br><span class="line">        startActivityForResult(intent, requestCode, <span class="keyword">null</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">startActivityForResult</span><span class="params">(Intent intent, <span class="keyword">int</span> requestCode, Bundle options)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (mParent == <span class="keyword">null</span>) &#123;</span><br><span class="line">            Instrumentation.ActivityResult ar =</span><br><span class="line">                mInstrumentation.execStartActivity(</span><br><span class="line">                    <span class="keyword">this</span>, mMainThread.getApplicationThread(), mToken, <span class="keyword">this</span>,</span><br><span class="line">                    intent, requestCode, options);</span><br><span class="line">            <span class="keyword">if</span> (ar != <span class="keyword">null</span>) &#123;</span><br><span class="line">                mMainThread.sendActivityResult(</span><br><span class="line">                    mToken, mEmbeddedID, requestCode, ar.getResultCode(),</span><br><span class="line">                    ar.getResultData());</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">if</span> (requestCode &gt;= <span class="number">0</span>) &#123;</span><br><span class="line">               ......</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">	......</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>调用了mInstrumentation.execStartActivity方法。这里mInstrumentation的类型是Instrumentation，这个类主要用于监视应用程序和系统的交互。定义在frameworks/base/core/java/android/app/Instrumentation.java。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Instrumentation</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">	......</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> ActivityResult <span class="title">execStartActivity</span><span class="params">(</span><br><span class="line">            Context who, IBinder contextThread, IBinder token, Activity target,</span><br><span class="line">            Intent intent, <span class="keyword">int</span> requestCode, Bundle options)</span> </span>&#123;</span><br><span class="line">        IApplicationThread whoThread = (IApplicationThread) contextThread;</span><br><span class="line">        <span class="keyword">if</span> (mActivityMonitors != <span class="keyword">null</span>) &#123;</span><br><span class="line">            ......</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            intent.migrateExtraStreamToClipData();</span><br><span class="line">            intent.prepareToLeaveProcess();</span><br><span class="line">            <span class="keyword">int</span> result = ActivityManagerNative.getDefault()</span><br><span class="line">                .startActivity(whoThread, who.getBasePackageName(), intent,</span><br><span class="line">                        intent.resolveTypeIfNeeded(who.getContentResolver()),</span><br><span class="line">                        token, target != <span class="keyword">null</span> ? target.mEmbeddedID : <span class="keyword">null</span>,</span><br><span class="line">                        requestCode, <span class="number">0</span>, <span class="keyword">null</span>, <span class="keyword">null</span>, options);</span><br><span class="line">            checkStartActivityResult(result, intent);</span><br><span class="line">        &#125; <span class="keyword">catch</span> (RemoteException e) &#123;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">	......</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>到了这还是一个封装。ActivityManagerNative.getDefault返回ActivityManagerProxy，这是ActivityManagerService的一个远程接口。主要用于进程间通信。<br>frameworks/base/core/java/android/app/ActivityManagerNative.java</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">ActivityManagerProxy</span> <span class="keyword">implements</span> <span class="title">IActivityManager</span></span><br><span class="line"></span>&#123;</span><br><span class="line"></span><br><span class="line">	......</span><br><span class="line"></span><br><span class="line">	 <span class="function"><span class="keyword">public</span> <span class="keyword">int</span> <span class="title">startActivity</span><span class="params">(IApplicationThread caller, String callingPackage, Intent intent,</span><br><span class="line">            String resolvedType, IBinder resultTo, String resultWho, <span class="keyword">int</span> requestCode,</span><br><span class="line">            <span class="keyword">int</span> startFlags, String profileFile,</span><br><span class="line">            ParcelFileDescriptor profileFd, Bundle options)</span> <span class="keyword">throws</span> RemoteException </span>&#123;</span><br><span class="line">        Parcel data = Parcel.obtain();</span><br><span class="line">        Parcel reply = Parcel.obtain();</span><br><span class="line">        data.writeInterfaceToken(IActivityManager.descriptor);</span><br><span class="line">        data.writeStrongBinder(caller != <span class="keyword">null</span> ? caller.asBinder() : <span class="keyword">null</span>);</span><br><span class="line">        data.writeString(callingPackage);</span><br><span class="line">        intent.writeToParcel(data, <span class="number">0</span>);</span><br><span class="line">        data.writeString(resolvedType);</span><br><span class="line">        data.writeStrongBinder(resultTo);</span><br><span class="line">        data.writeString(resultWho);</span><br><span class="line">        data.writeInt(requestCode);</span><br><span class="line">        data.writeInt(startFlags);</span><br><span class="line">        data.writeString(profileFile);</span><br><span class="line">        <span class="keyword">if</span> (profileFd != <span class="keyword">null</span>) &#123;</span><br><span class="line">            data.writeInt(<span class="number">1</span>);</span><br><span class="line">            profileFd.writeToParcel(data, Parcelable.PARCELABLE_WRITE_RETURN_VALUE);</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            data.writeInt(<span class="number">0</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> (options != <span class="keyword">null</span>) &#123;</span><br><span class="line">            data.writeInt(<span class="number">1</span>);</span><br><span class="line">            options.writeToParcel(data, <span class="number">0</span>);</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            data.writeInt(<span class="number">0</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        mRemote.transact(START_ACTIVITY_TRANSACTION, data, reply, <span class="number">0</span>);</span><br><span class="line">        reply.readException();</span><br><span class="line">        <span class="keyword">int</span> result = reply.readInt();</span><br><span class="line">        reply.recycle();</span><br><span class="line">        data.recycle();</span><br><span class="line">        <span class="keyword">return</span> result;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">	......</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>这个函数参数很多，我们主要关心caller和resultTo这两个参数。caller是一个ApplicationThread类型的Binder实体，这个ApplicationThread是由startActivityForResult中的mMainThread.getApplicationThread()获得的。在Activity管理过程中最重要的类ActivityManagerService就是通过这个ApplicationThread和进程通信的。参数resultTo为一个Binder实体的远程接口。<br>通过Binder驱动，就会进入到ActivityManagerService的startActivity方法。<br>frameworks/base/services/java/com/android/server/am/ActivityManagerService.java：<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">final</span> <span class="class"><span class="keyword">class</span> <span class="title">ActivityManagerService</span> <span class="keyword">extends</span> <span class="title">ActivityManagerNative</span>  </span><br><span class="line">        <span class="keyword">implements</span> <span class="title">Watchdog</span>.<span class="title">Monitor</span>, <span class="title">BatteryStatsImpl</span>.<span class="title">BatteryCallback</span> </span>&#123;  </span><br><span class="line">  </span><br><span class="line">    ......  </span><br><span class="line">  </span><br><span class="line">   <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">final</span> <span class="keyword">int</span> <span class="title">startActivity</span><span class="params">(IApplicationThread caller, String callingPackage,</span><br><span class="line">            Intent intent, String resolvedType, IBinder resultTo,</span><br><span class="line">            String resultWho, <span class="keyword">int</span> requestCode, <span class="keyword">int</span> startFlags,</span><br><span class="line">            String profileFile, ParcelFileDescriptor profileFd, Bundle options)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> startActivityAsUser(caller, callingPackage, intent, resolvedType, resultTo,</span><br><span class="line">                resultWho, requestCode,</span><br><span class="line">                startFlags, profileFile, profileFd, options, UserHandle.getCallingUserId());</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">final</span> <span class="keyword">int</span> <span class="title">startActivityAsUser</span><span class="params">(IApplicationThread caller, String callingPackage,</span><br><span class="line">            Intent intent, String resolvedType, IBinder resultTo,</span><br><span class="line">            String resultWho, <span class="keyword">int</span> requestCode, <span class="keyword">int</span> startFlags,</span><br><span class="line">            String profileFile, ParcelFileDescriptor profileFd, Bundle options, <span class="keyword">int</span> userId)</span> </span>&#123;</span><br><span class="line">        enforceNotIsolatedCaller(<span class="string">"startActivity"</span>);</span><br><span class="line">        userId = handleIncomingUser(Binder.getCallingPid(), Binder.getCallingUid(), userId,</span><br><span class="line">                <span class="keyword">false</span>, <span class="keyword">true</span>, <span class="string">"startActivity"</span>, <span class="keyword">null</span>);</span><br><span class="line">        <span class="comment">// <span class="doctag">TODO:</span> Switch to user app stacks here.</span></span><br><span class="line">        <span class="keyword">return</span> mStackSupervisor.startActivityMayWait(caller, -<span class="number">1</span>, callingPackage, intent, resolvedType,</span><br><span class="line">                resultTo, resultWho, requestCode, startFlags, profileFile, profileFd,</span><br><span class="line">                <span class="keyword">null</span>, <span class="keyword">null</span>, options, userId);</span><br><span class="line">    &#125;</span><br><span class="line">     ......</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>这里还是一个转发，调用ActivityStackSupervisor.startActivityMayWait函数。<br>在/frameworks/base/services/java/com/android/server/am/ActivityStackSupervisor.java中可以找到定义。<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">final</span> <span class="class"><span class="keyword">class</span> <span class="title">ActivityStackSupervisor</span> </span>&#123;</span><br><span class="line">    <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">boolean</span> DEBUG = ActivityManagerService.DEBUG || <span class="keyword">false</span>;</span><br><span class="line">    <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">boolean</span> DEBUG_ADD_REMOVE = DEBUG || <span class="keyword">false</span>;</span><br><span class="line">	  ...</span><br><span class="line">    <span class="function"><span class="keyword">final</span> <span class="keyword">int</span> <span class="title">startActivityMayWait</span><span class="params">(IApplicationThread caller, <span class="keyword">int</span> callingUid,</span><br><span class="line">            String callingPackage, Intent intent, String resolvedType, IBinder resultTo,</span><br><span class="line">            String resultWho, <span class="keyword">int</span> requestCode, <span class="keyword">int</span> startFlags, String profileFile,</span><br><span class="line">            ParcelFileDescriptor profileFd, WaitResult outResult, Configuration config,</span><br><span class="line">            Bundle options, <span class="keyword">int</span> userId)</span> </span>&#123;</span><br><span class="line">        <span class="comment">// Refuse possible leaked file descriptors</span></span><br><span class="line">        <span class="keyword">if</span> (intent != <span class="keyword">null</span> &amp;&amp; intent.hasFileDescriptors()) &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> IllegalArgumentException(<span class="string">"File descriptors passed in Intent"</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">boolean</span> componentSpecified = intent.getComponent() != <span class="keyword">null</span>;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// Don't modify the client's object!</span></span><br><span class="line">        intent = <span class="keyword">new</span> Intent(intent);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// Collect information about the target of the Intent.</span></span><br><span class="line">        ActivityInfo aInfo = resolveActivity(intent, resolvedType, startFlags,</span><br><span class="line">                profileFile, profileFd, userId);</span><br><span class="line">       ......</span><br><span class="line">         <span class="keyword">int</span> res = startActivityLocked(caller, intent, resolvedType,</span><br><span class="line">                    aInfo, resultTo, resultWho, requestCode, callingPid, callingUid,</span><br><span class="line">                    callingPackage, startFlags, options, componentSpecified, <span class="keyword">null</span>);</span><br><span class="line">       ......</span><br><span class="line">       <span class="keyword">return</span> res;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure></p>
<p>在这个函数中，调用resolveActivity函数解析目标Activity，包括包名，activity名等。然后调用startActivityLocked函数。<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">final</span> <span class="keyword">int</span> <span class="title">startActivityLocked</span><span class="params">(IApplicationThread caller,</span><br><span class="line">    Intent intent, String resolvedType, ActivityInfo aInfo,</span><br><span class="line">    IVoiceInteractionSession voiceSession, IVoiceInteractor voiceInteractor,</span><br><span class="line">    IBinder resultTo, String resultWho, <span class="keyword">int</span> requestCode,</span><br><span class="line">    <span class="keyword">int</span> callingPid, <span class="keyword">int</span> callingUid, String callingPackage,</span><br><span class="line">    <span class="keyword">int</span> realCallingPid, <span class="keyword">int</span> realCallingUid, <span class="keyword">int</span> startFlags, Bundle options,</span><br><span class="line">    <span class="keyword">boolean</span> componentSpecified, ActivityRecord[] outActivity, ActivityContainer container,</span><br><span class="line">    TaskRecord inTask)</span> </span>&#123;</span><br><span class="line">    ...</span><br><span class="line">    <span class="keyword">int</span> err = ActivityManager.START_SUCCESS;</span><br><span class="line">    <span class="comment">//重要的ActivityRecord，用来表示一个Activity实例</span></span><br><span class="line">    ActivityRecord r = <span class="keyword">new</span> ActivityRecord(mService, callerApp, callingUid, callingPackage,</span><br><span class="line">        intent, resolvedType, aInfo, mService.mConfiguration, resultRecord, resultWho,</span><br><span class="line">        requestCode, componentSpecified, <span class="keyword">this</span>, container, options);</span><br><span class="line">    <span class="keyword">if</span> (outActivity != <span class="keyword">null</span>) &#123;</span><br><span class="line">        outActivity[<span class="number">0</span>] = r;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">final</span> ActivityStack stack = getFocusedStack();</span><br><span class="line">    <span class="comment">//启动还未启动Acitvity.mPendingActivityLaunches 调用            startActivityUncheckedLocked()</span></span><br><span class="line">    doPendingActivityLaunchesLocked(<span class="keyword">false</span>);</span><br><span class="line">    err = startActivityUncheckedLocked(r, sourceRecord, voiceSession, voiceInteractor,</span><br><span class="line">        startFlags, <span class="keyword">true</span>, options, inTask);</span><br><span class="line">    ....省略</span><br><span class="line"><span class="keyword">return</span> err;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>这里检测启动权限，发RESULT_CANCELED;new AcitivityRecord对象。然后把还没启动的Activity的启动，然后在启动我们需要Activity。来看startActivityUncheckedLocked。<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">final</span> <span class="keyword">int</span> <span class="title">startActivityUncheckedLocked</span><span class="params">(ActivityRecord r, ActivityRecord sourceRecord,</span><br><span class="line">    IVoiceInteractionSession voiceSession, IVoiceInteractor voiceInteractor, <span class="keyword">int</span> startFlags,<span class="keyword">boolean</span> doResume, Bundle options, TaskRecord inTask)</span> </span>&#123;</span><br><span class="line">     	<span class="keyword">final</span> Intent intent = r.intent;</span><br><span class="line">        <span class="keyword">final</span> <span class="keyword">int</span> callingUid = r.launchedFromUid;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">int</span> launchFlags = intent.getFlags();</span><br><span class="line"></span><br><span class="line">        mUserLeaving = (launchFlags&amp;Intent.FLAG_ACTIVITY_NO_USER_ACTION) == <span class="number">0</span>;</span><br><span class="line">        <span class="keyword">if</span> (DEBUG_USER_LEAVING) Slog.v(TAG, <span class="string">"startActivity() =&gt; mUserLeaving="</span> + mUserLeaving);</span><br><span class="line"></span><br><span class="line">        </span><br><span class="line">        <span class="keyword">if</span> (!doResume) &#123;</span><br><span class="line">            r.delayedResume = <span class="keyword">true</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        ActivityRecord notTop = (launchFlags&amp;Intent.FLAG_ACTIVITY_PREVIOUS_IS_TOP) != <span class="number">0</span> ? r : <span class="keyword">null</span>;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// If the onlyIfNeeded flag is set, then we can do this if the activity</span></span><br><span class="line">        <span class="comment">// being launched is the same as the one making the call...  or, as</span></span><br><span class="line">        <span class="comment">// a special case, if we do not know the caller then we count the</span></span><br><span class="line">        <span class="comment">// current top activity as the caller.</span></span><br><span class="line">        <span class="keyword">if</span> ((startFlags&amp;ActivityManager.START_FLAG_ONLY_IF_NEEDED) != <span class="number">0</span>) &#123;</span><br><span class="line">            ActivityRecord checkedCaller = sourceRecord;</span><br><span class="line">            <span class="keyword">if</span> (checkedCaller == <span class="keyword">null</span>) &#123;</span><br><span class="line">                checkedCaller = getFocusedStack().topRunningNonDelayedActivityLocked(notTop);</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">if</span> (!checkedCaller.realActivity.equals(r.realActivity)) &#123;</span><br><span class="line">                <span class="comment">// Caller is not the same as launcher, so always needed.</span></span><br><span class="line">                startFlags &amp;= ~ActivityManager.START_FLAG_ONLY_IF_NEEDED;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (sourceRecord == <span class="keyword">null</span>) &#123;</span><br><span class="line">            <span class="comment">// This activity is not being started from another...  in this</span></span><br><span class="line">            <span class="comment">// case we -always- start a new task.</span></span><br><span class="line">            <span class="keyword">if</span> ((launchFlags&amp;Intent.FLAG_ACTIVITY_NEW_TASK) == <span class="number">0</span>) &#123;</span><br><span class="line">                Slog.w(TAG, <span class="string">"startActivity called from non-Activity context; forcing "</span> +</span><br><span class="line">                        <span class="string">"Intent.FLAG_ACTIVITY_NEW_TASK for: "</span> + intent);</span><br><span class="line">                launchFlags |= Intent.FLAG_ACTIVITY_NEW_TASK;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (sourceRecord.launchMode == ActivityInfo.LAUNCH_SINGLE_INSTANCE) &#123;</span><br><span class="line">            <span class="comment">// The original activity who is starting us is running as a single</span></span><br><span class="line">            <span class="comment">// instance...  this new activity it is starting must go on its</span></span><br><span class="line">            <span class="comment">// own task.</span></span><br><span class="line">            launchFlags |= Intent.FLAG_ACTIVITY_NEW_TASK;</span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (r.launchMode == ActivityInfo.LAUNCH_SINGLE_INSTANCE</span><br><span class="line">                || r.launchMode == ActivityInfo.LAUNCH_SINGLE_TASK) &#123;</span><br><span class="line">            <span class="comment">// The activity being started is a single instance...  it always</span></span><br><span class="line">            <span class="comment">// gets launched into its own task.</span></span><br><span class="line">            launchFlags |= Intent.FLAG_ACTIVITY_NEW_TASK;</span><br><span class="line">        &#125;</span><br><span class="line">        ......</span><br><span class="line">        <span class="keyword">boolean</span> addingToTask = <span class="keyword">false</span>;</span><br><span class="line">        <span class="keyword">boolean</span> movedHome = <span class="keyword">false</span>;</span><br><span class="line">        TaskRecord reuseTask = <span class="keyword">null</span>;</span><br><span class="line">        ActivityStack targetStack;</span><br><span class="line">        <span class="keyword">if</span> (((launchFlags&amp;Intent.FLAG_ACTIVITY_NEW_TASK) != <span class="number">0</span> &amp;&amp;</span><br><span class="line">                (launchFlags&amp;Intent.FLAG_ACTIVITY_MULTIPLE_TASK) == <span class="number">0</span>)</span><br><span class="line">                || r.launchMode == ActivityInfo.LAUNCH_SINGLE_TASK</span><br><span class="line">                || r.launchMode == ActivityInfo.LAUNCH_SINGLE_INSTANCE) &#123;</span><br><span class="line">            <span class="comment">// If bring to front is requested, and no result is requested, and</span></span><br><span class="line">            <span class="comment">// we can find a task that was started with this same</span></span><br><span class="line">            <span class="comment">// component, then instead of launching bring that one to the front.</span></span><br><span class="line">            <span class="keyword">if</span> (r.resultTo == <span class="keyword">null</span>) &#123;</span><br><span class="line">                <span class="comment">// See if there is a task to bring to the front.  If this is</span></span><br><span class="line">                <span class="comment">// a SINGLE_INSTANCE activity, there can be one and only one</span></span><br><span class="line">                <span class="comment">// instance of it in the history, and it is always in its own</span></span><br><span class="line">                <span class="comment">// unique task, so we do a special search.</span></span><br><span class="line">                ActivityRecord intentActivity = r.launchMode != ActivityInfo.LAUNCH_SINGLE_INSTANCE</span><br><span class="line">                        ? findTaskLocked(r)</span><br><span class="line">                        : findActivityLocked(intent, r.info);</span><br><span class="line">                <span class="keyword">if</span> (intentActivity != <span class="keyword">null</span>) &#123;</span><br><span class="line">                    <span class="keyword">if</span> (r.task == <span class="keyword">null</span>) &#123;</span><br><span class="line">                        r.task = intentActivity.task;</span><br><span class="line">                    &#125;</span><br><span class="line">         ......</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (r.packageName != <span class="keyword">null</span>) &#123;</span><br><span class="line">            <span class="comment">// If the activity being launched is the same as the one currently</span></span><br><span class="line">            <span class="comment">// at the top, then we need to check if it should only be launched</span></span><br><span class="line">            <span class="comment">// once.</span></span><br><span class="line">            ActivityStack topStack = getFocusedStack();</span><br><span class="line">            ActivityRecord top = topStack.topRunningNonDelayedActivityLocked(notTop);</span><br><span class="line">            <span class="keyword">if</span> (top != <span class="keyword">null</span> &amp;&amp; r.resultTo == <span class="keyword">null</span>) &#123;</span><br><span class="line">                <span class="keyword">if</span> (top.realActivity.equals(r.realActivity) &amp;&amp; top.userId == r.userId) &#123;</span><br><span class="line">                    <span class="keyword">if</span> (top.app != <span class="keyword">null</span> &amp;&amp; top.app.thread != <span class="keyword">null</span>) &#123;</span><br><span class="line">                        <span class="keyword">if</span> ((launchFlags&amp;Intent.FLAG_ACTIVITY_SINGLE_TOP) != <span class="number">0</span></span><br><span class="line">                            || r.launchMode == ActivityInfo.LAUNCH_SINGLE_TOP</span><br><span class="line">                            || r.launchMode == ActivityInfo.LAUNCH_SINGLE_TASK) &#123;</span><br><span class="line">                            ActivityStack.logStartActivity(EventLogTags.AM_NEW_INTENT, top,</span><br><span class="line">                                    top.task);</span><br><span class="line">                            <span class="comment">// For paranoia, make sure we have correctly</span></span><br><span class="line">                            <span class="comment">// resumed the top activity.</span></span><br><span class="line">                            topStack.mLastPausedActivity = <span class="keyword">null</span>;</span><br><span class="line">                            <span class="keyword">if</span> (doResume) &#123;</span><br><span class="line">                                resumeTopActivitiesLocked();</span><br><span class="line">                           &#125;</span><br><span class="line">         ...</span><br><span class="line">         <span class="comment">// Should this be considered a new task?</span></span><br><span class="line">        <span class="keyword">if</span> (r.resultTo == <span class="keyword">null</span> &amp;&amp; !addingToTask</span><br><span class="line">                &amp;&amp; (launchFlags&amp;Intent.FLAG_ACTIVITY_NEW_TASK) != <span class="number">0</span>) &#123;</span><br><span class="line">            targetStack = adjustStackFocus(r);</span><br><span class="line">            moveHomeStack(targetStack.isHomeStack());</span><br><span class="line">            <span class="keyword">if</span> (reuseTask == <span class="keyword">null</span>) &#123;</span><br><span class="line">                r.setTask(targetStack.createTaskRecord(getNextTaskId(),</span><br><span class="line">                        newTaskInfo != <span class="keyword">null</span> ? newTaskInfo : r.info,</span><br><span class="line">                        newTaskIntent != <span class="keyword">null</span> ? newTaskIntent : intent,</span><br><span class="line">                        <span class="keyword">true</span>), <span class="keyword">null</span>, <span class="keyword">true</span>);</span><br><span class="line">                <span class="keyword">if</span> (DEBUG_TASKS) Slog.v(TAG, <span class="string">"Starting new activity "</span> + r + <span class="string">" in new task "</span> +</span><br><span class="line">                        r.task);</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                r.setTask(reuseTask, reuseTask, <span class="keyword">true</span>);</span><br><span class="line">            &#125;</span><br><span class="line">            newTask = <span class="keyword">true</span>;</span><br><span class="line">            <span class="keyword">if</span> (!movedHome) &#123;</span><br><span class="line">                <span class="keyword">if</span> ((launchFlags &amp;</span><br><span class="line">                        (Intent.FLAG_ACTIVITY_NEW_TASK|Intent.FLAG_ACTIVITY_TASK_ON_HOME))</span><br><span class="line">                        == (Intent.FLAG_ACTIVITY_NEW_TASK|Intent.FLAG_ACTIVITY_TASK_ON_HOME)) &#123;</span><br><span class="line">                    <span class="comment">// Caller wants to appear on home activity, so before starting</span></span><br><span class="line">                    <span class="comment">// their own activity we will bring home to the front.</span></span><br><span class="line">                    r.task.mOnTopOfHome = <span class="keyword">true</span>;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (sourceRecord != <span class="keyword">null</span>) &#123;</span><br><span class="line">		...</span><br><span class="line">        </span><br><span class="line">        mService.grantUriPermissionFromIntentLocked(callingUid, r.packageName,</span><br><span class="line">                intent, r.getUriPermissionsLocked());</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (newTask) &#123;</span><br><span class="line">            EventLog.writeEvent(EventLogTags.AM_CREATE_TASK, r.userId, r.task.taskId);</span><br><span class="line">        &#125;</span><br><span class="line">        ActivityStack.logStartActivity(EventLogTags.AM_CREATE_ACTIVITY, r, r.task);</span><br><span class="line">        targetStack.mLastPausedActivity = <span class="keyword">null</span>;</span><br><span class="line">        targetStack.startActivityLocked(r, newTask, doResume, keepCurTransition, options);</span><br><span class="line">        mService.setFocusedActivityLocked(r);</span><br><span class="line">        <span class="keyword">return</span> ActivityManager.START_SUCCESS;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>这个函数很长，主要的功能就是根据传过来的参数，设置启动模式。这里的launchMode是在AndroidManifest.xml中配置的。没有配置默认为0，表示以标准（Standard，或者称为ActivityInfo.LAUNCH_MULTIPLE）的方式来启动这个Activity。Activity的启动方式有四种，其余三种分别是ActivityInfo.LAUNCH_SINGLE_INSTANCE、ActivityInfo.LAUNCH_SINGLE_TASK和ActivityInfo.LAUNCH_SINGLE_TOP，具体可以参考官方网站<a href="http://developer.android.com/reference/android/content/pm/ActivityInfo.html。" target="_blank" rel="external">http://developer.android.com/reference/android/content/pm/ActivityInfo.html。</a><br>如果传进来的参数r.resultTo为null，表示Launcher不需要等这个即将要启动的MainActivity的执行结果。</p>
<p>从Launcher传过来的intent的标志值的位Intent.FLAG_ACTIVITY_NEW_TASK被置位，Intent.FLAG_ACTIVITY_MULTIPLE_TASK没有置位。因此，下面的if语句会被执行<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> (((launchFlags&amp;Intent.FLAG_ACTIVITY_NEW_TASK) != <span class="number">0</span> &amp;&amp;</span><br><span class="line">          (launchFlags&amp;Intent.FLAG_ACTIVITY_MULTIPLE_TASK) == <span class="number">0</span>)</span><br><span class="line">          || r.launchMode == ActivityInfo.LAUNCH_SINGLE_TASK</span><br><span class="line">          || r.launchMode == ActivityInfo.LAUNCH_SINGLE_INSTANCE) &#123;</span><br><span class="line">      <span class="comment">// If bring to front is requested, and no result is requested, and</span></span><br><span class="line">      <span class="comment">// we can find a task that was started with this same</span></span><br><span class="line">      <span class="comment">// component, then instead of launching bring that one to the front.</span></span><br><span class="line">      <span class="keyword">if</span> (r.resultTo == <span class="keyword">null</span>) &#123;</span><br><span class="line">          <span class="comment">// See if there is a task to bring to the front.  If this is</span></span><br><span class="line">          <span class="comment">// a SINGLE_INSTANCE activity, there can be one and only one</span></span><br><span class="line">          <span class="comment">// instance of it in the history, and it is always in its own</span></span><br><span class="line">          <span class="comment">// unique task, so we do a special search.</span></span><br><span class="line">          ActivityRecord intentActivity = r.launchMode != ActivityInfo.LAUNCH_SINGLE_INSTANCE</span><br><span class="line">                  ? findTaskLocked(r)</span><br><span class="line">                  : findActivityLocked(intent, r.info);</span><br><span class="line">          <span class="keyword">if</span> (intentActivity != <span class="keyword">null</span>) &#123;</span><br><span class="line">              <span class="keyword">if</span> (r.task == <span class="keyword">null</span>) &#123;</span><br><span class="line">                  r.task = intentActivity.task;</span><br></pre></td></tr></table></figure></p>
<p>因为launchMode不是ActivityInfo.LAUNCH_SINGLE_INSTANCE，所以这里通过findTaskLocked来查找是否存在一个Task来执行这个Activity，如果返回null，就表示需要创建一个新的Task来启动这个Activity。(Task是一个进程的所有ActivityStack的组合)<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> (r.packageName != <span class="keyword">null</span>) &#123;</span><br><span class="line">     <span class="comment">// If the activity being launched is the same as the one currently</span></span><br><span class="line">     <span class="comment">// at the top, then we need to check if it should only be launched</span></span><br><span class="line">     <span class="comment">// once.</span></span><br><span class="line">     ActivityStack topStack = getFocusedStack();</span><br><span class="line">     ActivityRecord top = topStack.topRunningNonDelayedActivityLocked(notTop);</span><br><span class="line">     <span class="keyword">if</span> (top != <span class="keyword">null</span> &amp;&amp; r.resultTo == <span class="keyword">null</span>) &#123;</span><br><span class="line">         <span class="keyword">if</span> (top.realActivity.equals(r.realActivity) &amp;&amp; top.userId == r.userId) &#123;</span><br><span class="line">             <span class="keyword">if</span> (top.app != <span class="keyword">null</span> &amp;&amp; top.app.thread != <span class="keyword">null</span>) &#123;</span><br><span class="line">                 <span class="keyword">if</span> ((launchFlags&amp;Intent.FLAG_ACTIVITY_SINGLE_TOP) != <span class="number">0</span></span><br><span class="line">                     || r.launchMode == ActivityInfo.LAUNCH_SINGLE_TOP</span><br><span class="line">                     || r.launchMode == ActivityInfo.LAUNCH_SINGLE_TASK) &#123;</span><br><span class="line">                     ActivityStack.logStartActivity(EventLogTags.AM_NEW_INTENT, top,</span><br><span class="line">                             top.task);</span><br><span class="line">                     <span class="comment">// For paranoia, make sure we have correctly</span></span><br><span class="line">                     <span class="comment">// resumed the top activity.</span></span><br><span class="line">                     topStack.mLastPausedActivity = <span class="keyword">null</span>;</span><br><span class="line">                     <span class="keyword">if</span> (doResume) &#123;</span><br></pre></td></tr></table></figure></p>
<p>接下来判断当前在堆栈顶端的Activity是否就是即将要启动的Activity，有些情况下，如果即将要启动的Activity就在堆栈的顶端，那么，就不会重新启动这个Activity的别一个实例了，具体可以参考官方网站<a href="http://developer.android.com/reference/android/content/pm/ActivityInfo.html。" target="_blank" rel="external">http://developer.android.com/reference/android/content/pm/ActivityInfo.html。</a><br>现在处理堆栈顶端的Activity是Launcher，与我们即将要启动的MainActivity不是同一个Activity，因此，这里不用进一步处理上述介绍的情况。<br>接着往下看：<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// Should this be considered a new task?</span></span><br><span class="line">      <span class="keyword">if</span> (r.resultTo == <span class="keyword">null</span> &amp;&amp; !addingToTask</span><br><span class="line">              &amp;&amp; (launchFlags&amp;Intent.FLAG_ACTIVITY_NEW_TASK) != <span class="number">0</span>) &#123;</span><br><span class="line">          targetStack = adjustStackFocus(r);</span><br><span class="line">          moveHomeStack(targetStack.isHomeStack());</span><br><span class="line">          <span class="keyword">if</span> (reuseTask == <span class="keyword">null</span>) &#123;</span><br><span class="line">              r.setTask(targetStack.createTaskRecord(getNextTaskId(),</span><br><span class="line">                      newTaskInfo != <span class="keyword">null</span> ? newTaskInfo : r.info,</span><br><span class="line">                      newTaskIntent != <span class="keyword">null</span> ? newTaskIntent : intent,</span><br><span class="line">                      <span class="keyword">true</span>), <span class="keyword">null</span>, <span class="keyword">true</span>);</span><br><span class="line">              <span class="keyword">if</span> (DEBUG_TASKS) Slog.v(TAG, <span class="string">"Starting new activity "</span> + r + <span class="string">" in new task "</span> +</span><br><span class="line">                      r.task);</span><br></pre></td></tr></table></figure></p>
<p>这里就是新建了一个Task。然后调用了ActivityStack的startActivityLocked。<br>frameworks/base/services/java/com/android/server/am/ActivityStack.java：<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">final</span> <span class="keyword">void</span> <span class="title">startActivityLocked</span><span class="params">(ActivityRecord r, <span class="keyword">boolean</span> newTask,</span><br><span class="line">           <span class="keyword">boolean</span> doResume, <span class="keyword">boolean</span> keepCurTransition, Bundle options)</span> </span>&#123;</span><br><span class="line">		TaskRecord rTask = r.task;</span><br><span class="line">       <span class="keyword">final</span> <span class="keyword">int</span> taskId = rTask.taskId;</span><br><span class="line">       <span class="keyword">if</span> (taskForIdLocked(taskId) == <span class="keyword">null</span> || newTask) &#123;</span><br><span class="line">           <span class="comment">// Last activity in task had been removed or ActivityManagerService is reusing task.</span></span><br><span class="line">           <span class="comment">// Insert or replace.</span></span><br><span class="line">           <span class="comment">// Might not even be in.</span></span><br><span class="line">           insertTaskAtTop(rTask);</span><br><span class="line">           mWindowManager.moveTaskToTop(taskId);</span><br><span class="line">       &#125;</span><br><span class="line">       TaskRecord task = <span class="keyword">null</span>;</span><br><span class="line">       <span class="keyword">if</span> (!newTask) &#123;</span><br><span class="line">           <span class="comment">// If starting in an existing task, find where that is...</span></span><br><span class="line">           <span class="keyword">boolean</span> startIt = <span class="keyword">true</span>;</span><br><span class="line">           <span class="keyword">for</span> (<span class="keyword">int</span> taskNdx = mTaskHistory.size() - <span class="number">1</span>; taskNdx &gt;= <span class="number">0</span>; --taskNdx) &#123;</span><br><span class="line">               task = mTaskHistory.get(taskNdx);</span><br><span class="line">               <span class="keyword">if</span> (task == r.task) &#123;</span><br><span class="line">                   <span class="comment">// Here it is!  Now, if this is not yet visible to the</span></span><br><span class="line">                   <span class="comment">// user, then just add it without starting; it will</span></span><br><span class="line">                   <span class="comment">// get started when the user navigates back to it.</span></span><br><span class="line">                   <span class="keyword">if</span> (!startIt) &#123;</span><br><span class="line">                       <span class="keyword">if</span> (DEBUG_ADD_REMOVE) Slog.i(TAG, <span class="string">"Adding activity "</span> + r + <span class="string">" to task "</span></span><br><span class="line">                               + task, <span class="keyword">new</span> RuntimeException(<span class="string">"here"</span>).fillInStackTrace());</span><br><span class="line">                       task.addActivityToTop(r);</span><br><span class="line">                       r.putInHistory();</span><br><span class="line">                       mWindowManager.addAppToken(task.mActivities.indexOf(r), r.appToken,</span><br><span class="line">                               r.task.taskId, mStackId, r.info.screenOrientation, r.fullscreen,</span><br><span class="line">                               (r.info.flags &amp; ActivityInfo.FLAG_SHOW_ON_LOCK_SCREEN) != <span class="number">0</span>,</span><br><span class="line">                               r.userId, r.info.configChanges);</span><br><span class="line">                       <span class="keyword">if</span> (VALIDATE_TOKENS) &#123;</span><br><span class="line">                           validateAppTokensLocked();</span><br><span class="line">                       &#125;</span><br><span class="line">                       ActivityOptions.abort(options);</span><br><span class="line">                       <span class="keyword">return</span>;</span><br><span class="line">                   &#125;</span><br><span class="line">                   <span class="keyword">break</span>;</span><br><span class="line">               &#125; <span class="keyword">else</span> <span class="keyword">if</span> (task.numFullscreen &gt; <span class="number">0</span>) &#123;</span><br><span class="line">                   startIt = <span class="keyword">false</span>;</span><br><span class="line">               &#125;</span><br><span class="line">           &#125;</span><br><span class="line">       &#125;</span><br><span class="line">       ......</span><br><span class="line">       <span class="keyword">if</span> (doResume) &#123;</span><br><span class="line">           mStackSupervisor.resumeTopActivitiesLocked();</span><br><span class="line">       &#125;</span><br></pre></td></tr></table></figure></p>
<p>这里主要调用了addActivityToTop(),把需要加入Activity加栈顶，然后调用ActivityStackSupervisor的resumeTopActivitiesLocked()。<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">boolean</span> <span class="title">resumeTopActivitiesLocked</span><span class="params">(ActivityStack targetStack, ActivityRecord target,</span><br><span class="line">        Bundle targetOptions)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (targetStack == <span class="keyword">null</span>) &#123;</span><br><span class="line">        targetStack = getFocusedStack();</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">boolean</span> result = <span class="keyword">false</span>;</span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">int</span> stackNdx = mStacks.size() - <span class="number">1</span>; stackNdx &gt;= <span class="number">0</span>; --stackNdx) &#123;</span><br><span class="line">        <span class="keyword">final</span> ActivityStack stack = mStacks.get(stackNdx);</span><br><span class="line">        <span class="keyword">if</span> (isFrontStack(stack)) &#123;</span><br><span class="line">            <span class="keyword">if</span> (stack == targetStack) &#123;</span><br><span class="line">                result = stack.resumeTopActivityLocked(target, targetOptions);</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                stack.resumeTopActivityLocked(<span class="keyword">null</span>);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> result;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>这个函数找到需要启动的ActivityStack，调用targetStack.resumeTopActivityLocked方法。<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">final</span> <span class="keyword">boolean</span> <span class="title">resumeTopActivityInnerLocked</span><span class="params">(ActivityRecord prev, Bundle options)</span> </span>&#123;</span><br><span class="line">... </span><br><span class="line">next : com.app.monitor.demo/.MainActivity t932&#125;</span><br><span class="line">ActivityRecord next = topRunningActivityLocked(<span class="keyword">null</span>);</span><br><span class="line">....</span><br><span class="line"><span class="keyword">final</span> TaskRecord nextTask = next.task;</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> (mResumedActivity != <span class="keyword">null</span>) &#123;</span><br><span class="line">    <span class="comment">//暂停当前Activity</span></span><br><span class="line">    pausing |= startPausingLocked(userLeaving, <span class="keyword">false</span>, <span class="keyword">true</span>, dontWaitForPause);</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">if</span> (pausing) &#123;</span><br><span class="line">    <span class="comment">//next.app.thread 还没建</span></span><br><span class="line">    <span class="keyword">if</span> (next.app != <span class="keyword">null</span> &amp;&amp; next.app.thread != <span class="keyword">null</span>) &#123;</span><br><span class="line">        mService.updateLruProcessLocked(next.app, <span class="keyword">true</span>, <span class="keyword">null</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (DEBUG_STACK) mStackSupervisor.validateTopActivitiesLocked();</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">true</span>;</span><br><span class="line">&#125;</span><br><span class="line"> AppGlobals.getPackageManager().setPackageStoppedState(</span><br><span class="line">            next.packageName, <span class="keyword">false</span>, next.userId);</span><br><span class="line"></span><br><span class="line"><span class="comment">//停了当前Activity，下面开始启动DemoActivity;</span></span><br><span class="line"><span class="keyword">boolean</span> anim = <span class="keyword">true</span>;</span><br><span class="line"><span class="keyword">if</span> (prev != <span class="keyword">null</span>) &#123;</span><br><span class="line">    <span class="keyword">if</span> (prev.finishing) &#123;</span><br><span class="line">       <span class="comment">//擦屁股事情要做一下</span></span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="comment">//准备下一个Activity显示，过渡事情；</span></span><br><span class="line">        ...</span><br><span class="line">    &#125;</span><br><span class="line">    ...</span><br><span class="line">&#125;</span><br><span class="line">...</span><br><span class="line">ActivityStack lastStack = mStackSupervisor.getLastStack();</span><br><span class="line"><span class="keyword">if</span> (next.app != <span class="keyword">null</span> &amp;&amp; next.app.thread != <span class="keyword">null</span>) &#123;</span><br><span class="line"><span class="comment">//程序还没启动，这个暂时不看</span></span><br><span class="line">....</span><br><span class="line">&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    ...</span><br><span class="line">    这里开始调用了ActivityStackSupervisor.startSpecificActivityLocked(); </span><br><span class="line">    mStackSupervisor.startSpecificActivityLocked(next, <span class="keyword">true</span>, <span class="keyword">true</span>);</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">return</span> <span class="keyword">true</span>;</span><br><span class="line"> &#125;</span><br></pre></td></tr></table></figure></p>
<p>找到ActivityStack后，先暂停当前的Activity，即当前luncher;停了之后在启动当前的Activity；这里，我们先看系统如何停止当前的Activity，然后在看如何启动Activity。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br></pre></td><td class="code"><pre><span class="line"><span class="function">inal <span class="keyword">boolean</span> <span class="title">startPausingLocked</span><span class="params">(<span class="keyword">boolean</span> userLeaving, <span class="keyword">boolean</span> uiSleeping, <span class="keyword">boolean</span> resuming,</span><br><span class="line">    <span class="keyword">boolean</span> dontWait)</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">ActivityRecord prev = mResumedActivity;</span><br><span class="line">...</span><br><span class="line"><span class="comment">//自己是父，pausing自己所有子Activity</span></span><br><span class="line"><span class="keyword">if</span> (mActivityContainer.mParentActivity == <span class="keyword">null</span>) &#123;</span><br><span class="line">    <span class="comment">// Top level stack, not a child. Look for child stacks.</span></span><br><span class="line">    mStackSupervisor.pauseChildStacks(prev, userLeaving, uiSleeping, resuming, dontWait);</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">//改变当前Activity的状态未pausing</span></span><br><span class="line">mResumedActivity = <span class="keyword">null</span>;</span><br><span class="line">mPausingActivity = prev;</span><br><span class="line">mLastPausedActivity = prev;</span><br><span class="line">mLastNoHistoryActivity = (prev.intent.getFlags() &amp; Intent.FLAG_ACTIVITY_NO_HISTORY) != <span class="number">0</span></span><br><span class="line">        || (prev.info.flags &amp; ActivityInfo.FLAG_NO_HISTORY) != <span class="number">0</span> ? prev : <span class="keyword">null</span>;</span><br><span class="line"></span><br><span class="line">prev.state = ActivityState.PAUSING;</span><br><span class="line">prev.task.touchActiveTime();</span><br><span class="line">clearLaunchTime(prev);</span><br><span class="line"><span class="keyword">final</span> ActivityRecord next = mStackSupervisor.topRunningActivityLocked();</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> (prev.app != <span class="keyword">null</span> &amp;&amp; prev.app.thread != <span class="keyword">null</span>) &#123;</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        ....</span><br><span class="line">       <span class="comment">//这里真正干pause事情了</span></span><br><span class="line">        prev.app.thread.schedulePauseActivity(prev.appToken, prev.finishing,</span><br><span class="line">                userLeaving, prev.configChangeFlags, dontWait);</span><br><span class="line">    &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">    &#125;</span><br><span class="line">&#125; </span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> (!mService.isSleepingOrShuttingDown()) &#123;</span><br><span class="line">    mStackSupervisor.acquireLaunchWakelock();</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> (mPausingActivity != <span class="keyword">null</span>) &#123;</span><br><span class="line">    <span class="keyword">if</span> (dontWait) &#123;</span><br><span class="line">    ...</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    <span class="comment">//这个做一次暂停任务检测，看看在这个时间段内有没有执行完</span></span><br><span class="line">        Message msg = mHandler.obtainMessage(PAUSE_TIMEOUT_MSG);</span><br><span class="line">        msg.obj = prev;</span><br><span class="line">        prev.pauseTime = SystemClock.uptimeMillis();</span><br><span class="line">        mHandler.sendMessageDelayed(msg, PAUSE_TIMEOUT);</span><br><span class="line">        <span class="keyword">if</span> (DEBUG_PAUSE) Slog.v(TAG, <span class="string">"Waiting for pause to complete..."</span>);</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">true</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>这里的perv.app.thread即使app_process进程。通过调用这个进程的schedulePauseActivity方法暂停当前Activity。<br>接下来调用了mStackSupervisor.startSpecificActivityLocked方法启动Activity。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line"> <span class="function"><span class="keyword">void</span> <span class="title">startSpecificActivityLocked</span><span class="params">(ActivityRecord r,</span><br><span class="line">          <span class="keyword">boolean</span> andResume, <span class="keyword">boolean</span> checkConfig)</span> </span>&#123;</span><br><span class="line">      <span class="comment">// Is this activity's application already running?</span></span><br><span class="line">      ProcessRecord app = mService.getProcessRecordLocked(r.processName,</span><br><span class="line">              r.info.applicationInfo.uid, <span class="keyword">true</span>);</span><br><span class="line"></span><br><span class="line">      r.task.stack.setLaunchTime(r);</span><br><span class="line"><span class="comment">//如果进程存在则不需要启动进程，否则启动进程</span></span><br><span class="line">      <span class="keyword">if</span> (app != <span class="keyword">null</span> &amp;&amp; app.thread != <span class="keyword">null</span>) &#123;</span><br><span class="line">          <span class="keyword">try</span> &#123;</span><br><span class="line">              <span class="keyword">if</span> ((r.info.flags&amp;ActivityInfo.FLAG_MULTIPROCESS) == <span class="number">0</span></span><br><span class="line">                      || !<span class="string">"android"</span>.equals(r.info.packageName)) &#123;</span><br><span class="line">                  <span class="comment">// Don't add this if it is a platform component that is marked</span></span><br><span class="line">                  <span class="comment">// to run in multiple processes, because this is actually</span></span><br><span class="line">                  <span class="comment">// part of the framework so doesn't make sense to track as a</span></span><br><span class="line">                  <span class="comment">// separate apk in the process.</span></span><br><span class="line">                  app.addPackage(r.info.packageName, mService.mProcessStats);</span><br><span class="line">              &#125;</span><br><span class="line">              realStartActivityLocked(r, app, andResume, checkConfig);</span><br><span class="line">              <span class="keyword">return</span>;</span><br><span class="line">          &#125; <span class="keyword">catch</span> (RemoteException e) &#123;</span><br><span class="line">              Slog.w(TAG, <span class="string">"Exception when starting activity "</span></span><br><span class="line">                      + r.intent.getComponent().flattenToShortString(), e);</span><br><span class="line">          &#125;</span><br><span class="line"></span><br><span class="line">          <span class="comment">// If a dead object exception was thrown -- fall through to</span></span><br><span class="line">          <span class="comment">// restart the application.</span></span><br><span class="line">      &#125;</span><br><span class="line"></span><br><span class="line">      mService.startProcessLocked(r.processName, r.info.applicationInfo, <span class="keyword">true</span>, <span class="number">0</span>,</span><br><span class="line">              <span class="string">"activity"</span>, r.intent.getComponent(), <span class="keyword">false</span>, <span class="keyword">false</span>, <span class="keyword">true</span>);</span><br><span class="line">  &#125;</span><br></pre></td></tr></table></figure>
<p>这里其实还是调用ActivityManagerService的startProcessLocked方法来启动process。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">final</span> ProcessRecord <span class="title">startProcessLocked</span><span class="params">(String processName,</span><br><span class="line">          ApplicationInfo info, <span class="keyword">boolean</span> knownToBeDead, <span class="keyword">int</span> intentFlags,</span><br><span class="line">          String hostingType, ComponentName hostingName, <span class="keyword">boolean</span> allowWhileBooting,</span><br><span class="line">          <span class="keyword">boolean</span> isolated, <span class="keyword">boolean</span> keepIfLarge)</span> </span>&#123;</span><br><span class="line">      ProcessRecord app;</span><br><span class="line">      <span class="keyword">if</span> (!isolated) &#123;</span><br><span class="line">      	<span class="comment">//通过进程名和uid来获得一个ProcessRecord对象</span></span><br><span class="line">          app = getProcessRecordLocked(processName, info.uid, keepIfLarge);</span><br><span class="line">      &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">          <span class="comment">// If this is an isolated process, it can't re-use an existing process.</span></span><br><span class="line">          app = <span class="keyword">null</span>;</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="comment">// We don't have to do anything more if:</span></span><br><span class="line">      <span class="comment">// (1) There is an existing application record; and</span></span><br><span class="line">      <span class="comment">// (2) The caller doesn't think it is dead, OR there is no thread</span></span><br><span class="line">      <span class="comment">//     object attached to it so we know it couldn't have crashed; and</span></span><br><span class="line">      <span class="comment">// (3) There is a pid assigned to it, so it is either starting or</span></span><br><span class="line">      <span class="comment">//     already running.</span></span><br><span class="line">      <span class="keyword">if</span> (DEBUG_PROCESSES) Slog.v(TAG, <span class="string">"startProcess: name="</span> + processName</span><br><span class="line">              + <span class="string">" app="</span> + app + <span class="string">" knownToBeDead="</span> + knownToBeDead</span><br><span class="line">              + <span class="string">" thread="</span> + (app != <span class="keyword">null</span> ? app.thread : <span class="keyword">null</span>)</span><br><span class="line">              + <span class="string">" pid="</span> + (app != <span class="keyword">null</span> ? app.pid : -<span class="number">1</span>));</span><br><span class="line">      <span class="keyword">if</span> (app != <span class="keyword">null</span> &amp;&amp; app.pid &gt; <span class="number">0</span>) &#123;</span><br><span class="line">          <span class="keyword">if</span> (!knownToBeDead || app.thread == <span class="keyword">null</span>) &#123;</span><br><span class="line">              <span class="comment">// We already have the app running, or are waiting for it to</span></span><br><span class="line">              <span class="comment">// come up (we have a pid but not yet its thread), so keep it.</span></span><br><span class="line">              <span class="keyword">if</span> (DEBUG_PROCESSES) Slog.v(TAG, <span class="string">"App already running: "</span> + app);</span><br><span class="line">              <span class="comment">// If this is a new package in the process, add the package to the list</span></span><br><span class="line">              app.addPackage(info.packageName, mProcessStats);</span><br><span class="line">              <span class="keyword">return</span> app;</span><br><span class="line">          &#125;</span><br><span class="line"></span><br><span class="line">          <span class="comment">// An application record is attached to a previous process,</span></span><br><span class="line">          <span class="comment">// clean it up now.</span></span><br><span class="line">          <span class="keyword">if</span> (DEBUG_PROCESSES || DEBUG_CLEANUP) Slog.v(TAG, <span class="string">"App died: "</span> + app);</span><br><span class="line">          handleAppDiedLocked(app, <span class="keyword">true</span>, <span class="keyword">true</span>);</span><br><span class="line">      &#125;</span><br><span class="line"></span><br><span class="line">      String hostingNameStr = hostingName != <span class="keyword">null</span></span><br><span class="line">              ? hostingName.flattenToShortString() : <span class="keyword">null</span>;</span><br><span class="line"></span><br><span class="line">      <span class="keyword">if</span> (!isolated) &#123;</span><br><span class="line">          <span class="keyword">if</span> ((intentFlags&amp;Intent.FLAG_FROM_BACKGROUND) != <span class="number">0</span>) &#123;</span><br><span class="line">              <span class="comment">// If we are in the background, then check to see if this process</span></span><br><span class="line">              <span class="comment">// is bad.  If so, we will just silently fail.</span></span><br><span class="line">              <span class="keyword">if</span> (mBadProcesses.get(info.processName, info.uid) != <span class="keyword">null</span>) &#123;</span><br><span class="line">                  <span class="keyword">if</span> (DEBUG_PROCESSES) Slog.v(TAG, <span class="string">"Bad process: "</span> + info.uid</span><br><span class="line">                          + <span class="string">"/"</span> + info.processName);</span><br><span class="line">                  <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">              &#125;</span><br><span class="line">          &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">              <span class="comment">// When the user is explicitly starting a process, then clear its</span></span><br><span class="line">              <span class="comment">// crash count so that we won't make it bad until they see at</span></span><br><span class="line">              <span class="comment">// least one crash dialog again, and make the process good again</span></span><br><span class="line">              <span class="comment">// if it had been bad.</span></span><br><span class="line">              <span class="keyword">if</span> (DEBUG_PROCESSES) Slog.v(TAG, <span class="string">"Clearing bad process: "</span> + info.uid</span><br><span class="line">                      + <span class="string">"/"</span> + info.processName);</span><br><span class="line">              mProcessCrashTimes.remove(info.processName, info.uid);</span><br><span class="line">              <span class="keyword">if</span> (mBadProcesses.get(info.processName, info.uid) != <span class="keyword">null</span>) &#123;</span><br><span class="line">                  EventLog.writeEvent(EventLogTags.AM_PROC_GOOD,</span><br><span class="line">                          UserHandle.getUserId(info.uid), info.uid,</span><br><span class="line">                          info.processName);</span><br><span class="line">                  mBadProcesses.remove(info.processName, info.uid);</span><br><span class="line">                  <span class="keyword">if</span> (app != <span class="keyword">null</span>) &#123;</span><br><span class="line">                      app.bad = <span class="keyword">false</span>;</span><br><span class="line">                  &#125;</span><br><span class="line">              &#125;</span><br><span class="line">          &#125;</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="keyword">if</span> (app == <span class="keyword">null</span>) &#123;</span><br><span class="line">      	<span class="comment">//如果app还没有创建，先创建一个表示进程的app对象</span></span><br><span class="line">          app = newProcessRecordLocked(info, processName, isolated);</span><br><span class="line">          <span class="keyword">if</span> (app == <span class="keyword">null</span>) &#123;</span><br><span class="line">              Slog.w(TAG, <span class="string">"Failed making new process record for "</span></span><br><span class="line">                      + processName + <span class="string">"/"</span> + info.uid + <span class="string">" isolated="</span> + isolated);</span><br><span class="line">              <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">          &#125;</span><br><span class="line">          mProcessNames.put(processName, app.uid, app);</span><br><span class="line">          <span class="keyword">if</span> (isolated) &#123;</span><br><span class="line">              mIsolatedProcesses.put(app.uid, app);</span><br><span class="line">          &#125;</span><br><span class="line">      &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">          <span class="comment">// If this is a new package in the process, add the package to the list</span></span><br><span class="line">          app.addPackage(info.packageName, mProcessStats);</span><br><span class="line">      &#125;</span><br><span class="line"></span><br><span class="line">      <span class="comment">// If the system is not ready yet, then hold off on starting this</span></span><br><span class="line">      <span class="comment">// process until it is.</span></span><br><span class="line">      <span class="keyword">if</span> (!mProcessesReady</span><br><span class="line">              &amp;&amp; !isAllowedWhileBooting(info)</span><br><span class="line">              &amp;&amp; !allowWhileBooting) &#123;</span><br><span class="line">          <span class="keyword">if</span> (!mProcessesOnHold.contains(app)) &#123;</span><br><span class="line">              mProcessesOnHold.add(app);</span><br><span class="line">          &#125;</span><br><span class="line">          <span class="keyword">if</span> (DEBUG_PROCESSES) Slog.v(TAG, <span class="string">"System not ready, putting on hold: "</span> + app);</span><br><span class="line">          <span class="keyword">return</span> app;</span><br><span class="line">      &#125;</span><br><span class="line"><span class="comment">//开始创建</span></span><br><span class="line">      startProcessLocked(app, hostingType, hostingNameStr);</span><br><span class="line">      <span class="keyword">return</span> (app.pid != <span class="number">0</span>) ? app : <span class="keyword">null</span>;</span><br><span class="line">  &#125;</span><br></pre></td></tr></table></figure>
<p>这里的ProcessRecord就是用来表示一个进程的对象。通过uid和process可以得到唯一一个进程。process可以在AndroidManifest.xml中指定，如果没有指定默认使用package的名称。也可以为两个应用程序配置相同的uid和process,这样两个应用程序就能在同一个进程中启动。<br>这里的newProcessRecordLocked是对new ProcessRecord()的封装。<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">final</span> ProcessRecord <span class="title">newProcessRecordLocked</span><span class="params">(ApplicationInfo info, String customProcess,</span><br><span class="line">        <span class="keyword">boolean</span> isolated)</span> </span>&#123;</span><br><span class="line">    String proc = customProcess != <span class="keyword">null</span> ? customProcess : info.processName;</span><br><span class="line">    BatteryStatsImpl.Uid.Proc ps = <span class="keyword">null</span>;</span><br><span class="line">    BatteryStatsImpl stats = mBatteryStatsService.getActiveStatistics();</span><br><span class="line">    <span class="keyword">int</span> uid = info.uid;</span><br><span class="line">    <span class="keyword">if</span> (isolated) &#123;</span><br><span class="line">        <span class="keyword">int</span> userId = UserHandle.getUserId(uid);</span><br><span class="line">        <span class="keyword">int</span> stepsLeft = Process.LAST_ISOLATED_UID - Process.FIRST_ISOLATED_UID + <span class="number">1</span>;</span><br><span class="line">        <span class="keyword">while</span> (<span class="keyword">true</span>) &#123;</span><br><span class="line">            <span class="keyword">if</span> (mNextIsolatedProcessUid &lt; Process.FIRST_ISOLATED_UID</span><br><span class="line">                    || mNextIsolatedProcessUid &gt; Process.LAST_ISOLATED_UID) &#123;</span><br><span class="line">                mNextIsolatedProcessUid = Process.FIRST_ISOLATED_UID;</span><br><span class="line">            &#125;</span><br><span class="line">            uid = UserHandle.getUid(userId, mNextIsolatedProcessUid);</span><br><span class="line">            mNextIsolatedProcessUid++;</span><br><span class="line">            <span class="keyword">if</span> (mIsolatedProcesses.indexOfKey(uid) &lt; <span class="number">0</span>) &#123;</span><br><span class="line">                <span class="comment">// No process for this uid, use it.</span></span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            stepsLeft--;</span><br><span class="line">            <span class="keyword">if</span> (stepsLeft &lt;= <span class="number">0</span>) &#123;</span><br><span class="line">                <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">new</span> ProcessRecord(stats, info, proc, uid);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>ProcessRecord的构造函数。<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">ProcessRecord(BatteryStatsImpl _batteryStats, ApplicationInfo _info,</span><br><span class="line">           String _processName, <span class="keyword">int</span> _uid) &#123;</span><br><span class="line">       mBatteryStats = _batteryStats;</span><br><span class="line">       info = _info;</span><br><span class="line">       isolated = _info.uid != _uid;</span><br><span class="line">       uid = _uid;</span><br><span class="line">       userId = UserHandle.getUserId(_uid);</span><br><span class="line">       processName = _processName;</span><br><span class="line">       pkgList.put(_info.packageName, <span class="keyword">null</span>);</span><br><span class="line">       maxAdj = ProcessList.UNKNOWN_ADJ;</span><br><span class="line">       curRawAdj = setRawAdj = -<span class="number">100</span>;</span><br><span class="line">       curAdj = setAdj = -<span class="number">100</span>;</span><br><span class="line">       persistent = <span class="keyword">false</span>;</span><br><span class="line">       removed = <span class="keyword">false</span>;</span><br><span class="line">       lastStateTime = lastPssTime = nextPssTime = SystemClock.uptimeMillis();</span><br><span class="line">   &#125;</span><br></pre></td></tr></table></figure></p>
<p>接着来看startProcessLocked函数。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">final</span> <span class="keyword">void</span> <span class="title">startProcessLocked</span><span class="params">(ProcessRecord app,</span><br><span class="line">            String hostingType, String hostingNameStr)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (app.pid &gt; <span class="number">0</span> &amp;&amp; app.pid != MY_PID) &#123;</span><br><span class="line">            <span class="keyword">synchronized</span> (mPidsSelfLocked) &#123;</span><br><span class="line">                mPidsSelfLocked.remove(app.pid);</span><br><span class="line">                mHandler.removeMessages(PROC_START_TIMEOUT_MSG, app);</span><br><span class="line">            &#125;</span><br><span class="line">            app.setPid(<span class="number">0</span>);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (DEBUG_PROCESSES &amp;&amp; mProcessesOnHold.contains(app)) Slog.v(TAG,</span><br><span class="line">                <span class="string">"startProcessLocked removing on hold: "</span> + app);</span><br><span class="line">        mProcessesOnHold.remove(app);</span><br><span class="line"></span><br><span class="line">        updateCpuStats();</span><br><span class="line"></span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="keyword">int</span> uid = app.uid;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">int</span>[] gids = <span class="keyword">null</span>;</span><br><span class="line">            ...</span><br><span class="line">            <span class="comment">//这里定义了entryPoint</span></span><br><span class="line">            Process.ProcessStartResult startResult = Process.start(<span class="string">"android.app.ActivityThread"</span>,</span><br><span class="line">                    app.processName, uid, uid, gids, debugFlags, mountExternal,</span><br><span class="line">                    app.info.targetSdkVersion, app.info.seinfo, <span class="keyword">null</span>);</span><br><span class="line"></span><br><span class="line">            BatteryStatsImpl bs = mBatteryStatsService.getActiveStatistics();</span><br><span class="line">            <span class="keyword">synchronized</span> (bs) &#123;</span><br><span class="line">                <span class="keyword">if</span> (bs.isOnBattery()) &#123;</span><br><span class="line">                    bs.getProcessStatsLocked(app.uid, app.processName).incStartsLocked();</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            EventLog.writeEvent(EventLogTags.AM_PROC_START,</span><br><span class="line">                    UserHandle.getUserId(uid), startResult.pid, uid,</span><br><span class="line">                    app.processName, hostingType,</span><br><span class="line">                    hostingNameStr != <span class="keyword">null</span> ? hostingNameStr : <span class="string">""</span>);</span><br><span class="line"></span><br><span class="line">            <span class="keyword">if</span> (app.persistent) &#123;</span><br><span class="line">                Watchdog.getInstance().processStarted(app.processName, startResult.pid);</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            StringBuilder buf = mStringBuilder;</span><br><span class="line">            buf.setLength(<span class="number">0</span>);</span><br><span class="line">            buf.append(<span class="string">"Start proc "</span>);</span><br><span class="line">            buf.append(app.processName);</span><br><span class="line">            buf.append(<span class="string">" for "</span>);</span><br><span class="line">            buf.append(hostingType);</span><br><span class="line">            <span class="keyword">if</span> (hostingNameStr != <span class="keyword">null</span>) &#123;</span><br><span class="line">                buf.append(<span class="string">" "</span>);</span><br><span class="line">                buf.append(hostingNameStr);</span><br><span class="line">            &#125;</span><br><span class="line">            buf.append(<span class="string">": pid="</span>);</span><br><span class="line">            buf.append(startResult.pid);</span><br><span class="line">            buf.append(<span class="string">" uid="</span>);</span><br><span class="line">            buf.append(uid);</span><br><span class="line">            buf.append(<span class="string">" gids=&#123;"</span>);</span><br><span class="line">            <span class="keyword">if</span> (gids != <span class="keyword">null</span>) &#123;</span><br><span class="line">                <span class="keyword">for</span> (<span class="keyword">int</span> gi=<span class="number">0</span>; gi&lt;gids.length; gi++) &#123;</span><br><span class="line">                    <span class="keyword">if</span> (gi != <span class="number">0</span>) buf.append(<span class="string">", "</span>);</span><br><span class="line">                    buf.append(gids[gi]);</span><br><span class="line"></span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">            buf.append(<span class="string">"&#125;"</span>);</span><br><span class="line">            Slog.i(TAG, buf.toString());</span><br><span class="line">            app.setPid(startResult.pid);</span><br><span class="line">            app.usingWrapper = startResult.usingWrapper;</span><br><span class="line">            app.removed = <span class="keyword">false</span>;</span><br><span class="line">            <span class="keyword">synchronized</span> (mPidsSelfLocked) &#123;</span><br><span class="line">            <span class="comment">//pid保存到map,AMS需要</span></span><br><span class="line">                <span class="keyword">this</span>.mPidsSelfLocked.put(startResult.pid, app);</span><br><span class="line">                Message msg = mHandler.obtainMessage(PROC_START_TIMEOUT_MSG);</span><br><span class="line">                msg.obj = app;</span><br><span class="line">                mHandler.sendMessageDelayed(msg, startResult.usingWrapper</span><br><span class="line">                        ? PROC_START_TIMEOUT_WITH_WRAPPER : PROC_START_TIMEOUT);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125; <span class="keyword">catch</span> (RuntimeException e) &#123;</span><br><span class="line">            <span class="comment">// XXX do better error recovery.</span></span><br><span class="line">            app.setPid(<span class="number">0</span>);</span><br><span class="line">            Slog.e(TAG, <span class="string">"Failure starting process "</span> + app.processName, e);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>
<p>这里调用了Process.start接口来创建一个新的进程，新的进程会导入android.app.ActivityThread类，并执行它的main函数。所以在Android中每一个应用程序的入口都是ActivityThread。</p>
<p>先看Process.start方法，定义在/frameworks/base/core/java/android/os/Process.java:<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">*/</span><br><span class="line">  <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> ProcessStartResult <span class="title">start</span><span class="params">(<span class="keyword">final</span> String processClass,</span><br><span class="line">                                <span class="keyword">final</span> String niceName,</span><br><span class="line">                                <span class="keyword">int</span> uid, <span class="keyword">int</span> gid, <span class="keyword">int</span>[] gids,</span><br><span class="line">                                <span class="keyword">int</span> debugFlags, <span class="keyword">int</span> mountExternal,</span><br><span class="line">                                <span class="keyword">int</span> targetSdkVersion,</span><br><span class="line">                                String seInfo,</span><br><span class="line">                                String[] zygoteArgs)</span> </span>&#123;</span><br><span class="line">      <span class="keyword">try</span> &#123;</span><br><span class="line">          <span class="keyword">return</span> startViaZygote(processClass, niceName, uid, gid, gids,</span><br><span class="line">                  debugFlags, mountExternal, targetSdkVersion, seInfo, zygoteArgs);</span><br><span class="line">      &#125; <span class="keyword">catch</span> (ZygoteStartFailedEx ex) &#123;</span><br><span class="line">          Log.e(LOG_TAG,</span><br><span class="line">                  <span class="string">"Starting VM process through Zygote failed"</span>);</span><br><span class="line">          <span class="keyword">throw</span> <span class="keyword">new</span> RuntimeException(</span><br><span class="line">                  <span class="string">"Starting VM process through Zygote failed"</span>, ex);</span><br><span class="line">      &#125;</span><br><span class="line">  &#125;</span><br></pre></td></tr></table></figure></p>
<p>这里是一个封装。<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">static</span> ProcessStartResult <span class="title">startViaZygote</span><span class="params">(<span class="keyword">final</span> String processClass,</span><br><span class="line">                                  <span class="keyword">final</span> String niceName,</span><br><span class="line">                                  <span class="keyword">final</span> <span class="keyword">int</span> uid, <span class="keyword">final</span> <span class="keyword">int</span> gid,</span><br><span class="line">                                  <span class="keyword">final</span> <span class="keyword">int</span>[] gids,</span><br><span class="line">                                  <span class="keyword">int</span> debugFlags, <span class="keyword">int</span> mountExternal,</span><br><span class="line">                                  <span class="keyword">int</span> targetSdkVersion,</span><br><span class="line">                                  String seInfo,</span><br><span class="line">                                  String[] extraArgs)</span></span><br><span class="line">                                  <span class="keyword">throws</span> ZygoteStartFailedEx </span>&#123;</span><br><span class="line">        <span class="keyword">synchronized</span>(Process.class) &#123;</span><br><span class="line">            ArrayList&lt;String&gt; argsForZygote = <span class="keyword">new</span> ArrayList&lt;String&gt;();</span><br><span class="line"></span><br><span class="line">          	...</span><br><span class="line"></span><br><span class="line">            <span class="keyword">return</span> zygoteSendArgsAndGetResult(argsForZygote);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure></p>
<p>还是一个封装，继续看zygoteSendArgsAndGetResult方法。<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">static</span> ProcessStartResult <span class="title">zygoteSendArgsAndGetResult</span><span class="params">(ArrayList&lt;String&gt; args)</span></span><br><span class="line">         <span class="keyword">throws</span> ZygoteStartFailedEx </span>&#123;</span><br><span class="line">     openZygoteSocketIfNeeded();</span><br><span class="line"></span><br><span class="line">     <span class="keyword">try</span> &#123;</span><br><span class="line">         <span class="comment">/**</span><br><span class="line">          * See com.android.internal.os.ZygoteInit.readArgumentList()</span><br><span class="line">          * Presently the wire format to the zygote process is:</span><br><span class="line">          * a) a count of arguments (argc, in essence)</span><br><span class="line">          * b) a number of newline-separated argument strings equal to count</span><br><span class="line">          *</span><br><span class="line">          * After the zygote process reads these it will write the pid of</span><br><span class="line">          * the child or -1 on failure, followed by boolean to</span><br><span class="line">          * indicate whether a wrapper process was used.</span><br><span class="line">          */</span></span><br><span class="line"></span><br><span class="line">         sZygoteWriter.write(Integer.toString(args.size()));</span><br><span class="line">         sZygoteWriter.newLine();</span><br><span class="line"></span><br><span class="line">         <span class="keyword">int</span> sz = args.size();</span><br><span class="line">         <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; sz; i++) &#123;</span><br><span class="line">             String arg = args.get(i);</span><br><span class="line">             <span class="keyword">if</span> (arg.indexOf(<span class="string">'\n'</span>) &gt;= <span class="number">0</span>) &#123;</span><br><span class="line">                 <span class="keyword">throw</span> <span class="keyword">new</span> ZygoteStartFailedEx(</span><br><span class="line">                         <span class="string">"embedded newlines not allowed"</span>);</span><br><span class="line">             &#125;</span><br><span class="line">             sZygoteWriter.write(arg);</span><br><span class="line">             sZygoteWriter.newLine();</span><br><span class="line">         &#125;</span><br><span class="line"></span><br><span class="line">         sZygoteWriter.flush();</span><br><span class="line"></span><br><span class="line">         <span class="comment">// Should there be a timeout on this?</span></span><br><span class="line">         ProcessStartResult result = <span class="keyword">new</span> ProcessStartResult();</span><br><span class="line">         result.pid = sZygoteInputStream.readInt();</span><br><span class="line">         <span class="keyword">if</span> (result.pid &lt; <span class="number">0</span>) &#123;</span><br><span class="line">             <span class="keyword">throw</span> <span class="keyword">new</span> ZygoteStartFailedEx(<span class="string">"fork() failed"</span>);</span><br><span class="line">         &#125;</span><br><span class="line">         result.usingWrapper = sZygoteInputStream.readBoolean();</span><br><span class="line">         <span class="keyword">return</span> result;</span><br><span class="line">     &#125; <span class="keyword">catch</span> (IOException ex) &#123;</span><br><span class="line">         <span class="keyword">try</span> &#123;</span><br><span class="line">             <span class="keyword">if</span> (sZygoteSocket != <span class="keyword">null</span>) &#123;</span><br><span class="line">                 sZygoteSocket.close();</span><br><span class="line">             &#125;</span><br><span class="line">         &#125; <span class="keyword">catch</span> (IOException ex2) &#123;</span><br><span class="line">             <span class="comment">// we're going to fail anyway</span></span><br><span class="line">             Log.e(LOG_TAG,<span class="string">"I/O exception on routine close"</span>, ex2);</span><br><span class="line">         &#125;</span><br><span class="line"></span><br><span class="line">         sZygoteSocket = <span class="keyword">null</span>;</span><br><span class="line"></span><br><span class="line">         <span class="keyword">throw</span> <span class="keyword">new</span> ZygoteStartFailedEx(ex);</span><br><span class="line">     &#125;</span><br><span class="line"> &#125;</span><br></pre></td></tr></table></figure></p>
<p>这里通过一个localsocket,通知zygote创建一个进程。所以这里可以看到，Android下所有应用程序都是由zygote孵化的。</p>
<p>现在回到ActivityThread.main函数: /frameworks/base/core/java/android/app/ActivityThread.java<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><span class="line">  <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line">        SamplingProfilerIntegration.start();</span><br><span class="line"></span><br><span class="line">        <span class="comment">// CloseGuard defaults to true and can be quite spammy.  We</span></span><br><span class="line">        <span class="comment">// disable it here, but selectively enable it later (via</span></span><br><span class="line">        <span class="comment">// StrictMode) on debug builds, but using DropBox, not logs.</span></span><br><span class="line">        CloseGuard.setEnabled(<span class="keyword">false</span>);</span><br><span class="line"></span><br><span class="line">        Environment.initForCurrentUser();</span><br><span class="line"></span><br><span class="line">        <span class="comment">// Set the reporter for event logging in libcore</span></span><br><span class="line">        EventLogger.setReporter(<span class="keyword">new</span> EventLoggingReporter());</span><br><span class="line"></span><br><span class="line">        Security.addProvider(<span class="keyword">new</span> AndroidKeyStoreProvider());</span><br><span class="line"></span><br><span class="line">        Process.setArgV0(<span class="string">"&lt;pre-initialized&gt;"</span>);</span><br><span class="line"></span><br><span class="line">        Looper.prepareMainLooper();</span><br><span class="line"></span><br><span class="line">        ActivityThread thread = <span class="keyword">new</span> ActivityThread();</span><br><span class="line">        <span class="comment">//告诉AMS，ActivityThead已经创建好了</span></span><br><span class="line">        thread.attach(<span class="keyword">false</span>);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (sMainThreadHandler == <span class="keyword">null</span>) &#123;</span><br><span class="line">            sMainThreadHandler = thread.getHandler();</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        AsyncTask.init();</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (<span class="keyword">false</span>) &#123;</span><br><span class="line">            Looper.myLooper().setMessageLogging(<span class="keyword">new</span></span><br><span class="line">                    LogPrinter(Log.DEBUG, <span class="string">"ActivityThread"</span>));</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        Looper.loop();</span><br><span class="line"></span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> RuntimeException(<span class="string">"Main thread loop unexpectedly exited"</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>这个函数在当前进程中创建了一个ActivityThread实例，然后调用它的attach函数。然后进入消息循环，直到进程退出。函数attach会调用ActivityManagerService的远程接口ActivityManagerProxy的attachApplication函数，传入的参数是mActivityThread，这是一个ApplicationThread类型的Binder对象，它的作用是用来进行进程间通信。<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">attach</span><span class="params">(<span class="keyword">boolean</span> system)</span> </span>&#123;</span><br><span class="line">       sCurrentActivityThread = <span class="keyword">this</span>;</span><br><span class="line">       mSystemThread = system;</span><br><span class="line">       <span class="keyword">if</span> (!system) &#123;</span><br><span class="line">           ViewRootImpl.addFirstDrawHandler(<span class="keyword">new</span> Runnable() &#123;</span><br><span class="line">               <span class="meta">@Override</span></span><br><span class="line">               <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">()</span> </span>&#123;</span><br><span class="line">                   ensureJitEnabled();</span><br><span class="line">               &#125;</span><br><span class="line">           &#125;);</span><br><span class="line">           android.ddm.DdmHandleAppName.setAppName(<span class="string">"&lt;pre-initialized&gt;"</span>,</span><br><span class="line">                                                   UserHandle.myUserId());</span><br><span class="line">           RuntimeInit.setApplicationObject(mAppThread.asBinder());</span><br><span class="line">           IActivityManager mgr = ActivityManagerNative.getDefault();</span><br><span class="line">           <span class="keyword">try</span> &#123;</span><br><span class="line">           	<span class="comment">//提示ActivityManagerService</span></span><br><span class="line">               mgr.attachApplication(mAppThread);</span><br><span class="line">           &#125; <span class="keyword">catch</span> (RemoteException ex) &#123;</span><br><span class="line">               <span class="comment">// Ignore</span></span><br><span class="line">           &#125;</span><br><span class="line">       &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">           <span class="comment">// Don't set application object here -- if the system crashes,</span></span><br><span class="line">           <span class="comment">// we can't display an alert, we just want to die die die.</span></span><br><span class="line">           android.ddm.DdmHandleAppName.setAppName(<span class="string">"system_process"</span>,</span><br><span class="line">                                                   UserHandle.myUserId());</span><br><span class="line">           <span class="keyword">try</span> &#123;</span><br><span class="line">               mInstrumentation = <span class="keyword">new</span> Instrumentation();</span><br><span class="line">               ContextImpl context = ContextImpl.createAppContext(</span><br><span class="line">                       <span class="keyword">this</span>, getSystemContext().mPackageInfo);</span><br><span class="line">               Application app = Instrumentation.newApplication(Application.class, context);</span><br><span class="line">               mAllApplications.add(app);</span><br><span class="line">               mInitialApplication = app;</span><br><span class="line">               app.onCreate();</span><br><span class="line">           &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">               <span class="keyword">throw</span> <span class="keyword">new</span> RuntimeException(</span><br><span class="line">                       <span class="string">"Unable to instantiate Application():"</span> + e.toString(), e);</span><br><span class="line">           &#125;</span><br><span class="line">       &#125;</span><br><span class="line"></span><br><span class="line">       ...</span><br><span class="line">   &#125;</span><br></pre></td></tr></table></figure></p>
<p>来看attachApplication函数，这个函数的定义在frameworks/base/core/java/android/app/ActivityManagerNative.java中。<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">attachApplication</span><span class="params">(IApplicationThread app)</span> <span class="keyword">throws</span> RemoteException</span><br><span class="line">  </span>&#123;</span><br><span class="line">      Parcel data = Parcel.obtain();</span><br><span class="line">      Parcel reply = Parcel.obtain();</span><br><span class="line">      data.writeInterfaceToken(IActivityManager.descriptor);</span><br><span class="line">      data.writeStrongBinder(app.asBinder());</span><br><span class="line">      mRemote.transact(ATTACH_APPLICATION_TRANSACTION, data, reply, <span class="number">0</span>);</span><br><span class="line">      reply.readException();</span><br><span class="line">      data.recycle();</span><br><span class="line">      reply.recycle();</span><br><span class="line">  &#125;</span><br></pre></td></tr></table></figure></p>
<p>通过Binder程序，最终调用ActivityManagerService的attachApplication函数。<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line">   <span class="function"><span class="keyword">public</span> <span class="keyword">final</span> <span class="keyword">void</span> <span class="title">attachApplication</span><span class="params">(IApplicationThread thread)</span> </span>&#123;</span><br><span class="line">       <span class="keyword">synchronized</span> (<span class="keyword">this</span>) &#123;</span><br><span class="line">           <span class="keyword">int</span> callingPid = Binder.getCallingPid();</span><br><span class="line">           <span class="keyword">final</span> <span class="keyword">long</span> origId = Binder.clearCallingIdentity();</span><br><span class="line">           attachApplicationLocked(thread, callingPid);</span><br><span class="line">           Binder.restoreCallingIdentity(origId);</span><br><span class="line">       &#125;</span><br><span class="line">   &#125;</span><br></pre></td></tr></table></figure></p>
<p>这里是一个封装，调用attachApplicationLocked()函数。<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">final</span> <span class="keyword">boolean</span> <span class="title">attachApplicationLocked</span><span class="params">(IApplicationThread thread,</span><br><span class="line">           <span class="keyword">int</span> pid)</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">       <span class="comment">// Find the application record that is being attached...  either via</span></span><br><span class="line">       <span class="comment">// the pid if we are running in multiple processes, or just pull the</span></span><br><span class="line">       <span class="comment">// next app record if we are emulating process with anonymous threads.</span></span><br><span class="line">       <span class="comment">//创建app对象</span></span><br><span class="line">       ProcessRecord app;</span><br><span class="line">       <span class="keyword">if</span> (pid != MY_PID &amp;&amp; pid &gt;= <span class="number">0</span>) &#123;</span><br><span class="line">           <span class="keyword">synchronized</span> (mPidsSelfLocked) &#123;</span><br><span class="line">           	<span class="comment">//得到app对象</span></span><br><span class="line">               app = mPidsSelfLocked.get(pid);</span><br><span class="line">           &#125;</span><br><span class="line">       &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">           app = <span class="keyword">null</span>;</span><br><span class="line">       &#125;</span><br><span class="line">	<span class="comment">//如果没有，就杀死当前进程</span></span><br><span class="line">       <span class="keyword">if</span> (app == <span class="keyword">null</span>) &#123;</span><br><span class="line">           Slog.w(TAG, <span class="string">"No pending application record for pid "</span> + pid</span><br><span class="line">                   + <span class="string">" (IApplicationThread "</span> + thread + <span class="string">"); dropping process"</span>);</span><br><span class="line">           EventLog.writeEvent(EventLogTags.AM_DROP_PROCESS, pid);</span><br><span class="line">           <span class="keyword">if</span> (pid &gt; <span class="number">0</span> &amp;&amp; pid != MY_PID) &#123;</span><br><span class="line">               Process.killProcessQuiet(pid);</span><br><span class="line">           &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">               <span class="keyword">try</span> &#123;</span><br><span class="line">                   thread.scheduleExit();</span><br><span class="line">               &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">                   <span class="comment">// Ignore exceptions.</span></span><br><span class="line">               &#125;</span><br><span class="line">           &#125;</span><br><span class="line">           <span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line">       &#125;</span><br><span class="line"></span><br><span class="line">       ...</span><br><span class="line">       <span class="keyword">try</span> &#123;</span><br><span class="line">          ...</span><br><span class="line">		<span class="comment">//优化dex文件</span></span><br><span class="line">           ensurePackageDexOpt(app.instrumentationInfo != <span class="keyword">null</span></span><br><span class="line">                   ? app.instrumentationInfo.packageName</span><br><span class="line">                   : app.info.packageName);</span><br><span class="line">           <span class="keyword">if</span> (app.instrumentationClass != <span class="keyword">null</span>) &#123;</span><br><span class="line">               ensurePackageDexOpt(app.instrumentationClass.getPackageName());</span><br><span class="line">           &#125;</span><br><span class="line">           <span class="keyword">if</span> (DEBUG_CONFIGURATION) Slog.v(TAG, <span class="string">"Binding proc "</span></span><br><span class="line">                   + processName + <span class="string">" with config "</span> + mConfiguration);</span><br><span class="line">           ApplicationInfo appInfo = app.instrumentationInfo != <span class="keyword">null</span></span><br><span class="line">                   ? app.instrumentationInfo : app.info;</span><br><span class="line">           app.compat = compatibilityInfoForPackageLocked(appInfo);</span><br><span class="line">           <span class="keyword">if</span> (profileFd != <span class="keyword">null</span>) &#123;</span><br><span class="line">               profileFd = profileFd.dup();</span><br><span class="line">           &#125;</span><br><span class="line">           <span class="comment">//这里返回到ActivityThread进程</span></span><br><span class="line">           thread.bindApplication(processName, appInfo, providers,</span><br><span class="line">                   app.instrumentationClass, profileFile, profileFd, profileAutoStop,</span><br><span class="line">                   app.instrumentationArguments, app.instrumentationWatcher,</span><br><span class="line">                   app.instrumentationUiAutomationConnection, testMode, enableOpenGlTrace,</span><br><span class="line">                   isRestrictedBackupMode || !normalMode, app.persistent,</span><br><span class="line">                   <span class="keyword">new</span> Configuration(mConfiguration), app.compat, getCommonServicesLocked(),</span><br><span class="line">                   mCoreSettingsObserver.getCoreSettingsLocked());</span><br><span class="line">           updateLruProcessLocked(app, <span class="keyword">false</span>, <span class="keyword">null</span>);</span><br><span class="line">           app.lastRequestedGc = app.lastLowMemory = SystemClock.uptimeMillis();</span><br><span class="line">       &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">       ...</span><br><span class="line">       <span class="keyword">if</span> (normalMode) &#123;</span><br><span class="line">           <span class="keyword">try</span> &#123;</span><br><span class="line">           	<span class="comment">//启动Activity</span></span><br><span class="line">               <span class="keyword">if</span> (mStackSupervisor.attachApplicationLocked(app, mHeadless)) &#123;</span><br><span class="line">                   didSomething = <span class="keyword">true</span>;</span><br><span class="line">               &#125;</span><br><span class="line">           &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">               badApp = <span class="keyword">true</span>;</span><br><span class="line">           &#125;</span><br><span class="line">       &#125;</span><br><span class="line"></span><br><span class="line">       <span class="comment">// Find any services that should be running in this process...</span></span><br><span class="line">       <span class="keyword">if</span> (!badApp) &#123;</span><br><span class="line">           <span class="keyword">try</span> &#123;</span><br><span class="line">           	<span class="comment">//启动Service</span></span><br><span class="line">               didSomething |= mServices.attachApplicationLocked(app, processName);</span><br><span class="line">           &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">               badApp = <span class="keyword">true</span>;</span><br><span class="line">           &#125;</span><br><span class="line">       &#125;</span><br><span class="line"></span><br><span class="line">       <span class="comment">// Check if a next-broadcast receiver is in this process...</span></span><br><span class="line">       <span class="keyword">if</span> (!badApp &amp;&amp; isPendingBroadcastProcessLocked(pid)) &#123;</span><br><span class="line">           <span class="keyword">try</span> &#123;</span><br><span class="line">           	<span class="comment">//注册broadcast</span></span><br><span class="line">               didSomething |= sendPendingBroadcastsLocked(app);</span><br><span class="line">           &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">               <span class="comment">// If the app died trying to launch the receiver we declare it 'bad'</span></span><br><span class="line">               badApp = <span class="keyword">true</span>;</span><br><span class="line">           &#125;</span><br><span class="line">       &#125;</span><br><span class="line"></span><br><span class="line">       ...</span><br><span class="line"></span><br><span class="line">       <span class="keyword">return</span> <span class="keyword">true</span>;</span><br><span class="line">   &#125;</span><br></pre></td></tr></table></figure></p>
<p>这里首先从map中获得上面创建的app对象，然后对app的一些成员初始化，最后通过attachApplicationLocked启动Activity。<br>/frameworks/base/services/java/com/android/server/am/ActivityStackSupervisor.java<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">boolean</span> <span class="title">attachApplicationLocked</span><span class="params">(ProcessRecord app, <span class="keyword">boolean</span> headless)</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">       <span class="keyword">boolean</span> didSomething = <span class="keyword">false</span>;</span><br><span class="line">       <span class="keyword">final</span> String processName = app.processName;</span><br><span class="line">       <span class="keyword">for</span> (<span class="keyword">int</span> stackNdx = mStacks.size() - <span class="number">1</span>; stackNdx &gt;= <span class="number">0</span>; --stackNdx) &#123;</span><br><span class="line">           <span class="keyword">final</span> ActivityStack stack = mStacks.get(stackNdx);</span><br><span class="line">           <span class="keyword">if</span> (!isFrontStack(stack)) &#123;</span><br><span class="line">               <span class="keyword">continue</span>;</span><br><span class="line">           &#125;</span><br><span class="line">           ActivityRecord hr = stack.topRunningActivityLocked(<span class="keyword">null</span>);</span><br><span class="line">           <span class="keyword">if</span> (hr != <span class="keyword">null</span>) &#123;</span><br><span class="line">               <span class="keyword">if</span> (hr.app == <span class="keyword">null</span> &amp;&amp; app.uid == hr.info.applicationInfo.uid</span><br><span class="line">                       &amp;&amp; processName.equals(hr.processName)) &#123;</span><br><span class="line">                   <span class="keyword">try</span> &#123;</span><br><span class="line">                       <span class="keyword">if</span> (headless) &#123;</span><br><span class="line">                           Slog.e(TAG, <span class="string">"Starting activities not supported on headless device: "</span></span><br><span class="line">                                   + hr);</span><br><span class="line">                       &#125; <span class="keyword">else</span> <span class="keyword">if</span> (realStartActivityLocked(hr, app, <span class="keyword">true</span>, <span class="keyword">true</span>)) &#123;</span><br><span class="line">                           didSomething = <span class="keyword">true</span>;</span><br><span class="line">                       &#125;</span><br><span class="line">                   &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">                       Slog.w(TAG, <span class="string">"Exception in new application when starting activity "</span></span><br><span class="line">                             + hr.intent.getComponent().flattenToShortString(), e);</span><br><span class="line">                       <span class="keyword">throw</span> e;</span><br><span class="line">                   &#125;</span><br><span class="line">               &#125;</span><br><span class="line">           &#125;</span><br><span class="line">       &#125;</span><br><span class="line">       <span class="keyword">if</span> (!didSomething) &#123;</span><br><span class="line">           ensureActivitiesVisibleLocked(<span class="keyword">null</span>, <span class="number">0</span>);</span><br><span class="line">       &#125;</span><br><span class="line">       <span class="keyword">return</span> didSomething;</span><br><span class="line">   &#125;</span><br></pre></td></tr></table></figure></p>
<p>这里调用了realStartActivityLocked,这个函数在/frameworks/base/services/java/com/android/server/am/ActivityStackSupervisor.java中：<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">final</span> <span class="keyword">boolean</span> <span class="title">realStartActivityLocked</span><span class="params">(ActivityRecord r,</span><br><span class="line">          ProcessRecord app, <span class="keyword">boolean</span> andResume, <span class="keyword">boolean</span> checkConfig)</span></span><br><span class="line">          <span class="keyword">throws</span> RemoteException </span>&#123;</span><br><span class="line"></span><br><span class="line">      r.startFreezingScreenLocked(app, <span class="number">0</span>);</span><br><span class="line">      <span class="keyword">if</span> (<span class="keyword">false</span>) Slog.d(TAG, <span class="string">"realStartActivity: setting app visibility true"</span>);</span><br><span class="line">      mWindowManager.setAppVisibility(r.appToken, <span class="keyword">true</span>);</span><br><span class="line"></span><br><span class="line">     ...</span><br><span class="line">          app.forceProcessStateUpTo(ActivityManager.PROCESS_STATE_TOP);</span><br><span class="line">          app.thread.scheduleLaunchActivity(<span class="keyword">new</span> Intent(r.intent), r.appToken,</span><br><span class="line">                  System.identityHashCode(r), r.info,</span><br><span class="line">                  <span class="keyword">new</span> Configuration(mService.mConfiguration), r.compat,</span><br><span class="line">                  app.repProcState, r.icicle, results, newIntents, !andResume,</span><br><span class="line">                  mService.isNextTransitionForward(), profileFile, profileFd,</span><br><span class="line">                  profileAutoStop);</span><br><span class="line"></span><br><span class="line">          <span class="keyword">if</span> ((app.info.flags&amp;ApplicationInfo.FLAG_CANT_SAVE_STATE) != <span class="number">0</span>) &#123;</span><br><span class="line">              <span class="comment">// This may be a heavy-weight process!  Note that the package</span></span><br><span class="line">              <span class="comment">// manager will ensure that only activity can run in the main</span></span><br><span class="line">              <span class="comment">// process of the .apk, which is the only thing that will be</span></span><br><span class="line">              <span class="comment">// considered heavy-weight.</span></span><br><span class="line">              <span class="keyword">if</span> (app.processName.equals(app.info.packageName)) &#123;</span><br><span class="line">                  <span class="keyword">if</span> (mService.mHeavyWeightProcess != <span class="keyword">null</span></span><br><span class="line">                          &amp;&amp; mService.mHeavyWeightProcess != app) &#123;</span><br><span class="line">                      Slog.w(TAG, <span class="string">"Starting new heavy weight process "</span> + app</span><br><span class="line">                              + <span class="string">" when already running "</span></span><br><span class="line">                              + mService.mHeavyWeightProcess);</span><br><span class="line">                  &#125;</span><br><span class="line">                  mService.mHeavyWeightProcess = app;</span><br><span class="line">                  Message msg = mService.mHandler.obtainMessage(</span><br><span class="line">                          ActivityManagerService.POST_HEAVY_NOTIFICATION_MSG);</span><br><span class="line">                  msg.obj = r;</span><br><span class="line">                  mService.mHandler.sendMessage(msg);</span><br><span class="line">              &#125;</span><br><span class="line">          &#125;</span><br><span class="line"></span><br><span class="line">      &#125; <span class="keyword">catch</span> (RemoteException e) &#123;</span><br><span class="line">          ...</span><br><span class="line">       &#125;</span><br><span class="line"></span><br><span class="line">       <span class="comment">// Launch the new version setup screen if needed.  We do this -after-</span></span><br><span class="line">       <span class="comment">// launching the initial activity (that is, home), so that it can have</span></span><br><span class="line">       <span class="comment">// a chance to initialize itself while in the background, making the</span></span><br><span class="line">       <span class="comment">// switch back to it faster and look better.</span></span><br><span class="line">       <span class="keyword">if</span> (isFrontStack(stack)) &#123;</span><br><span class="line">           mService.startSetupActivityLocked();</span><br><span class="line">       &#125;</span><br><span class="line"></span><br><span class="line">       <span class="keyword">return</span> <span class="keyword">true</span>;</span><br><span class="line">   &#125;</span><br></pre></td></tr></table></figure></p>
<p>这里通过了app.thread进入到ApplicationThreadProxy的scheduleLaunchActivity()函数。<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">final</span> <span class="keyword">void</span> <span class="title">scheduleLaunchActivity</span><span class="params">(Intent intent, IBinder token, <span class="keyword">int</span> ident,</span><br><span class="line">         ActivityInfo info, Configuration curConfig, CompatibilityInfo compatInfo,</span><br><span class="line">         <span class="keyword">int</span> procState, Bundle state, List&lt;ResultInfo&gt; pendingResults,</span><br><span class="line"> 		List&lt;Intent&gt; pendingNewIntents, <span class="keyword">boolean</span> notResumed, <span class="keyword">boolean</span> isForward,</span><br><span class="line"> 		String profileName, ParcelFileDescriptor profileFd, <span class="keyword">boolean</span> autoStopProfiler)</span></span><br><span class="line"> 		<span class="keyword">throws</span> RemoteException </span>&#123;</span><br><span class="line">     Parcel data = Parcel.obtain();</span><br><span class="line">     data.writeInterfaceToken(IApplicationThread.descriptor);</span><br><span class="line">     intent.writeToParcel(data, <span class="number">0</span>);</span><br><span class="line">     data.writeStrongBinder(token);</span><br><span class="line">     data.writeInt(ident);</span><br><span class="line">     info.writeToParcel(data, <span class="number">0</span>);</span><br><span class="line">     curConfig.writeToParcel(data, <span class="number">0</span>);</span><br><span class="line">     compatInfo.writeToParcel(data, <span class="number">0</span>);</span><br><span class="line">     data.writeInt(procState);</span><br><span class="line">     data.writeBundle(state);</span><br><span class="line">     data.writeTypedList(pendingResults);</span><br><span class="line">     data.writeTypedList(pendingNewIntents);</span><br><span class="line">     data.writeInt(notResumed ? <span class="number">1</span> : <span class="number">0</span>);</span><br><span class="line">     data.writeInt(isForward ? <span class="number">1</span> : <span class="number">0</span>);</span><br><span class="line">     data.writeString(profileName);</span><br><span class="line">     <span class="keyword">if</span> (profileFd != <span class="keyword">null</span>) &#123;</span><br><span class="line">         data.writeInt(<span class="number">1</span>);</span><br><span class="line">         profileFd.writeToParcel(data, Parcelable.PARCELABLE_WRITE_RETURN_VALUE);</span><br><span class="line">     &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">         data.writeInt(<span class="number">0</span>);</span><br><span class="line">     &#125;</span><br><span class="line">     data.writeInt(autoStopProfiler ? <span class="number">1</span> : <span class="number">0</span>);</span><br><span class="line">     mRemote.transact(SCHEDULE_LAUNCH_ACTIVITY_TRANSACTION, data, <span class="keyword">null</span>,</span><br><span class="line">             IBinder.FLAG_ONEWAY);</span><br><span class="line">     data.recycle();</span><br><span class="line"> &#125;</span><br></pre></td></tr></table></figure></p>
<p>这个函数通过Binder程序进入到ApplicationThread的scheduleLaunchActivity函数。<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">final</span> <span class="keyword">void</span> <span class="title">scheduleLaunchActivity</span><span class="params">(Intent intent, IBinder token, <span class="keyword">int</span> ident,</span><br><span class="line">              ActivityInfo info, Configuration curConfig, CompatibilityInfo compatInfo,</span><br><span class="line">              <span class="keyword">int</span> procState, Bundle state, List&lt;ResultInfo&gt; pendingResults,</span><br><span class="line">              List&lt;Intent&gt; pendingNewIntents, <span class="keyword">boolean</span> notResumed, <span class="keyword">boolean</span> isForward,</span><br><span class="line">              String profileName, ParcelFileDescriptor profileFd, <span class="keyword">boolean</span> autoStopProfiler)</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">          updateProcessState(procState, <span class="keyword">false</span>);</span><br><span class="line"></span><br><span class="line">          ActivityClientRecord r = <span class="keyword">new</span> ActivityClientRecord();</span><br><span class="line"></span><br><span class="line">          r.token = token;</span><br><span class="line">          r.ident = ident;</span><br><span class="line">          r.intent = intent;</span><br><span class="line">          r.activityInfo = info;</span><br><span class="line">          r.compatInfo = compatInfo;</span><br><span class="line">          r.state = state;</span><br><span class="line"></span><br><span class="line">          r.pendingResults = pendingResults;</span><br><span class="line">          r.pendingIntents = pendingNewIntents;</span><br><span class="line"></span><br><span class="line">          r.startsNotResumed = notResumed;</span><br><span class="line">          r.isForward = isForward;</span><br><span class="line"></span><br><span class="line">          r.profileFile = profileName;</span><br><span class="line">          r.profileFd = profileFd;</span><br><span class="line">          r.autoStopProfiler = autoStopProfiler;</span><br><span class="line"></span><br><span class="line">          updatePendingConfiguration(curConfig);</span><br><span class="line"></span><br><span class="line">          sendMessage(H.LAUNCH_ACTIVITY, r);</span><br><span class="line">      &#125;</span><br></pre></td></tr></table></figure></p>
<p>这个函数首先创建了一个ActivityRecord实例，并且初始化了一些成员变量。然后给消息循环发送了一个LAUNCH_ACTIVITY的消息。<br>我们来看消息循环接受到这个消息后的动作:<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">handleMessage</span><span class="params">(Message msg)</span> </span>&#123;</span><br><span class="line">           <span class="keyword">if</span> (DEBUG_MESSAGES) Slog.v(TAG, <span class="string">"&gt;&gt;&gt; handling: "</span> + codeToString(msg.what));</span><br><span class="line">           <span class="keyword">switch</span> (msg.what) &#123;</span><br><span class="line">               <span class="keyword">case</span> LAUNCH_ACTIVITY: &#123;</span><br><span class="line">                   Trace.traceBegin(Trace.TRACE_TAG_ACTIVITY_MANAGER, <span class="string">"activityStart"</span>);</span><br><span class="line">                   ActivityClientRecord r = (ActivityClientRecord)msg.obj;</span><br><span class="line"></span><br><span class="line">                   r.packageInfo = getPackageInfoNoCheck(</span><br><span class="line">                           r.activityInfo.applicationInfo, r.compatInfo);</span><br><span class="line">                   handleLaunchActivity(r, <span class="keyword">null</span>);</span><br><span class="line">                   Trace.traceEnd(Trace.TRACE_TAG_ACTIVITY_MANAGER);</span><br><span class="line">               &#125; <span class="keyword">break</span>;</span><br></pre></td></tr></table></figure></p>
<p>在UI线程中执行handleLaunchActivity()方法。<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">handleLaunchActivity</span><span class="params">(ActivityClientRecord r, Intent customIntent)</span> </span>&#123;</span><br><span class="line">       <span class="comment">// If we are getting ready to gc after going to the background, well</span></span><br><span class="line">       <span class="comment">// we are back active so skip it.</span></span><br><span class="line">       unscheduleGcIdler();</span><br><span class="line"></span><br><span class="line">       <span class="keyword">if</span> (r.profileFd != <span class="keyword">null</span>) &#123;</span><br><span class="line">           mProfiler.setProfiler(r.profileFile, r.profileFd);</span><br><span class="line">           mProfiler.startProfiling();</span><br><span class="line">           mProfiler.autoStopProfiler = r.autoStopProfiler;</span><br><span class="line">       &#125;</span><br><span class="line"></span><br><span class="line">       <span class="comment">// Make sure we are running with the most recent config.</span></span><br><span class="line">       handleConfigurationChanged(<span class="keyword">null</span>, <span class="keyword">null</span>);</span><br><span class="line"></span><br><span class="line">       <span class="keyword">if</span> (localLOGV) Slog.v(</span><br><span class="line">           TAG, <span class="string">"Handling launch of "</span> + r);</span><br><span class="line">       Activity a = performLaunchActivity(r, customIntent);</span><br><span class="line"></span><br><span class="line">       <span class="keyword">if</span> (a != <span class="keyword">null</span>) &#123;</span><br><span class="line">           r.createdConfig = <span class="keyword">new</span> Configuration(mConfiguration);</span><br><span class="line">           Bundle oldState = r.state;</span><br><span class="line">           handleResumeActivity(r.token, <span class="keyword">false</span>, r.isForward,</span><br><span class="line">                   !r.activity.mFinished &amp;&amp; !r.startsNotResumed);</span><br><span class="line"></span><br><span class="line">           <span class="keyword">if</span> (!r.activity.mFinished &amp;&amp; r.startsNotResumed) &#123;</span><br><span class="line">           ...</span><br><span class="line">   &#125;</span><br></pre></td></tr></table></figure></p>
<p>这个函数调用performLaunchActivity()来创建一个Activity实例并调用它的OnCreate方法。完成后回到handleLaunchActivity函数，再调用handleResumeActivity函数来让这个Activity进入Resumed状态，这会调用Activity的OnResume函数。这里是遵循Activity的生命周期的。我们进入performLaunchActivity看是怎样创建的。<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> Activity <span class="title">performLaunchActivity</span><span class="params">(ActivityClientRecord r, Intent customIntent)</span> </span>&#123;</span><br><span class="line">       ...</span><br><span class="line"></span><br><span class="line">       Activity activity = <span class="keyword">null</span>;</span><br><span class="line">       <span class="keyword">try</span> &#123;</span><br><span class="line">           java.lang.ClassLoader cl = r.packageInfo.getClassLoader();</span><br><span class="line">           activity = mInstrumentation.newActivity(</span><br><span class="line">                   cl, component.getClassName(), r.intent);</span><br><span class="line">           StrictMode.incrementExpectedActivityCount(activity.getClass());</span><br><span class="line">           r.intent.setExtrasClassLoader(cl);</span><br><span class="line">           <span class="keyword">if</span> (r.state != <span class="keyword">null</span>) &#123;</span><br><span class="line">               r.state.setClassLoader(cl);</span><br><span class="line">           &#125;</span><br><span class="line">       &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">           <span class="keyword">if</span> (!mInstrumentation.onException(activity, e)) &#123;</span><br><span class="line">               <span class="keyword">throw</span> <span class="keyword">new</span> RuntimeException(</span><br><span class="line">                   <span class="string">"Unable to instantiate activity "</span> + component</span><br><span class="line">                   + <span class="string">": "</span> + e.toString(), e);</span><br><span class="line">           &#125;</span><br><span class="line">       &#125;</span><br><span class="line"></span><br><span class="line">       <span class="keyword">try</span> &#123;</span><br><span class="line">           Application app = r.packageInfo.makeApplication(<span class="keyword">false</span>, mInstrumentation);</span><br><span class="line"></span><br><span class="line">           <span class="keyword">if</span> (localLOGV) Slog.v(TAG, <span class="string">"Performing launch of "</span> + r);</span><br><span class="line">           <span class="keyword">if</span> (localLOGV) Slog.v(</span><br><span class="line">                   TAG, r + <span class="string">": app="</span> + app</span><br><span class="line">                   + <span class="string">", appName="</span> + app.getPackageName()</span><br><span class="line">                   + <span class="string">", pkg="</span> + r.packageInfo.getPackageName()</span><br><span class="line">                   + <span class="string">", comp="</span> + r.intent.getComponent().toShortString()</span><br><span class="line">                   + <span class="string">", dir="</span> + r.packageInfo.getAppDir());</span><br><span class="line"></span><br><span class="line">           <span class="keyword">if</span> (activity != <span class="keyword">null</span>) &#123;</span><br><span class="line">               Context appContext = createBaseContextForActivity(r, activity);</span><br><span class="line">               CharSequence title = r.activityInfo.loadLabel(appContext.getPackageManager());</span><br><span class="line">               Configuration config = <span class="keyword">new</span> Configuration(mCompatConfiguration);</span><br><span class="line">               <span class="keyword">if</span> (DEBUG_CONFIGURATION) Slog.v(TAG, <span class="string">"Launching activity "</span></span><br><span class="line">                       + r.activityInfo.name + <span class="string">" with config "</span> + config);</span><br><span class="line">               activity.attach(appContext, <span class="keyword">this</span>, getInstrumentation(), r.token,</span><br><span class="line">                       r.ident, app, r.intent, r.activityInfo, title, r.parent,</span><br><span class="line">                       r.embeddedID, r.lastNonConfigurationInstances, config);</span><br><span class="line"></span><br><span class="line">               <span class="keyword">if</span> (customIntent != <span class="keyword">null</span>) &#123;</span><br><span class="line">                   activity.mIntent = customIntent;</span><br><span class="line">               &#125;</span><br><span class="line">               r.lastNonConfigurationInstances = <span class="keyword">null</span>;</span><br><span class="line">               activity.mStartedActivity = <span class="keyword">false</span>;</span><br><span class="line">               <span class="keyword">int</span> theme = r.activityInfo.getThemeResource();</span><br><span class="line">               <span class="keyword">if</span> (theme != <span class="number">0</span>) &#123;</span><br><span class="line">                   activity.setTheme(theme);</span><br><span class="line">               &#125;</span><br><span class="line"></span><br><span class="line">               activity.mCalled = <span class="keyword">false</span>;</span><br><span class="line">               mInstrumentation.callActivityOnCreate(activity, r.state);</span><br><span class="line">               <span class="keyword">if</span> (!activity.mCalled) &#123;</span><br><span class="line">                   <span class="keyword">throw</span> <span class="keyword">new</span> SuperNotCalledException(</span><br><span class="line">                       <span class="string">"Activity "</span> + r.intent.getComponent().toShortString() +</span><br><span class="line">                       <span class="string">" did not call through to super.onCreate()"</span>);</span><br><span class="line">               &#125;</span><br><span class="line">              ...</span><br><span class="line"></span><br><span class="line">       <span class="keyword">return</span> activity;</span><br><span class="line">   &#125;</span><br></pre></td></tr></table></figure></p>
<p>performLaunchActivity首先得到要启动的Activity的相关信息，然后调用mInstrumentation.newActivity()来创建一个Activity实例，接着调用makeApplication创建程序的Application，createBaseContextForActivity方法用来创建Activity的上下文信息，并通过attach方法将这些上下文信息设置到Activity中。最后callActivityOnCreate方法就是调用我们Activity的OnCreate方法了。<br>到这里，一个Activity就启动起来了。</p>

  </section>

  

<section class="post-comments">
  <div id="disqus_thread"></div>
  <script type="text/javascript">
      var disqus_shortname = 'zke1ev3nme'; 
      /* * * DON'T EDIT BELOW THIS LINE * * */
      (function() {
          var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
          dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
          (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
      })();
  </script>
  <noscript>Please enable JavaScript to view the <a href="http://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
</section>


  
</article>


            <footer class="footer">

    <span class="footer__copyright">Copyright &copy; 2014-2015 Zke1ev3n. All Rights Reserved</span>
    
</footer>

        </div>
    </div>

    <!-- js files -->
    <script src="/js/jquery.min.js"></script>
    <script src="/js/main.js"></script>
    <script src="/js/scale.fix.js"></script>
    

    

    <script type="text/javascript" src="//cdn.mathjax.org/mathjax/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script>
    <script type="text/javascript"> 
        $(document).ready(function(){
            MathJax.Hub.Config({ 
                tex2jax: {inlineMath: [['[latex]','[/latex]'], ['\\(','\\)']]} 
            });
        });
    </script>


    

    <script src="/js/awesome-toc.min.js"></script>
    <script>
        $(document).ready(function(){
            $.awesome_toc({
                overlay: true,
                contentId: "post-content",
            });
        });
    </script>


    <script>
  (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
  (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
  m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
  })(window,document,'script','//www.google-analytics.com/analytics.js','ga');

  ga('create', 'UA-71084152-1', 'auto');
  ga('send', 'pageview');

</script>

    
    <!--kill ie6 -->
<!--[if IE 6]>
  <script src="//letskillie6.googlecode.com/svn/trunk/2/zh_CN.js"></script>
<![endif]-->

</body>
</html>
